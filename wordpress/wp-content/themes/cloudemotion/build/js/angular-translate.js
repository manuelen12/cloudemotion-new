/*!
 * angular-translate - v2.15.2 - 2017-06-22
 * 
 * Copyright (c) 2017 The angular-translate team, Pascal Precht; Licensed MIT
 */
/*!
 * angular-translate - v2.15.2 - 2017-06-22
 * 
 * Copyright (c) 2017 The angular-translate team, Pascal Precht; Licensed MIT
 */
/*!
 * angular-translate - v2.15.2 - 2017-06-22
 * 
 * Copyright (c) 2017 The angular-translate team, Pascal Precht; Licensed MIT
 */
!function(t,e){"function"==typeof define&&define.amd?define([],function(){return e()}):"object"==typeof module&&module.exports?module.exports=e():e()}(0,function(){function t(t){"use strict";var e=t.storageKey(),n=t.storage(),r=function(){var r=t.preferredLanguage();angular.isString(r)?t.use(r):n.put(e,t.use())};r.displayName="fallbackFromIncorrectStorageValue",n?n.get(e)?t.use(n.get(e)).catch(r):r():angular.isString(t.preferredLanguage())&&t.use(t.preferredLanguage())}function e(){"use strict";var t,e,n,r=null,a=!1,i=!1;n={sanitize:function(t,e){return"text"===e&&(t=o(t)),t},escape:function(t,e){return"text"===e&&(t=s(t)),t},sanitizeParameters:function(t,e){return"params"===e&&(t=u(t,o)),t},escapeParameters:function(t,e){return"params"===e&&(t=u(t,s)),t},sce:function(t,e,n){return"text"===e?t=l(t):"params"===e&&"filter"!==n&&(t=u(t,s)),t},sceParameters:function(t,e){return"params"===e&&(t=u(t,l)),t}},n.escaped=n.escapeParameters,this.addStrategy=function(t,e){return n[t]=e,this},this.removeStrategy=function(t){return delete n[t],this},this.useStrategy=function(t){return a=!0,r=t,this},this.$get=["$injector","$log",function(s,o){var l={},u=function(t,e,r,a){return angular.forEach(a,function(a){if(angular.isFunction(a))t=a(t,e,r);else if(angular.isFunction(n[a]))t=n[a](t,e,r);else{if(!angular.isString(n[a]))throw new Error("pascalprecht.translate.$translateSanitization: Unknown sanitization strategy: '"+a+"'");if(!l[n[a]])try{l[n[a]]=s.get(n[a])}catch(t){throw l[n[a]]=function(){},new Error("pascalprecht.translate.$translateSanitization: Unknown sanitization strategy: '"+a+"'")}t=l[n[a]](t,e,r)}}),t},c=function(){a||i||(o.warn("pascalprecht.translate.$translateSanitization: No sanitization strategy has been configured. This can have serious security implications. See http://angular-translate.github.io/docs/#/guide/19_security for details."),i=!0)};return s.has("$sanitize")&&(t=s.get("$sanitize")),s.has("$sce")&&(e=s.get("$sce")),{useStrategy:function(t){return function(e){t.useStrategy(e)}}(this),sanitize:function(t,e,n,a){if(r||c(),n||null===n||(n=r),!n)return t;a||(a="service");var i=angular.isArray(n)?n:[n];return u(t,e,a,i)}}}];var s=function(t){var e=angular.element("<div></div>");return e.text(t),e.html()},o=function(e){if(!t)throw new Error("pascalprecht.translate.$translateSanitization: Error cannot find $sanitize service. Either include the ngSanitize module (https://docs.angularjs.org/api/ngSanitize) or use a sanitization strategy which does not depend on $sanitize, such as 'escape'.");return t(e)},l=function(t){if(!e)throw new Error("pascalprecht.translate.$translateSanitization: Error cannot find $sce service.");return e.trustAsHtml(t)},u=function(t,e,n){if(angular.isDate(t))return t;if(angular.isObject(t)){var r=angular.isArray(t)?[]:{};if(n){if(n.indexOf(t)>-1)throw new Error("pascalprecht.translate.$translateSanitization: Error cannot interpolate parameter due recursive object")}else n=[];return n.push(t),angular.forEach(t,function(t,a){angular.isFunction(t)||(r[a]=u(t,e,n))}),n.splice(-1,1),r}return angular.isNumber(t)?t:!0===t||!1===t?t:angular.isUndefined(t)||null===t?t:e(t)}}function n(t,e,n,r){"use strict";var a,i,s,o,l,u,c,f,g,p,h,d,v,m,$,y,b={},L=[],S=t,j=[],w="translate-cloak",N=!1,x=!1,C=".",E=!1,O=!1,k=0,P=!0,A="default",T={default:function(t){return(t||"").split("-").join("_")},java:function(t){var e=(t||"").split("-").join("_"),n=e.split("_");return n.length>1?n[0].toLowerCase()+"_"+n[1].toUpperCase():e},bcp47:function(t){var e=(t||"").split("_").join("-"),n=e.split("-");return n.length>1?n[0].toLowerCase()+"-"+n[1].toUpperCase():e},"iso639-1":function(t){return(t||"").split("_").join("-").split("-")[0].toLowerCase()}},F=function(){if(angular.isFunction(r.getLocale))return r.getLocale();var t,n,a=e.$get().navigator,i=["language","browserLanguage","systemLanguage","userLanguage"];if(angular.isArray(a.languages))for(t=0;t<a.languages.length;t++)if((n=a.languages[t])&&n.length)return n;for(t=0;t<i.length;t++)if((n=a[i[t]])&&n.length)return n;return null};F.displayName="angular-translate/service: getFirstBrowserLanguage";var z=function(){var t=F()||"";return T[A]&&(t=T[A](t)),t};z.displayName="angular-translate/service: getLocale";var I=function(t,e){for(var n=0,r=t.length;n<r;n++)if(t[n]===e)return n;return-1},_=function(){return this.toString().replace(/^\s+|\s+$/g,"")},V=function(t){if(t){for(var e=[],n=angular.lowercase(t),r=0,a=L.length;r<a;r++)e.push(angular.lowercase(L[r]));if(I(e,n)>-1)return t;if(i){var s;for(var o in i)if(i.hasOwnProperty(o)){var l=!1,u=Object.prototype.hasOwnProperty.call(i,o)&&angular.lowercase(o)===angular.lowercase(t);if("*"===o.slice(-1)&&(l=o.slice(0,-1)===t.slice(0,o.length-1)),(u||l)&&(s=i[o],I(e,angular.lowercase(s))>-1))return s}}var c=t.split("_");return c.length>1&&I(e,angular.lowercase(c[0]))>-1?c[0]:void 0}},R=function(t,e){if(!t&&!e)return b;if(t&&!e){if(angular.isString(t))return b[t]}else angular.isObject(b[t])||(b[t]={}),angular.extend(b[t],D(e));return this};this.translations=R,this.cloakClassName=function(t){return t?(w=t,this):w},this.nestedObjectDelimeter=function(t){return t?(C=t,this):C};var D=function(t,e,n,r){var a,i,s,o;e||(e=[]),n||(n={});for(a in t)Object.prototype.hasOwnProperty.call(t,a)&&(o=t[a],angular.isObject(o)?D(o,e.concat(a),n,a):(i=e.length?""+e.join(C)+C+a:a,e.length&&a===r&&(s=""+e.join(C),n[s]="@:"+i),n[i]=o));return n};D.displayName="flatObject",this.addInterpolation=function(t){return j.push(t),this},this.useMessageFormatInterpolation=function(){return this.useInterpolation("$translateMessageFormatInterpolation")},this.useInterpolation=function(t){return p=t,this},this.useSanitizeValueStrategy=function(t){return n.useStrategy(t),this},this.preferredLanguage=function(t){return t?(K(t),this):a};var K=function(t){return t&&(a=t),a};this.translationNotFoundIndicator=function(t){return this.translationNotFoundIndicatorLeft(t),this.translationNotFoundIndicatorRight(t),this},this.translationNotFoundIndicatorLeft=function(t){return t?(v=t,this):v},this.translationNotFoundIndicatorRight=function(t){return t?(m=t,this):m},this.fallbackLanguage=function(t){return M(t),this};var M=function(t){return t?(angular.isString(t)?(o=!0,s=[t]):angular.isArray(t)&&(o=!1,s=t),angular.isString(a)&&I(s,a)<0&&s.push(a),this):o?s[0]:s};this.use=function(t){if(t){if(!b[t]&&!h)throw new Error("$translateProvider couldn't find translationTable for langKey: '"+t+"'");return l=t,this}return l},this.resolveClientLocale=function(){return z()};var H=function(t){return t?(S=t,this):f?f+S:S};this.storageKey=H,this.useUrlLoader=function(t,e){return this.useLoader("$translateUrlLoader",angular.extend({url:t},e))},this.useStaticFilesLoader=function(t){return this.useLoader("$translateStaticFilesLoader",t)},this.useLoader=function(t,e){return h=t,d=e||{},this},this.useLocalStorage=function(){return this.useStorage("$translateLocalStorage")},this.useCookieStorage=function(){return this.useStorage("$translateCookieStorage")},this.useStorage=function(t){return c=t,this},this.storagePrefix=function(t){return t?(f=t,this):t},this.useMissingTranslationHandlerLog=function(){return this.useMissingTranslationHandler("$translateMissingTranslationHandlerLog")},this.useMissingTranslationHandler=function(t){return g=t,this},this.usePostCompiling=function(t){return N=!!t,this},this.forceAsyncReload=function(t){return x=!!t,this},this.uniformLanguageTag=function(t){return t?angular.isString(t)&&(t={standard:t}):t={},A=t.standard,this},this.determinePreferredLanguage=function(t){var e=t&&angular.isFunction(t)?t():z();return a=L.length?V(e)||e:e,this},this.registerAvailableLanguageKeys=function(t,e){return t?(L=t,e&&(i=e),this):L},this.useLoaderCache=function(t){return!1===t?$=void 0:!0===t?$=!0:void 0===t?$="$translationCache":t&&($=t),this},this.directivePriority=function(t){return void 0===t?k:(k=t,this)},this.statefulFilter=function(t){return void 0===t?P:(P=t,this)},this.postProcess=function(t){return y=t||void 0,this},this.keepContent=function(t){return O=!!t,this},this.$get=["$log","$injector","$rootScope","$q",function(t,e,n,r){var i,f,A,T=e.get(p||"$translateDefaultInterpolation"),F=!1,U={},G={},q=function(t,e,n,o,u){!l&&a&&(l=a);var g=u&&u!==l?V(u)||u:l;if(u&&ut(u),angular.isArray(t)){return function(t){for(var a={},i=[],s=0,l=t.length;s<l;s++)i.push(function(t){var i=r.defer(),s=function(e){a[t]=e,i.resolve([t,e])};return q(t,e,n,o,u).then(s,s),i.promise}(t[s]));return r.all(i).then(function(){return a})}(t)}var p=r.defer();t&&(t=_.apply(t));var h=function(){var t=a?G[a]:G[g];if(f=0,c&&!t){var e=i.get(S);if(t=G[e],s&&s.length){var n=I(s,e);f=0===n?1:0,I(s,a)<0&&s.push(a)}}return t}();if(h){var d=function(){u||(g=l),it(t,e,n,o,g).then(p.resolve,p.reject)};d.displayName="promiseResolved",h.finally(d).catch(angular.noop)}else it(t,e,n,o,g).then(p.resolve,p.reject);return p.promise},Y=function(t){return v&&(t=[v,t].join(" ")),m&&(t=[t,m].join(" ")),t},B=function(t){l=t,c&&i.put(q.storageKey(),l),n.$emit("$translateChangeSuccess",{language:t}),T.setLocale(l);var e=function(t,e){U[e].setLocale(l)};e.displayName="eachInterpolatorLocaleSetter",angular.forEach(U,e),n.$emit("$translateChangeEnd",{language:t})},J=function(t){if(!t)throw"No language key specified for loading.";var a=r.defer();n.$emit("$translateLoadingStart",{language:t}),F=!0;var i=$;"string"==typeof i&&(i=e.get(i));var s=angular.extend({},d,{key:t,$http:angular.extend({},{cache:i},d.$http)}),o=function(e){var r={};n.$emit("$translateLoadingSuccess",{language:t}),angular.isArray(e)?angular.forEach(e,function(t){angular.extend(r,D(t))}):angular.extend(r,D(e)),F=!1,a.resolve({key:t,table:r}),n.$emit("$translateLoadingEnd",{language:t})};o.displayName="onLoaderSuccess";var l=function(t){n.$emit("$translateLoadingError",{language:t}),a.reject(t),n.$emit("$translateLoadingEnd",{language:t})};return l.displayName="onLoaderError",e.get(h)(s).then(o,l),a.promise};if(c&&(i=e.get(c),!i.get||!i.put))throw new Error("Couldn't use storage '"+c+"', missing get() or put() method!");if(j.length){var Q=function(t){var n=e.get(t);n.setLocale(a||l),U[n.getInterpolationIdentifier()]=n};Q.displayName="interpolationFactoryAdder",angular.forEach(j,Q)}var W=function(t){var e=r.defer();if(Object.prototype.hasOwnProperty.call(b,t))e.resolve(b[t]);else if(G[t]){var n=function(t){R(t.key,t.table),e.resolve(t.table)};n.displayName="translationTableResolver",G[t].then(n,e.reject)}else e.reject();return e.promise},X=function(t,e,n,a,i){var s=r.defer(),o=function(r){if(Object.prototype.hasOwnProperty.call(r,e)&&null!==r[e]){a.setLocale(t);var o=r[e];if("@:"===o.substr(0,2))X(t,o.substr(2),n,a,i).then(s.resolve,s.reject);else{var u=a.interpolate(r[e],n,"service",i,e);u=lt(e,r[e],u,n,t),s.resolve(u)}a.setLocale(l)}else s.reject()};return o.displayName="fallbackTranslationResolver",W(t).then(o,s.reject),s.promise},Z=function(t,e,n,r,a){var i,s=b[t];if(s&&Object.prototype.hasOwnProperty.call(s,e)&&null!==s[e]){if(r.setLocale(t),i=r.interpolate(s[e],n,"filter",a,e),i=lt(e,s[e],i,n,t,a),!angular.isString(i)&&angular.isFunction(i.$$unwrapTrustedValue)){var o=i.$$unwrapTrustedValue();if("@:"===o.substr(0,2))return Z(t,o.substr(2),n,r,a)}else if("@:"===i.substr(0,2))return Z(t,i.substr(2),n,r,a);r.setLocale(l)}return i},tt=function(t,n,r,a){return g?e.get(g)(t,l,n,r,a):t},et=function(t,e,n,a,i,o){var l=r.defer();if(t<s.length){var u=s[t];X(u,e,n,a,o).then(function(t){l.resolve(t)},function(){return et(t+1,e,n,a,i,o).then(l.resolve,l.reject)})}else if(i)l.resolve(i);else{var c=tt(e,n,i);g&&c?l.resolve(c):l.reject(Y(e))}return l.promise},nt=function(t,e,n,r,a){var i;if(t<s.length){var o=s[t];i=Z(o,e,n,r,a),i||""===i||(i=nt(t+1,e,n,r))}return i},rt=function(t,e,n,r,a){return et(A>0?A:f,t,e,n,r,a)},at=function(t,e,n,r){return nt(A>0?A:f,t,e,n,r)},it=function(t,e,n,a,i,o){var l=r.defer(),u=i?b[i]:b,c=n?U[n]:T;if(u&&Object.prototype.hasOwnProperty.call(u,t)&&null!==u[t]){var f=u[t];if("@:"===f.substr(0,2))q(f.substr(2),e,n,a,i).then(l.resolve,l.reject);else{var p=c.interpolate(f,e,"service",o,t);p=lt(t,f,p,e,i),l.resolve(p)}}else{var h;g&&!F&&(h=tt(t,e,a)),i&&s&&s.length?rt(t,e,c,a,o).then(function(t){l.resolve(t)},function(t){l.reject(Y(t))}):g&&!F&&h?a?l.resolve(a):l.resolve(h):a?l.resolve(a):l.reject(Y(t))}return l.promise},st=function(t,e,n,r,a){var i,o=r?b[r]:b,l=T;if(U&&Object.prototype.hasOwnProperty.call(U,n)&&(l=U[n]),o&&Object.prototype.hasOwnProperty.call(o,t)&&null!==o[t]){var u=o[t];"@:"===u.substr(0,2)?i=st(u.substr(2),e,n,r,a):(i=l.interpolate(u,e,"filter",a,t),i=lt(t,u,i,e,r,a))}else{var c;g&&!F&&(c=tt(t,e,a)),r&&s&&s.length?(f=0,i=at(t,e,l,a)):i=g&&!F&&c?c:Y(t)}return i},ot=function(t){u===t&&(u=void 0),G[t]=void 0},lt=function(t,n,r,a,i,s){var o=y;return o&&("string"==typeof o&&(o=e.get(o)),o)?o(t,n,r,a,i,s):r},ut=function(t){b[t]||!h||G[t]||(G[t]=J(t).then(function(t){return R(t.key,t.table),t}))};q.preferredLanguage=function(t){return t&&K(t),a},q.cloakClassName=function(){return w},q.nestedObjectDelimeter=function(){return C},q.fallbackLanguage=function(t){if(void 0!==t&&null!==t){if(M(t),h&&s&&s.length)for(var e=0,n=s.length;e<n;e++)G[s[e]]||(G[s[e]]=J(s[e]));q.use(q.use())}return o?s[0]:s},q.useFallbackLanguage=function(t){if(void 0!==t&&null!==t)if(t){var e=I(s,t);e>-1&&(A=e)}else A=0},q.proposedLanguage=function(){return u},q.storage=function(){return i},q.negotiateLocale=V,q.use=function(t){if(!t)return l;var e=r.defer();e.promise.then(null,angular.noop),n.$emit("$translateChangeStart",{language:t});var a=V(t);return L.length>0&&!a?r.reject(t):(a&&(t=a),u=t,!x&&b[t]||!h||G[t]?G[t]?G[t].then(function(t){return u===t.key&&B(t.key),e.resolve(t.key),t},function(t){return!l&&s&&s.length>0&&s[0]!==t?q.use(s[0]).then(e.resolve,e.reject):e.reject(t)}):(e.resolve(t),B(t)):(G[t]=J(t).then(function(n){return R(n.key,n.table),e.resolve(n.key),u===t&&B(n.key),n},function(t){return n.$emit("$translateChangeError",{language:t}),e.reject(t),n.$emit("$translateChangeEnd",{language:t}),r.reject(t)}),G[t].finally(function(){ot(t)}).catch(angular.noop)),e.promise)},q.resolveClientLocale=function(){return z()},q.storageKey=function(){return H()},q.isPostCompilingEnabled=function(){return N},q.isForceAsyncReloadEnabled=function(){return x},q.isKeepContent=function(){return O},q.refresh=function(t){function e(t){var e=J(t);return G[t]=e,e.then(function(e){b[t]={},R(t,e.table),i[t]=!0},angular.noop),e}if(!h)throw new Error("Couldn't refresh translation table, no loader registered!");n.$emit("$translateRefreshStart",{language:t});var a=r.defer(),i={};if(a.promise.then(function(){for(var t in b)b.hasOwnProperty(t)&&(t in i||delete b[t]);l&&B(l)},angular.noop).finally(function(){n.$emit("$translateRefreshEnd",{language:t})}),t)b[t]?e(t).then(a.resolve,a.reject):a.reject();else{var o=s&&s.slice()||[];l&&-1===o.indexOf(l)&&o.push(l),r.all(o.map(e)).then(a.resolve,a.reject)}return a.promise},q.instant=function(t,e,n,r,i){var o=r&&r!==l?V(r)||r:l;if(null===t||angular.isUndefined(t))return t;if(r&&ut(r),angular.isArray(t)){for(var u={},c=0,f=t.length;c<f;c++)u[t[c]]=q.instant(t[c],e,n,r,i);return u}if(angular.isString(t)&&t.length<1)return t;t&&(t=_.apply(t));var p,h=[];a&&h.push(a),o&&h.push(o),s&&s.length&&(h=h.concat(s));for(var d=0,$=h.length;d<$;d++){var y=h[d];if(b[y]&&void 0!==b[y][t]&&(p=st(t,e,n,o,i)),void 0!==p)break}if(!p&&""!==p)if(v||m)p=Y(t);else{p=T.interpolate(t,e,"filter",i);var L;g&&!F&&(L=tt(t,e,i)),g&&!F&&L&&(p=L)}return p},q.versionInfo=function(){return"2.15.2"},q.loaderCache=function(){return $},q.directivePriority=function(){return k},q.statefulFilter=function(){return P},q.isReady=function(){return E};var ct=r.defer();ct.promise.then(function(){E=!0}),q.onReady=function(t){var e=r.defer();return angular.isFunction(t)&&e.promise.then(t),E?e.resolve():ct.promise.then(e.resolve),e.promise},q.getAvailableLanguageKeys=function(){return L.length>0?L:null},q.getTranslationTable=function(t){return t=t||q.use(),t&&b[t]?angular.copy(b[t]):null};var ft=n.$on("$translateReady",function(){ct.resolve(),ft(),ft=null}),gt=n.$on("$translateChangeEnd",function(){ct.resolve(),gt(),gt=null});if(h){if(angular.equals(b,{})&&q.use()&&q.use(q.use()),s&&s.length)for(var pt=function(t){return R(t.key,t.table),n.$emit("$translateChangeEnd",{language:t.key}),t},ht=0,dt=s.length;ht<dt;ht++){var vt=s[ht];!x&&b[vt]||(G[vt]=J(vt).then(pt))}}else n.$emit("$translateReady",{language:q.use()});return q}]}function r(t,e){"use strict";var n,r={};return r.setLocale=function(t){n=t},r.getInterpolationIdentifier=function(){return"default"},r.useSanitizeValueStrategy=function(t){return e.useStrategy(t),this},r.interpolate=function(n,r,a,i,s){r=r||{},r=e.sanitize(r,"params",i,a);var o;return angular.isNumber(n)?o=""+n:angular.isString(n)?(o=t(n)(r),o=e.sanitize(o,"text",i,a)):o="",o},r}function a(t,e,n,r,a){"use strict";var s=function(){return this.toString().replace(/^\s+|\s+$/g,"")};return{restrict:"AE",scope:!0,priority:t.directivePriority(),compile:function(o,l){var u=l.translateValues?l.translateValues:void 0,c=l.translateInterpolation?l.translateInterpolation:void 0,f=o[0].outerHTML.match(/translate-value-+/i),g="^(.*)("+e.startSymbol()+".*"+e.endSymbol()+")(.*)",p="^(.*)"+e.startSymbol()+"(.*)"+e.endSymbol()+"(.*)";return function(o,h,d){o.interpolateParams={},o.preText="",o.postText="",o.translateNamespace=i(o);var v={},m=function(t){if(angular.isFunction(m._unwatchOld)&&(m._unwatchOld(),m._unwatchOld=void 0),angular.equals(t,"")||!angular.isDefined(t)){var n=s.apply(h.text()),r=n.match(g);if(angular.isArray(r)){o.preText=r[1],o.postText=r[3],v.translate=e(r[2])(o.$parent);var a=n.match(p);angular.isArray(a)&&a[2]&&a[2].length&&(m._unwatchOld=o.$watch(a[2],function(t){v.translate=t,L()}))}else v.translate=n||void 0}else v.translate=t;L()};!function(t,e,n){if(e.translateValues&&angular.extend(t,r(e.translateValues)(o.$parent)),f)for(var a in n)if(Object.prototype.hasOwnProperty.call(e,a)&&"translateValue"===a.substr(0,14)&&"translateValues"!==a){var i=angular.lowercase(a.substr(14,1))+a.substr(15);t[i]=n[a]}}(o.interpolateParams,d,l);var $=!0;d.$observe("translate",function(t){void 0===t?m(""):""===t&&$||(v.translate=t,L()),$=!1});for(var y in d)d.hasOwnProperty(y)&&"translateAttr"===y.substr(0,13)&&y.length>13&&function(t){d.$observe(t,function(e){v[t]=e,L()})}(y);if(d.$observe("translateDefault",function(t){o.defaultText=t,L()}),u&&d.$observe("translateValues",function(t){t&&o.$parent.$watch(function(){angular.extend(o.interpolateParams,r(t)(o.$parent))})}),f){for(var b in d)Object.prototype.hasOwnProperty.call(d,b)&&"translateValue"===b.substr(0,14)&&"translateValues"!==b&&function(t){d.$observe(t,function(e){var n=angular.lowercase(t.substr(14,1))+t.substr(15);o.interpolateParams[n]=e})}(b)}var L=function(){for(var t in v)v.hasOwnProperty(t)&&void 0!==v[t]&&S(t,v[t],o,o.interpolateParams,o.defaultText,o.translateNamespace)},S=function(e,n,r,a,i,s){n?(s&&"."===n.charAt(0)&&(n=s+n),t(n,a,c,i,r.translateLanguage).then(function(t){j(t,r,!0,e)},function(t){j(t,r,!1,e)})):j(n,r,!1,e)},j=function(e,r,a,i){if(a||void 0!==r.defaultText&&(e=r.defaultText),"translate"===i){(a||!a&&!t.isKeepContent()&&void 0===d.translateKeepContent)&&h.empty().append(r.preText+e+r.postText);var s=t.isPostCompilingEnabled(),o=void 0!==l.translateCompile,u=o&&"false"!==l.translateCompile;(s&&!o||u)&&n(h.contents())(r)}else{var c=d.$attr[i];"data-"===c.substr(0,5)&&(c=c.substr(5)),c=c.substr(15),h.attr(c,e)}};(u||f||d.translateDefault)&&o.$watch("interpolateParams",L,!0),o.$on("translateLanguageChanged",L);var w=a.$on("$translateChangeSuccess",L);h.text().length?m(d.translate?d.translate:""):d.translate&&m(d.translate),L(),o.$on("$destroy",w)}}}}function i(t){"use strict";return t.translateNamespace?t.translateNamespace:t.$parent?i(t.$parent):void 0}function s(t,e){"use strict";return{restrict:"A",priority:t.directivePriority(),link:function(n,r,a){var i,s,l={},u=function(){angular.forEach(i,function(e,i){e&&(l[i]=!0,n.translateNamespace&&"."===e.charAt(0)&&(e=n.translateNamespace+e),t(e,s,a.translateInterpolation,void 0,n.translateLanguage).then(function(t){r.attr(i,t)},function(t){r.attr(i,t)}))}),angular.forEach(l,function(t,e){i[e]||(r.removeAttr(e),delete l[e])})};o(n,a.translateAttr,function(t){i=t},u),o(n,a.translateValues,function(t){s=t},u),a.translateValues&&n.$watch(a.translateValues,u,!0),n.$on("translateLanguageChanged",u);var c=e.$on("$translateChangeSuccess",u);u(),n.$on("$destroy",c)}}}function o(t,e,n,r){"use strict";e&&("::"===e.substr(0,2)?e=e.substr(2):t.$watch(e,function(t){n(t),r()},!0),n(t.$eval(e)))}function l(t,e){"use strict";return{compile:function(n){var r=function(e){e.addClass(t.cloakClassName())},a=function(e){e.removeClass(t.cloakClassName())};return r(n),function(n,i,s){var o=a.bind(this,i),l=r.bind(this,i);s.translateCloak&&s.translateCloak.length?(s.$observe("translateCloak",function(e){t(e).then(o,l)}),e.$on("$translateChangeSuccess",function(){t(s.translateCloak).then(o,l)})):t.onReady(o)}}}}function u(){"use strict";return{restrict:"A",scope:!0,compile:function(){return{pre:function(t,e,n){t.translateNamespace=i(t),t.translateNamespace&&"."===n.translateNamespace.charAt(0)?t.translateNamespace+=n.translateNamespace:t.translateNamespace=n.translateNamespace}}}}}function i(t){"use strict";return t.translateNamespace?t.translateNamespace:t.$parent?i(t.$parent):void 0}function c(){"use strict";return{restrict:"A",scope:!0,compile:function(){return function(t,e,n){n.$observe("translateLanguage",function(e){t.translateLanguage=e}),t.$watch("translateLanguage",function(){t.$broadcast("translateLanguageChanged")})}}}}function f(t,e){"use strict";var n=function(n,r,a,i){if(!angular.isObject(r)){var s=this||{__SCOPE_IS_NOT_AVAILABLE:"More info at https://github.com/angular/angular.js/commit/8863b9d04c722b278fa93c5d66ad1e578ad6eb1f"};r=t(r)(s)}return e.instant(n,r,a,i)};return e.statefulFilter()&&(n.$stateful=!0),n}function g(t){"use strict";return t("translations")}return t.$inject=["$translate"],n.$inject=["$STORAGE_KEY","$windowProvider","$translateSanitizationProvider","pascalprechtTranslateOverrider"],r.$inject=["$interpolate","$translateSanitization"],a.$inject=["$translate","$interpolate","$compile","$parse","$rootScope"],s.$inject=["$translate","$rootScope"],l.$inject=["$translate","$rootScope"],f.$inject=["$parse","$translate"],g.$inject=["$cacheFactory"],angular.module("pascalprecht.translate",["ng"]).run(t),t.displayName="runTranslate",angular.module("pascalprecht.translate").provider("$translateSanitization",e),angular.module("pascalprecht.translate").constant("pascalprechtTranslateOverrider",{}).provider("$translate",n),n.displayName="displayName",angular.module("pascalprecht.translate").factory("$translateDefaultInterpolation",r),r.displayName="$translateDefaultInterpolation",angular.module("pascalprecht.translate").constant("$STORAGE_KEY","NG_TRANSLATE_LANG_KEY"),angular.module("pascalprecht.translate").directive("translate",a),a.displayName="translateDirective",angular.module("pascalprecht.translate").directive("translateAttr",s),s.displayName="translateAttrDirective",angular.module("pascalprecht.translate").directive("translateCloak",l),l.displayName="translateCloakDirective",angular.module("pascalprecht.translate").directive("translateNamespace",u),u.displayName="translateNamespaceDirective",angular.module("pascalprecht.translate").directive("translateLanguage",c),c.displayName="translateLanguageDirective",angular.module("pascalprecht.translate").filter("translate",f),f.displayName="translateFilterFactory",angular.module("pascalprecht.translate").factory("$translationCache",g),g.displayName="$translationCache","pascalprecht.translate"}),function(t,e){"function"==typeof define&&define.amd?define([],function(){return e()}):"object"==typeof module&&module.exports?module.exports=e():e()}(0,function(){function t(t,e){"use strict";return function(n){if(!n||!(angular.isArray(n.files)||angular.isString(n.prefix)&&angular.isString(n.suffix)))throw new Error("Couldn't load static files, no files and prefix or suffix specified!");n.files||(n.files=[{prefix:n.prefix,suffix:n.suffix}]);for(var r=[],a=n.files.length,i=0;i<a;i++)r.push(function(r){if(!r||!angular.isString(r.prefix)||!angular.isString(r.suffix))throw new Error("Couldn't load static file, no prefix or suffix specified!");var a=[r.prefix,n.key,r.suffix].join("");return angular.isObject(n.fileMap)&&n.fileMap[a]&&(a=n.fileMap[a]),e(angular.extend({url:a,method:"GET"},n.$http)).then(function(t){return t.data},function(){return t.reject(n.key)})}({prefix:n.files[i].prefix,key:n.key,suffix:n.files[i].suffix}));return t.all(r).then(function(t){for(var e=t.length,n={},r=0;r<e;r++)for(var a in t[r])n[a]=t[r][a];return n})}}return t.$inject=["$q","$http"],angular.module("pascalprecht.translate").factory("$translateStaticFilesLoader",t),t.displayName="$translateStaticFilesLoader","pascalprecht.translate"}),function(t,e){"function"==typeof define&&define.amd?define([],function(){return e()}):"object"==typeof module&&module.exports?module.exports=e():e()}(0,function(){function t(t){"use strict";return function(e){t.warn("Translation for "+e+" doesn't exist")}}return t.$inject=["$log"],angular.module("pascalprecht.translate").factory("$translateMissingTranslationHandlerLog",t),t.displayName="$translateMissingTranslationHandlerLog","pascalprecht.translate"});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiIiwic291cmNlcyI6WyJhbmd1bGFyLXRyYW5zbGF0ZS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIGFuZ3VsYXItdHJhbnNsYXRlIC0gdjIuMTUuMiAtIDIwMTctMDYtMjJcbiAqIFxuICogQ29weXJpZ2h0IChjKSAyMDE3IFRoZSBhbmd1bGFyLXRyYW5zbGF0ZSB0ZWFtLCBQYXNjYWwgUHJlY2h0OyBMaWNlbnNlZCBNSVRcbiAqL1xuKGZ1bmN0aW9uIChyb290LCBmYWN0b3J5KSB7XG4gIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHtcbiAgICAvLyBBTUQuIFJlZ2lzdGVyIGFzIGFuIGFub255bW91cyBtb2R1bGUgdW5sZXNzIGFtZE1vZHVsZUlkIGlzIHNldFxuICAgIGRlZmluZShbXSwgZnVuY3Rpb24gKCkge1xuICAgICAgcmV0dXJuIChmYWN0b3J5KCkpO1xuICAgIH0pO1xuICB9IGVsc2UgaWYgKHR5cGVvZiBtb2R1bGUgPT09ICdvYmplY3QnICYmIG1vZHVsZS5leHBvcnRzKSB7XG4gICAgLy8gTm9kZS4gRG9lcyBub3Qgd29yayB3aXRoIHN0cmljdCBDb21tb25KUywgYnV0XG4gICAgLy8gb25seSBDb21tb25KUy1saWtlIGVudmlyb25tZW50cyB0aGF0IHN1cHBvcnQgbW9kdWxlLmV4cG9ydHMsXG4gICAgLy8gbGlrZSBOb2RlLlxuICAgIG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeSgpO1xuICB9IGVsc2Uge1xuICAgIGZhY3RvcnkoKTtcbiAgfVxufSh0aGlzLCBmdW5jdGlvbiAoKSB7XG5cbi8qKlxuICogQG5nZG9jIG92ZXJ2aWV3XG4gKiBAbmFtZSBwYXNjYWxwcmVjaHQudHJhbnNsYXRlXG4gKlxuICogQGRlc2NyaXB0aW9uXG4gKiBUaGUgbWFpbiBtb2R1bGUgd2hpY2ggaG9sZHMgZXZlcnl0aGluZyB0b2dldGhlci5cbiAqL1xucnVuVHJhbnNsYXRlLiRpbmplY3QgPSBbJyR0cmFuc2xhdGUnXTtcbiR0cmFuc2xhdGUuJGluamVjdCA9IFsnJFNUT1JBR0VfS0VZJywgJyR3aW5kb3dQcm92aWRlcicsICckdHJhbnNsYXRlU2FuaXRpemF0aW9uUHJvdmlkZXInLCAncGFzY2FscHJlY2h0VHJhbnNsYXRlT3ZlcnJpZGVyJ107XG4kdHJhbnNsYXRlRGVmYXVsdEludGVycG9sYXRpb24uJGluamVjdCA9IFsnJGludGVycG9sYXRlJywgJyR0cmFuc2xhdGVTYW5pdGl6YXRpb24nXTtcbnRyYW5zbGF0ZURpcmVjdGl2ZS4kaW5qZWN0ID0gWyckdHJhbnNsYXRlJywgJyRpbnRlcnBvbGF0ZScsICckY29tcGlsZScsICckcGFyc2UnLCAnJHJvb3RTY29wZSddO1xudHJhbnNsYXRlQXR0ckRpcmVjdGl2ZS4kaW5qZWN0ID0gWyckdHJhbnNsYXRlJywgJyRyb290U2NvcGUnXTtcbnRyYW5zbGF0ZUNsb2FrRGlyZWN0aXZlLiRpbmplY3QgPSBbJyR0cmFuc2xhdGUnLCAnJHJvb3RTY29wZSddO1xudHJhbnNsYXRlRmlsdGVyRmFjdG9yeS4kaW5qZWN0ID0gWyckcGFyc2UnLCAnJHRyYW5zbGF0ZSddO1xuJHRyYW5zbGF0aW9uQ2FjaGUuJGluamVjdCA9IFsnJGNhY2hlRmFjdG9yeSddO1xuYW5ndWxhci5tb2R1bGUoJ3Bhc2NhbHByZWNodC50cmFuc2xhdGUnLCBbJ25nJ10pXG4gIC5ydW4ocnVuVHJhbnNsYXRlKTtcblxuZnVuY3Rpb24gcnVuVHJhbnNsYXRlKCR0cmFuc2xhdGUpIHtcblxuICAndXNlIHN0cmljdCc7XG5cbiAgdmFyIGtleSA9ICR0cmFuc2xhdGUuc3RvcmFnZUtleSgpLFxuICAgIHN0b3JhZ2UgPSAkdHJhbnNsYXRlLnN0b3JhZ2UoKTtcblxuICB2YXIgZmFsbGJhY2tGcm9tSW5jb3JyZWN0U3RvcmFnZVZhbHVlID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciBwcmVmZXJyZWQgPSAkdHJhbnNsYXRlLnByZWZlcnJlZExhbmd1YWdlKCk7XG4gICAgaWYgKGFuZ3VsYXIuaXNTdHJpbmcocHJlZmVycmVkKSkge1xuICAgICAgJHRyYW5zbGF0ZS51c2UocHJlZmVycmVkKTtcbiAgICAgIC8vICR0cmFuc2xhdGUudXNlKCkgd2lsbCBhbHNvIHJlbWVtYmVyIHRoZSBsYW5ndWFnZS5cbiAgICAgIC8vIFNvLCB3ZSBkb24ndCBuZWVkIHRvIGNhbGwgc3RvcmFnZS5wdXQoKSBoZXJlLlxuICAgIH0gZWxzZSB7XG4gICAgICBzdG9yYWdlLnB1dChrZXksICR0cmFuc2xhdGUudXNlKCkpO1xuICAgIH1cbiAgfTtcblxuICBmYWxsYmFja0Zyb21JbmNvcnJlY3RTdG9yYWdlVmFsdWUuZGlzcGxheU5hbWUgPSAnZmFsbGJhY2tGcm9tSW5jb3JyZWN0U3RvcmFnZVZhbHVlJztcblxuICBpZiAoc3RvcmFnZSkge1xuICAgIGlmICghc3RvcmFnZS5nZXQoa2V5KSkge1xuICAgICAgZmFsbGJhY2tGcm9tSW5jb3JyZWN0U3RvcmFnZVZhbHVlKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgICR0cmFuc2xhdGUudXNlKHN0b3JhZ2UuZ2V0KGtleSkpWydjYXRjaCddKGZhbGxiYWNrRnJvbUluY29ycmVjdFN0b3JhZ2VWYWx1ZSk7XG4gICAgfVxuICB9IGVsc2UgaWYgKGFuZ3VsYXIuaXNTdHJpbmcoJHRyYW5zbGF0ZS5wcmVmZXJyZWRMYW5ndWFnZSgpKSkge1xuICAgICR0cmFuc2xhdGUudXNlKCR0cmFuc2xhdGUucHJlZmVycmVkTGFuZ3VhZ2UoKSk7XG4gIH1cbn1cblxucnVuVHJhbnNsYXRlLmRpc3BsYXlOYW1lID0gJ3J1blRyYW5zbGF0ZSc7XG5cbi8qKlxuICogQG5nZG9jIG9iamVjdFxuICogQG5hbWUgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlU2FuaXRpemF0aW9uUHJvdmlkZXJcbiAqXG4gKiBAZGVzY3JpcHRpb25cbiAqXG4gKiBDb25maWd1cmF0aW9ucyBmb3IgJHRyYW5zbGF0ZVNhbml0aXphdGlvblxuICovXG5hbmd1bGFyLm1vZHVsZSgncGFzY2FscHJlY2h0LnRyYW5zbGF0ZScpLnByb3ZpZGVyKCckdHJhbnNsYXRlU2FuaXRpemF0aW9uJywgJHRyYW5zbGF0ZVNhbml0aXphdGlvblByb3ZpZGVyKTtcblxuZnVuY3Rpb24gJHRyYW5zbGF0ZVNhbml0aXphdGlvblByb3ZpZGVyICgpIHtcblxuICAndXNlIHN0cmljdCc7XG5cbiAgdmFyICRzYW5pdGl6ZSxcbiAgICAgICRzY2UsXG4gICAgICBjdXJyZW50U3RyYXRlZ3kgPSBudWxsLCAvLyBUT0RPIGNoYW5nZSB0byBlaXRoZXIgJ3Nhbml0aXplJywgJ2VzY2FwZScgb3IgWydzYW5pdGl6ZScsICdlc2NhcGVQYXJhbWV0ZXJzJ10gaW4gMy4wLlxuICAgICAgaGFzQ29uZmlndXJlZFN0cmF0ZWd5ID0gZmFsc2UsXG4gICAgICBoYXNTaG93bk5vU3RyYXRlZ3lDb25maWd1cmVkV2FybmluZyA9IGZhbHNlLFxuICAgICAgc3RyYXRlZ2llcztcblxuICAvKipcbiAgICogRGVmaW5pdGlvbiBvZiBhIHNhbml0aXphdGlvbiBzdHJhdGVneSBmdW5jdGlvblxuICAgKiBAY2FsbGJhY2sgU3RyYXRlZ3lGdW5jdGlvblxuICAgKiBAcGFyYW0ge3N0cmluZ3xvYmplY3R9IHZhbHVlIC0gdmFsdWUgdG8gYmUgc2FuaXRpemVkIChlaXRoZXIgYSBzdHJpbmcgb3IgYW4gaW50ZXJwb2xhdGVkIHZhbHVlIG1hcClcbiAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGUgLSBlaXRoZXIgJ3RleHQnIGZvciBhIHN0cmluZyAodHJhbnNsYXRpb24pIG9yICdwYXJhbXMnIGZvciB0aGUgaW50ZXJwb2xhdGVkIHBhcmFtc1xuICAgKiBAcmV0dXJuIHtzdHJpbmd8b2JqZWN0fVxuICAgKi9cblxuICAvKipcbiAgICogQG5nZG9jIHByb3BlcnR5XG4gICAqIEBuYW1lIHN0cmF0ZWdpZXNcbiAgICogQHByb3BlcnR5T2YgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlU2FuaXRpemF0aW9uUHJvdmlkZXJcbiAgICpcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqIEZvbGxvd2luZyBzdHJhdGVnaWVzIGFyZSBidWlsdC1pbjpcbiAgICogPGRsPlxuICAgKiAgIDxkdD5zYW5pdGl6ZTwvZHQ+XG4gICAqICAgPGRkPlNhbml0aXplcyBIVE1MIGluIHRoZSB0cmFuc2xhdGlvbiB0ZXh0IHVzaW5nICRzYW5pdGl6ZTwvZGQ+XG4gICAqICAgPGR0PmVzY2FwZTwvZHQ+XG4gICAqICAgPGRkPkVzY2FwZXMgSFRNTCBpbiB0aGUgdHJhbnNsYXRpb248L2RkPlxuICAgKiAgIDxkdD5zYW5pdGl6ZVBhcmFtZXRlcnM8L2R0PlxuICAgKiAgIDxkZD5TYW5pdGl6ZXMgSFRNTCBpbiB0aGUgdmFsdWVzIG9mIHRoZSBpbnRlcnBvbGF0aW9uIHBhcmFtZXRlcnMgdXNpbmcgJHNhbml0aXplPC9kZD5cbiAgICogICA8ZHQ+ZXNjYXBlUGFyYW1ldGVyczwvZHQ+XG4gICAqICAgPGRkPkVzY2FwZXMgSFRNTCBpbiB0aGUgdmFsdWVzIG9mIHRoZSBpbnRlcnBvbGF0aW9uIHBhcmFtZXRlcnM8L2RkPlxuICAgKiAgIDxkdD5lc2NhcGVkPC9kdD5cbiAgICogICA8ZGQ+U3VwcG9ydCBsZWdhY3kgc3RyYXRlZ3kgbmFtZSAnZXNjYXBlZCcgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5ICh3aWxsIGJlIHJlbW92ZWQgaW4gMy4wKTwvZGQ+XG4gICAqIDwvZGw+XG4gICAqXG4gICAqL1xuXG4gIHN0cmF0ZWdpZXMgPSB7XG4gICAgc2FuaXRpemU6IGZ1bmN0aW9uICh2YWx1ZSwgbW9kZS8qLCBjb250ZXh0Ki8pIHtcbiAgICAgIGlmIChtb2RlID09PSAndGV4dCcpIHtcbiAgICAgICAgdmFsdWUgPSBodG1sU2FuaXRpemVWYWx1ZSh2YWx1ZSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gdmFsdWU7XG4gICAgfSxcbiAgICBlc2NhcGU6IGZ1bmN0aW9uICh2YWx1ZSwgbW9kZS8qLCBjb250ZXh0Ki8pIHtcbiAgICAgIGlmIChtb2RlID09PSAndGV4dCcpIHtcbiAgICAgICAgdmFsdWUgPSBodG1sRXNjYXBlVmFsdWUodmFsdWUpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH0sXG4gICAgc2FuaXRpemVQYXJhbWV0ZXJzOiBmdW5jdGlvbiAodmFsdWUsIG1vZGUvKiwgY29udGV4dCovKSB7XG4gICAgICBpZiAobW9kZSA9PT0gJ3BhcmFtcycpIHtcbiAgICAgICAgdmFsdWUgPSBtYXBJbnRlcnBvbGF0aW9uUGFyYW1ldGVycyh2YWx1ZSwgaHRtbFNhbml0aXplVmFsdWUpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH0sXG4gICAgZXNjYXBlUGFyYW1ldGVyczogZnVuY3Rpb24gKHZhbHVlLCBtb2RlLyosIGNvbnRleHQqLykge1xuICAgICAgaWYgKG1vZGUgPT09ICdwYXJhbXMnKSB7XG4gICAgICAgIHZhbHVlID0gbWFwSW50ZXJwb2xhdGlvblBhcmFtZXRlcnModmFsdWUsIGh0bWxFc2NhcGVWYWx1ZSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gdmFsdWU7XG4gICAgfSxcbiAgICBzY2U6IGZ1bmN0aW9uICh2YWx1ZSwgbW9kZSwgY29udGV4dCkge1xuICAgICAgaWYgKG1vZGUgPT09ICd0ZXh0Jykge1xuICAgICAgICB2YWx1ZSA9IGh0bWxUcnVzdFZhbHVlKHZhbHVlKTtcbiAgICAgIH0gZWxzZSBpZiAobW9kZSA9PT0gJ3BhcmFtcycpIHtcbiAgICAgICAgaWYgKGNvbnRleHQgIT09ICdmaWx0ZXInKSB7XG4gICAgICAgICAgLy8gZG8gaHRtbCBlc2NhcGUgaW4gZmlsdGVyIGNvbnRleHQgIzExMDFcbiAgICAgICAgICB2YWx1ZSA9IG1hcEludGVycG9sYXRpb25QYXJhbWV0ZXJzKHZhbHVlLCBodG1sRXNjYXBlVmFsdWUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gdmFsdWU7XG4gICAgfSxcbiAgICBzY2VQYXJhbWV0ZXJzOiBmdW5jdGlvbiAodmFsdWUsIG1vZGUvKiwgY29udGV4dCovKSB7XG4gICAgICBpZiAobW9kZSA9PT0gJ3BhcmFtcycpIHtcbiAgICAgICAgdmFsdWUgPSBtYXBJbnRlcnBvbGF0aW9uUGFyYW1ldGVycyh2YWx1ZSwgaHRtbFRydXN0VmFsdWUpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cbiAgfTtcbiAgLy8gU3VwcG9ydCBsZWdhY3kgc3RyYXRlZ3kgbmFtZSAnZXNjYXBlZCcgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LlxuICAvLyBUT0RPIHNob3VsZCBiZSByZW1vdmVkIGluIDMuMFxuICBzdHJhdGVnaWVzLmVzY2FwZWQgPSBzdHJhdGVnaWVzLmVzY2FwZVBhcmFtZXRlcnM7XG5cbiAgLyoqXG4gICAqIEBuZ2RvYyBmdW5jdGlvblxuICAgKiBAbmFtZSBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVTYW5pdGl6YXRpb25Qcm92aWRlciNhZGRTdHJhdGVneVxuICAgKiBAbWV0aG9kT2YgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlU2FuaXRpemF0aW9uUHJvdmlkZXJcbiAgICpcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqIEFkZHMgYSBzYW5pdGl6YXRpb24gc3RyYXRlZ3kgdG8gdGhlIGxpc3Qgb2Yga25vd24gc3RyYXRlZ2llcy5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IHN0cmF0ZWd5TmFtZSAtIHVuaXF1ZSBrZXkgZm9yIGEgc3RyYXRlZ3lcbiAgICogQHBhcmFtIHtTdHJhdGVneUZ1bmN0aW9ufSBzdHJhdGVneUZ1bmN0aW9uIC0gc3RyYXRlZ3kgZnVuY3Rpb25cbiAgICogQHJldHVybnMge29iamVjdH0gdGhpc1xuICAgKi9cbiAgdGhpcy5hZGRTdHJhdGVneSA9IGZ1bmN0aW9uIChzdHJhdGVneU5hbWUsIHN0cmF0ZWd5RnVuY3Rpb24pIHtcbiAgICBzdHJhdGVnaWVzW3N0cmF0ZWd5TmFtZV0gPSBzdHJhdGVneUZ1bmN0aW9uO1xuICAgIHJldHVybiB0aGlzO1xuICB9O1xuXG4gIC8qKlxuICAgKiBAbmdkb2MgZnVuY3Rpb25cbiAgICogQG5hbWUgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlU2FuaXRpemF0aW9uUHJvdmlkZXIjcmVtb3ZlU3RyYXRlZ3lcbiAgICogQG1ldGhvZE9mIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVNhbml0aXphdGlvblByb3ZpZGVyXG4gICAqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKiBSZW1vdmVzIGEgc2FuaXRpemF0aW9uIHN0cmF0ZWd5IGZyb20gdGhlIGxpc3Qgb2Yga25vd24gc3RyYXRlZ2llcy5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IHN0cmF0ZWd5TmFtZSAtIHVuaXF1ZSBrZXkgZm9yIGEgc3RyYXRlZ3lcbiAgICogQHJldHVybnMge29iamVjdH0gdGhpc1xuICAgKi9cbiAgdGhpcy5yZW1vdmVTdHJhdGVneSA9IGZ1bmN0aW9uIChzdHJhdGVneU5hbWUpIHtcbiAgICBkZWxldGUgc3RyYXRlZ2llc1tzdHJhdGVneU5hbWVdO1xuICAgIHJldHVybiB0aGlzO1xuICB9O1xuXG4gIC8qKlxuICAgKiBAbmdkb2MgZnVuY3Rpb25cbiAgICogQG5hbWUgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlU2FuaXRpemF0aW9uUHJvdmlkZXIjdXNlU3RyYXRlZ3lcbiAgICogQG1ldGhvZE9mIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVNhbml0aXphdGlvblByb3ZpZGVyXG4gICAqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKiBTZWxlY3RzIGEgc2FuaXRpemF0aW9uIHN0cmF0ZWd5LiBXaGVuIGFuIGFycmF5IGlzIHByb3ZpZGVkIHRoZSBzdHJhdGVnaWVzIHdpbGwgYmUgZXhlY3V0ZWQgaW4gb3JkZXIuXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfFN0cmF0ZWd5RnVuY3Rpb258YXJyYXl9IHN0cmF0ZWd5IFRoZSBzYW5pdGl6YXRpb24gc3RyYXRlZ3kgLyBzdHJhdGVnaWVzIHdoaWNoIHNob3VsZCBiZSB1c2VkLiBFaXRoZXIgYSBuYW1lIG9mIGFuIGV4aXN0aW5nIHN0cmF0ZWd5LCBhIGN1c3RvbSBzdHJhdGVneSBmdW5jdGlvbiwgb3IgYW4gYXJyYXkgY29uc2lzdGluZyBvZiBtdWx0aXBsZSBuYW1lcyBhbmQgLyBvciBjdXN0b20gZnVuY3Rpb25zLlxuICAgKiBAcmV0dXJucyB7b2JqZWN0fSB0aGlzXG4gICAqL1xuICB0aGlzLnVzZVN0cmF0ZWd5ID0gZnVuY3Rpb24gKHN0cmF0ZWd5KSB7XG4gICAgaGFzQ29uZmlndXJlZFN0cmF0ZWd5ID0gdHJ1ZTtcbiAgICBjdXJyZW50U3RyYXRlZ3kgPSBzdHJhdGVneTtcbiAgICByZXR1cm4gdGhpcztcbiAgfTtcblxuICAvKipcbiAgICogQG5nZG9jIG9iamVjdFxuICAgKiBAbmFtZSBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVTYW5pdGl6YXRpb25cbiAgICogQHJlcXVpcmVzICRpbmplY3RvclxuICAgKiBAcmVxdWlyZXMgJGxvZ1xuICAgKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICogU2FuaXRpemVzIGludGVycG9sYXRpb24gcGFyYW1ldGVycyBhbmQgdHJhbnNsYXRlZCB0ZXh0cy5cbiAgICpcbiAgICovXG4gIHRoaXMuJGdldCA9IFsnJGluamVjdG9yJywgJyRsb2cnLCBmdW5jdGlvbiAoJGluamVjdG9yLCAkbG9nKSB7XG5cbiAgICB2YXIgY2FjaGVkU3RyYXRlZ3lNYXAgPSB7fTtcblxuICAgIHZhciBhcHBseVN0cmF0ZWdpZXMgPSBmdW5jdGlvbiAodmFsdWUsIG1vZGUsIGNvbnRleHQsIHNlbGVjdGVkU3RyYXRlZ2llcykge1xuICAgICAgYW5ndWxhci5mb3JFYWNoKHNlbGVjdGVkU3RyYXRlZ2llcywgZnVuY3Rpb24gKHNlbGVjdGVkU3RyYXRlZ3kpIHtcbiAgICAgICAgaWYgKGFuZ3VsYXIuaXNGdW5jdGlvbihzZWxlY3RlZFN0cmF0ZWd5KSkge1xuICAgICAgICAgIHZhbHVlID0gc2VsZWN0ZWRTdHJhdGVneSh2YWx1ZSwgbW9kZSwgY29udGV4dCk7XG4gICAgICAgIH0gZWxzZSBpZiAoYW5ndWxhci5pc0Z1bmN0aW9uKHN0cmF0ZWdpZXNbc2VsZWN0ZWRTdHJhdGVneV0pKSB7XG4gICAgICAgICAgdmFsdWUgPSBzdHJhdGVnaWVzW3NlbGVjdGVkU3RyYXRlZ3ldKHZhbHVlLCBtb2RlLCBjb250ZXh0KTtcbiAgICAgICAgfSBlbHNlIGlmIChhbmd1bGFyLmlzU3RyaW5nKHN0cmF0ZWdpZXNbc2VsZWN0ZWRTdHJhdGVneV0pKSB7XG4gICAgICAgICAgaWYgKCFjYWNoZWRTdHJhdGVneU1hcFtzdHJhdGVnaWVzW3NlbGVjdGVkU3RyYXRlZ3ldXSkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgY2FjaGVkU3RyYXRlZ3lNYXBbc3RyYXRlZ2llc1tzZWxlY3RlZFN0cmF0ZWd5XV0gPSAkaW5qZWN0b3IuZ2V0KHN0cmF0ZWdpZXNbc2VsZWN0ZWRTdHJhdGVneV0pO1xuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICBjYWNoZWRTdHJhdGVneU1hcFtzdHJhdGVnaWVzW3NlbGVjdGVkU3RyYXRlZ3ldXSA9IGZ1bmN0aW9uKCkge307XG4gICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigncGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlU2FuaXRpemF0aW9uOiBVbmtub3duIHNhbml0aXphdGlvbiBzdHJhdGVneTogXFwnJyArIHNlbGVjdGVkU3RyYXRlZ3kgKyAnXFwnJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIHZhbHVlID0gY2FjaGVkU3RyYXRlZ3lNYXBbc3RyYXRlZ2llc1tzZWxlY3RlZFN0cmF0ZWd5XV0odmFsdWUsIG1vZGUsIGNvbnRleHQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcigncGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlU2FuaXRpemF0aW9uOiBVbmtub3duIHNhbml0aXphdGlvbiBzdHJhdGVneTogXFwnJyArIHNlbGVjdGVkU3RyYXRlZ3kgKyAnXFwnJyk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH07XG5cbiAgICAvLyBUT0RPOiBzaG91bGQgYmUgcmVtb3ZlZCBpbiAzLjBcbiAgICB2YXIgc2hvd05vU3RyYXRlZ3lDb25maWd1cmVkV2FybmluZyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgIGlmICghaGFzQ29uZmlndXJlZFN0cmF0ZWd5ICYmICFoYXNTaG93bk5vU3RyYXRlZ3lDb25maWd1cmVkV2FybmluZykge1xuICAgICAgICAkbG9nLndhcm4oJ3Bhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVNhbml0aXphdGlvbjogTm8gc2FuaXRpemF0aW9uIHN0cmF0ZWd5IGhhcyBiZWVuIGNvbmZpZ3VyZWQuIFRoaXMgY2FuIGhhdmUgc2VyaW91cyBzZWN1cml0eSBpbXBsaWNhdGlvbnMuIFNlZSBodHRwOi8vYW5ndWxhci10cmFuc2xhdGUuZ2l0aHViLmlvL2RvY3MvIy9ndWlkZS8xOV9zZWN1cml0eSBmb3IgZGV0YWlscy4nKTtcbiAgICAgICAgaGFzU2hvd25Ob1N0cmF0ZWd5Q29uZmlndXJlZFdhcm5pbmcgPSB0cnVlO1xuICAgICAgfVxuICAgIH07XG5cbiAgICBpZiAoJGluamVjdG9yLmhhcygnJHNhbml0aXplJykpIHtcbiAgICAgICRzYW5pdGl6ZSA9ICRpbmplY3Rvci5nZXQoJyRzYW5pdGl6ZScpO1xuICAgIH1cbiAgICBpZiAoJGluamVjdG9yLmhhcygnJHNjZScpKSB7XG4gICAgICAkc2NlID0gJGluamVjdG9yLmdldCgnJHNjZScpO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICAvKipcbiAgICAgICAqIEBuZ2RvYyBmdW5jdGlvblxuICAgICAgICogQG5hbWUgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlU2FuaXRpemF0aW9uI3VzZVN0cmF0ZWd5XG4gICAgICAgKiBAbWV0aG9kT2YgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlU2FuaXRpemF0aW9uXG4gICAgICAgKlxuICAgICAgICogQGRlc2NyaXB0aW9uXG4gICAgICAgKiBTZWxlY3RzIGEgc2FuaXRpemF0aW9uIHN0cmF0ZWd5LiBXaGVuIGFuIGFycmF5IGlzIHByb3ZpZGVkIHRoZSBzdHJhdGVnaWVzIHdpbGwgYmUgZXhlY3V0ZWQgaW4gb3JkZXIuXG4gICAgICAgKlxuICAgICAgICogQHBhcmFtIHtzdHJpbmd8U3RyYXRlZ3lGdW5jdGlvbnxhcnJheX0gc3RyYXRlZ3kgVGhlIHNhbml0aXphdGlvbiBzdHJhdGVneSAvIHN0cmF0ZWdpZXMgd2hpY2ggc2hvdWxkIGJlIHVzZWQuIEVpdGhlciBhIG5hbWUgb2YgYW4gZXhpc3Rpbmcgc3RyYXRlZ3ksIGEgY3VzdG9tIHN0cmF0ZWd5IGZ1bmN0aW9uLCBvciBhbiBhcnJheSBjb25zaXN0aW5nIG9mIG11bHRpcGxlIG5hbWVzIGFuZCAvIG9yIGN1c3RvbSBmdW5jdGlvbnMuXG4gICAgICAgKi9cbiAgICAgIHVzZVN0cmF0ZWd5OiAoZnVuY3Rpb24gKHNlbGYpIHtcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzdHJhdGVneSkge1xuICAgICAgICAgIHNlbGYudXNlU3RyYXRlZ3koc3RyYXRlZ3kpO1xuICAgICAgICB9O1xuICAgICAgfSkodGhpcyksXG5cbiAgICAgIC8qKlxuICAgICAgICogQG5nZG9jIGZ1bmN0aW9uXG4gICAgICAgKiBAbmFtZSBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVTYW5pdGl6YXRpb24jc2FuaXRpemVcbiAgICAgICAqIEBtZXRob2RPZiBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVTYW5pdGl6YXRpb25cbiAgICAgICAqXG4gICAgICAgKiBAZGVzY3JpcHRpb25cbiAgICAgICAqIFNhbml0aXplcyBhIHZhbHVlLlxuICAgICAgICpcbiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfG9iamVjdH0gdmFsdWUgVGhlIHZhbHVlIHdoaWNoIHNob3VsZCBiZSBzYW5pdGl6ZWQuXG4gICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZSBUaGUgY3VycmVudCBzYW5pdGl6YXRpb24gbW9kZSwgZWl0aGVyICdwYXJhbXMnIG9yICd0ZXh0Jy5cbiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfFN0cmF0ZWd5RnVuY3Rpb258YXJyYXl9IFtzdHJhdGVneV0gT3B0aW9uYWwgY3VzdG9tIHN0cmF0ZWd5IHdoaWNoIHNob3VsZCBiZSB1c2VkIGluc3RlYWQgb2YgdGhlIGN1cnJlbnRseSBzZWxlY3RlZCBzdHJhdGVneS5cbiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29udGV4dF0gVGhlIGNvbnRleHQgb2YgdGhpcyBjYWxsOiBmaWx0ZXIsIHNlcnZpY2UuIERlZmF1bHQgaXMgc2VydmljZVxuICAgICAgICogQHJldHVybnMge3N0cmluZ3xvYmplY3R9IHNhbml0aXplZCB2YWx1ZVxuICAgICAgICovXG4gICAgICBzYW5pdGl6ZTogZnVuY3Rpb24gKHZhbHVlLCBtb2RlLCBzdHJhdGVneSwgY29udGV4dCkge1xuICAgICAgICBpZiAoIWN1cnJlbnRTdHJhdGVneSkge1xuICAgICAgICAgIHNob3dOb1N0cmF0ZWd5Q29uZmlndXJlZFdhcm5pbmcoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghc3RyYXRlZ3kgJiYgc3RyYXRlZ3kgIT09IG51bGwpIHtcbiAgICAgICAgICBzdHJhdGVneSA9IGN1cnJlbnRTdHJhdGVneTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghc3RyYXRlZ3kpIHtcbiAgICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWNvbnRleHQpIHtcbiAgICAgICAgICBjb250ZXh0ID0gJ3NlcnZpY2UnO1xuICAgICAgICB9XG5cbiAgICAgICAgdmFyIHNlbGVjdGVkU3RyYXRlZ2llcyA9IGFuZ3VsYXIuaXNBcnJheShzdHJhdGVneSkgPyBzdHJhdGVneSA6IFtzdHJhdGVneV07XG4gICAgICAgIHJldHVybiBhcHBseVN0cmF0ZWdpZXModmFsdWUsIG1vZGUsIGNvbnRleHQsIHNlbGVjdGVkU3RyYXRlZ2llcyk7XG4gICAgICB9XG4gICAgfTtcbiAgfV07XG5cbiAgdmFyIGh0bWxFc2NhcGVWYWx1ZSA9IGZ1bmN0aW9uICh2YWx1ZSkge1xuICAgIHZhciBlbGVtZW50ID0gYW5ndWxhci5lbGVtZW50KCc8ZGl2PjwvZGl2PicpO1xuICAgIGVsZW1lbnQudGV4dCh2YWx1ZSk7IC8vIG5vdCBjaGFpbmFibGUsIHNlZSAjMTA0NFxuICAgIHJldHVybiBlbGVtZW50Lmh0bWwoKTtcbiAgfTtcblxuICB2YXIgaHRtbFNhbml0aXplVmFsdWUgPSBmdW5jdGlvbiAodmFsdWUpIHtcbiAgICBpZiAoISRzYW5pdGl6ZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVTYW5pdGl6YXRpb246IEVycm9yIGNhbm5vdCBmaW5kICRzYW5pdGl6ZSBzZXJ2aWNlLiBFaXRoZXIgaW5jbHVkZSB0aGUgbmdTYW5pdGl6ZSBtb2R1bGUgKGh0dHBzOi8vZG9jcy5hbmd1bGFyanMub3JnL2FwaS9uZ1Nhbml0aXplKSBvciB1c2UgYSBzYW5pdGl6YXRpb24gc3RyYXRlZ3kgd2hpY2ggZG9lcyBub3QgZGVwZW5kIG9uICRzYW5pdGl6ZSwgc3VjaCBhcyBcXCdlc2NhcGVcXCcuJyk7XG4gICAgfVxuICAgIHJldHVybiAkc2FuaXRpemUodmFsdWUpO1xuICB9O1xuXG4gIHZhciBodG1sVHJ1c3RWYWx1ZSA9IGZ1bmN0aW9uICh2YWx1ZSkge1xuICAgIGlmICghJHNjZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVTYW5pdGl6YXRpb246IEVycm9yIGNhbm5vdCBmaW5kICRzY2Ugc2VydmljZS4nKTtcbiAgICB9XG4gICAgcmV0dXJuICRzY2UudHJ1c3RBc0h0bWwodmFsdWUpO1xuICB9O1xuXG4gIHZhciBtYXBJbnRlcnBvbGF0aW9uUGFyYW1ldGVycyA9IGZ1bmN0aW9uICh2YWx1ZSwgaXRlcmF0ZWUsIHN0YWNrKSB7XG4gICAgaWYgKGFuZ3VsYXIuaXNEYXRlKHZhbHVlKSkge1xuICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH0gZWxzZSBpZiAoYW5ndWxhci5pc09iamVjdCh2YWx1ZSkpIHtcbiAgICAgIHZhciByZXN1bHQgPSBhbmd1bGFyLmlzQXJyYXkodmFsdWUpID8gW10gOiB7fTtcblxuICAgICAgaWYgKCFzdGFjaykge1xuICAgICAgICBzdGFjayA9IFtdO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKHN0YWNrLmluZGV4T2YodmFsdWUpID4gLTEpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Bhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVNhbml0aXphdGlvbjogRXJyb3IgY2Fubm90IGludGVycG9sYXRlIHBhcmFtZXRlciBkdWUgcmVjdXJzaXZlIG9iamVjdCcpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHN0YWNrLnB1c2godmFsdWUpO1xuICAgICAgYW5ndWxhci5mb3JFYWNoKHZhbHVlLCBmdW5jdGlvbiAocHJvcGVydHlWYWx1ZSwgcHJvcGVydHlLZXkpIHtcblxuICAgICAgICAvKiBTa2lwcGluZyBmdW5jdGlvbiBwcm9wZXJ0aWVzLiAqL1xuICAgICAgICBpZiAoYW5ndWxhci5pc0Z1bmN0aW9uKHByb3BlcnR5VmFsdWUpKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgcmVzdWx0W3Byb3BlcnR5S2V5XSA9IG1hcEludGVycG9sYXRpb25QYXJhbWV0ZXJzKHByb3BlcnR5VmFsdWUsIGl0ZXJhdGVlLCBzdGFjayk7XG4gICAgICB9KTtcbiAgICAgIHN0YWNrLnNwbGljZSgtMSwgMSk7IC8vIHJlbW92ZSBsYXN0XG5cbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSBlbHNlIGlmIChhbmd1bGFyLmlzTnVtYmVyKHZhbHVlKSkge1xuICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH0gZWxzZSBpZiAodmFsdWUgPT09IHRydWUgfHwgdmFsdWUgPT09IGZhbHNlKSB7XG4gICAgICByZXR1cm4gdmFsdWU7XG4gICAgfSBlbHNlIGlmICghYW5ndWxhci5pc1VuZGVmaW5lZCh2YWx1ZSkgJiYgdmFsdWUgIT09IG51bGwpIHtcbiAgICAgIHJldHVybiBpdGVyYXRlZSh2YWx1ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9XG4gIH07XG59XG5cbi8qKlxuICogQG5nZG9jIG9iamVjdFxuICogQG5hbWUgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlUHJvdmlkZXJcbiAqIEBkZXNjcmlwdGlvblxuICpcbiAqICR0cmFuc2xhdGVQcm92aWRlciBhbGxvd3MgZGV2ZWxvcGVycyB0byByZWdpc3RlciB0cmFuc2xhdGlvbi10YWJsZXMsIGFzeW5jaHJvbm91cyBsb2FkZXJzXG4gKiBhbmQgc2ltaWxhciB0byBjb25maWd1cmUgdHJhbnNsYXRpb24gYmVoYXZpb3IgZGlyZWN0bHkgaW5zaWRlIG9mIGEgbW9kdWxlLlxuICpcbiAqL1xuYW5ndWxhci5tb2R1bGUoJ3Bhc2NhbHByZWNodC50cmFuc2xhdGUnKVxuICAuY29uc3RhbnQoJ3Bhc2NhbHByZWNodFRyYW5zbGF0ZU92ZXJyaWRlcicsIHt9KVxuICAucHJvdmlkZXIoJyR0cmFuc2xhdGUnLCAkdHJhbnNsYXRlKTtcblxuZnVuY3Rpb24gJHRyYW5zbGF0ZSgkU1RPUkFHRV9LRVksICR3aW5kb3dQcm92aWRlciwgJHRyYW5zbGF0ZVNhbml0aXphdGlvblByb3ZpZGVyLCBwYXNjYWxwcmVjaHRUcmFuc2xhdGVPdmVycmlkZXIpIHtcblxuICAndXNlIHN0cmljdCc7XG5cbiAgdmFyICR0cmFuc2xhdGlvblRhYmxlID0ge30sXG4gICAgJHByZWZlcnJlZExhbmd1YWdlLFxuICAgICRhdmFpbGFibGVMYW5ndWFnZUtleXMgPSBbXSxcbiAgICAkbGFuZ3VhZ2VLZXlBbGlhc2VzLFxuICAgICRmYWxsYmFja0xhbmd1YWdlLFxuICAgICRmYWxsYmFja1dhc1N0cmluZyxcbiAgICAkdXNlcyxcbiAgICAkbmV4dExhbmcsXG4gICAgJHN0b3JhZ2VGYWN0b3J5LFxuICAgICRzdG9yYWdlS2V5ID0gJFNUT1JBR0VfS0VZLFxuICAgICRzdG9yYWdlUHJlZml4LFxuICAgICRtaXNzaW5nVHJhbnNsYXRpb25IYW5kbGVyRmFjdG9yeSxcbiAgICAkaW50ZXJwb2xhdGlvbkZhY3RvcnksXG4gICAgJGludGVycG9sYXRvckZhY3RvcmllcyA9IFtdLFxuICAgICRsb2FkZXJGYWN0b3J5LFxuICAgICRjbG9ha0NsYXNzTmFtZSA9ICd0cmFuc2xhdGUtY2xvYWsnLFxuICAgICRsb2FkZXJPcHRpb25zLFxuICAgICRub3RGb3VuZEluZGljYXRvckxlZnQsXG4gICAgJG5vdEZvdW5kSW5kaWNhdG9yUmlnaHQsXG4gICAgJHBvc3RDb21waWxpbmdFbmFibGVkID0gZmFsc2UsXG4gICAgJGZvcmNlQXN5bmNSZWxvYWRFbmFibGVkID0gZmFsc2UsXG4gICAgJG5lc3RlZE9iamVjdERlbGltZXRlciA9ICcuJyxcbiAgICAkaXNSZWFkeSA9IGZhbHNlLFxuICAgICRrZWVwQ29udGVudCA9IGZhbHNlLFxuICAgIGxvYWRlckNhY2hlLFxuICAgIGRpcmVjdGl2ZVByaW9yaXR5ID0gMCxcbiAgICBzdGF0ZWZ1bEZpbHRlciA9IHRydWUsXG4gICAgcG9zdFByb2Nlc3NGbixcbiAgICB1bmlmb3JtTGFuZ3VhZ2VUYWdSZXNvbHZlciA9ICdkZWZhdWx0JyxcbiAgICBsYW5ndWFnZVRhZ1Jlc29sdmVyID0ge1xuICAgICAgJ2RlZmF1bHQnIDogZnVuY3Rpb24gKHRhZykge1xuICAgICAgICByZXR1cm4gKHRhZyB8fCAnJykuc3BsaXQoJy0nKS5qb2luKCdfJyk7XG4gICAgICB9LFxuICAgICAgamF2YSA6IGZ1bmN0aW9uICh0YWcpIHtcbiAgICAgICAgdmFyIHRlbXAgPSAodGFnIHx8ICcnKS5zcGxpdCgnLScpLmpvaW4oJ18nKTtcbiAgICAgICAgdmFyIHBhcnRzID0gdGVtcC5zcGxpdCgnXycpO1xuICAgICAgICByZXR1cm4gcGFydHMubGVuZ3RoID4gMSA/IChwYXJ0c1swXS50b0xvd2VyQ2FzZSgpICsgJ18nICsgcGFydHNbMV0udG9VcHBlckNhc2UoKSkgOiB0ZW1wO1xuICAgICAgfSxcbiAgICAgIGJjcDQ3IDogZnVuY3Rpb24gKHRhZykge1xuICAgICAgICB2YXIgdGVtcCA9ICh0YWcgfHwgJycpLnNwbGl0KCdfJykuam9pbignLScpO1xuICAgICAgICB2YXIgcGFydHMgPSB0ZW1wLnNwbGl0KCctJyk7XG4gICAgICAgIHJldHVybiBwYXJ0cy5sZW5ndGggPiAxID8gKHBhcnRzWzBdLnRvTG93ZXJDYXNlKCkgKyAnLScgKyBwYXJ0c1sxXS50b1VwcGVyQ2FzZSgpKSA6IHRlbXA7XG4gICAgICB9LFxuICAgICAgJ2lzbzYzOS0xJyA6IGZ1bmN0aW9uICh0YWcpIHtcbiAgICAgICAgdmFyIHRlbXAgPSAodGFnIHx8ICcnKS5zcGxpdCgnXycpLmpvaW4oJy0nKTtcbiAgICAgICAgdmFyIHBhcnRzID0gdGVtcC5zcGxpdCgnLScpO1xuICAgICAgICByZXR1cm4gcGFydHNbMF0udG9Mb3dlckNhc2UoKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gIHZhciB2ZXJzaW9uID0gJzIuMTUuMic7XG5cbiAgLy8gdHJpZXMgdG8gZGV0ZXJtaW5lIHRoZSBicm93c2VycyBsYW5ndWFnZVxuICB2YXIgZ2V0Rmlyc3RCcm93c2VyTGFuZ3VhZ2UgPSBmdW5jdGlvbiAoKSB7XG5cbiAgICAvLyBpbnRlcm5hbCBwdXJwb3NlIG9ubHlcbiAgICBpZiAoYW5ndWxhci5pc0Z1bmN0aW9uKHBhc2NhbHByZWNodFRyYW5zbGF0ZU92ZXJyaWRlci5nZXRMb2NhbGUpKSB7XG4gICAgICByZXR1cm4gcGFzY2FscHJlY2h0VHJhbnNsYXRlT3ZlcnJpZGVyLmdldExvY2FsZSgpO1xuICAgIH1cblxuICAgIHZhciBuYXYgPSAkd2luZG93UHJvdmlkZXIuJGdldCgpLm5hdmlnYXRvcixcbiAgICAgIGJyb3dzZXJMYW5ndWFnZVByb3BlcnR5S2V5cyA9IFsnbGFuZ3VhZ2UnLCAnYnJvd3Nlckxhbmd1YWdlJywgJ3N5c3RlbUxhbmd1YWdlJywgJ3VzZXJMYW5ndWFnZSddLFxuICAgICAgaSxcbiAgICAgIGxhbmd1YWdlO1xuXG4gICAgLy8gc3VwcG9ydCBmb3IgSFRNTCA1LjEgXCJuYXZpZ2F0b3IubGFuZ3VhZ2VzXCJcbiAgICBpZiAoYW5ndWxhci5pc0FycmF5KG5hdi5sYW5ndWFnZXMpKSB7XG4gICAgICBmb3IgKGkgPSAwOyBpIDwgbmF2Lmxhbmd1YWdlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICBsYW5ndWFnZSA9IG5hdi5sYW5ndWFnZXNbaV07XG4gICAgICAgIGlmIChsYW5ndWFnZSAmJiBsYW5ndWFnZS5sZW5ndGgpIHtcbiAgICAgICAgICByZXR1cm4gbGFuZ3VhZ2U7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBzdXBwb3J0IGZvciBvdGhlciB3ZWxsIGtub3duIHByb3BlcnRpZXMgaW4gYnJvd3NlcnNcbiAgICBmb3IgKGkgPSAwOyBpIDwgYnJvd3Nlckxhbmd1YWdlUHJvcGVydHlLZXlzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBsYW5ndWFnZSA9IG5hdlticm93c2VyTGFuZ3VhZ2VQcm9wZXJ0eUtleXNbaV1dO1xuICAgICAgaWYgKGxhbmd1YWdlICYmIGxhbmd1YWdlLmxlbmd0aCkge1xuICAgICAgICByZXR1cm4gbGFuZ3VhZ2U7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG51bGw7XG4gIH07XG4gIGdldEZpcnN0QnJvd3Nlckxhbmd1YWdlLmRpc3BsYXlOYW1lID0gJ2FuZ3VsYXItdHJhbnNsYXRlL3NlcnZpY2U6IGdldEZpcnN0QnJvd3Nlckxhbmd1YWdlJztcblxuICAvLyB0cmllcyB0byBkZXRlcm1pbmUgdGhlIGJyb3dzZXJzIGxvY2FsZVxuICB2YXIgZ2V0TG9jYWxlID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciBsb2NhbGUgPSBnZXRGaXJzdEJyb3dzZXJMYW5ndWFnZSgpIHx8ICcnO1xuICAgIGlmIChsYW5ndWFnZVRhZ1Jlc29sdmVyW3VuaWZvcm1MYW5ndWFnZVRhZ1Jlc29sdmVyXSkge1xuICAgICAgbG9jYWxlID0gbGFuZ3VhZ2VUYWdSZXNvbHZlclt1bmlmb3JtTGFuZ3VhZ2VUYWdSZXNvbHZlcl0obG9jYWxlKTtcbiAgICB9XG4gICAgcmV0dXJuIGxvY2FsZTtcbiAgfTtcbiAgZ2V0TG9jYWxlLmRpc3BsYXlOYW1lID0gJ2FuZ3VsYXItdHJhbnNsYXRlL3NlcnZpY2U6IGdldExvY2FsZSc7XG5cbiAgLyoqXG4gICAqIEBuYW1lIGluZGV4T2ZcbiAgICogQHByaXZhdGVcbiAgICpcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqIGluZGV4T2YgcG9seWZpbGwuIEtpbmRhIHNvcnRhLlxuICAgKlxuICAgKiBAcGFyYW0ge2FycmF5fSBhcnJheSBBcnJheSB0byBzZWFyY2ggaW4uXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBzZWFyY2hFbGVtZW50IEVsZW1lbnQgdG8gc2VhcmNoIGZvci5cbiAgICpcbiAgICogQHJldHVybnMge2ludH0gSW5kZXggb2Ygc2VhcmNoIGVsZW1lbnQuXG4gICAqL1xuICB2YXIgaW5kZXhPZiA9IGZ1bmN0aW9uIChhcnJheSwgc2VhcmNoRWxlbWVudCkge1xuICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBhcnJheS5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xuICAgICAgaWYgKGFycmF5W2ldID09PSBzZWFyY2hFbGVtZW50KSB7XG4gICAgICAgIHJldHVybiBpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gLTE7XG4gIH07XG5cbiAgLyoqXG4gICAqIEBuYW1lIHRyaW1cbiAgICogQHByaXZhdGVcbiAgICpcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqIHRyaW0gcG9seWZpbGxcbiAgICpcbiAgICogQHJldHVybnMge3N0cmluZ30gVGhlIHN0cmluZyBzdHJpcHBlZCBvZiB3aGl0ZXNwYWNlIGZyb20gYm90aCBlbmRzXG4gICAqL1xuICB2YXIgdHJpbSA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gdGhpcy50b1N0cmluZygpLnJlcGxhY2UoL15cXHMrfFxccyskL2csICcnKTtcbiAgfTtcblxuICB2YXIgbmVnb3RpYXRlTG9jYWxlID0gZnVuY3Rpb24gKHByZWZlcnJlZCkge1xuICAgIGlmICghcHJlZmVycmVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdmFyIGF2YWlsID0gW10sXG4gICAgICBsb2NhbGUgPSBhbmd1bGFyLmxvd2VyY2FzZShwcmVmZXJyZWQpLFxuICAgICAgaSA9IDAsXG4gICAgICBuID0gJGF2YWlsYWJsZUxhbmd1YWdlS2V5cy5sZW5ndGg7XG5cbiAgICBmb3IgKDsgaSA8IG47IGkrKykge1xuICAgICAgYXZhaWwucHVzaChhbmd1bGFyLmxvd2VyY2FzZSgkYXZhaWxhYmxlTGFuZ3VhZ2VLZXlzW2ldKSk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgZm9yIGFuIGV4YWN0IG1hdGNoIGluIG91ciBsaXN0IG9mIGF2YWlsYWJsZSBrZXlzXG4gICAgaWYgKGluZGV4T2YoYXZhaWwsIGxvY2FsZSkgPiAtMSkge1xuICAgICAgcmV0dXJuIHByZWZlcnJlZDtcbiAgICB9XG5cbiAgICBpZiAoJGxhbmd1YWdlS2V5QWxpYXNlcykge1xuICAgICAgdmFyIGFsaWFzO1xuICAgICAgZm9yICh2YXIgbGFuZ0tleUFsaWFzIGluICRsYW5ndWFnZUtleUFsaWFzZXMpIHtcbiAgICAgICAgaWYgKCRsYW5ndWFnZUtleUFsaWFzZXMuaGFzT3duUHJvcGVydHkobGFuZ0tleUFsaWFzKSkge1xuICAgICAgICAgIHZhciBoYXNXaWxkY2FyZEtleSA9IGZhbHNlO1xuICAgICAgICAgIHZhciBoYXNFeGFjdEtleSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCgkbGFuZ3VhZ2VLZXlBbGlhc2VzLCBsYW5nS2V5QWxpYXMpICYmXG4gICAgICAgICAgICBhbmd1bGFyLmxvd2VyY2FzZShsYW5nS2V5QWxpYXMpID09PSBhbmd1bGFyLmxvd2VyY2FzZShwcmVmZXJyZWQpO1xuXG4gICAgICAgICAgaWYgKGxhbmdLZXlBbGlhcy5zbGljZSgtMSkgPT09ICcqJykge1xuICAgICAgICAgICAgaGFzV2lsZGNhcmRLZXkgPSBsYW5nS2V5QWxpYXMuc2xpY2UoMCwgLTEpID09PSBwcmVmZXJyZWQuc2xpY2UoMCwgbGFuZ0tleUFsaWFzLmxlbmd0aCAtIDEpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoaGFzRXhhY3RLZXkgfHwgaGFzV2lsZGNhcmRLZXkpIHtcbiAgICAgICAgICAgIGFsaWFzID0gJGxhbmd1YWdlS2V5QWxpYXNlc1tsYW5nS2V5QWxpYXNdO1xuICAgICAgICAgICAgaWYgKGluZGV4T2YoYXZhaWwsIGFuZ3VsYXIubG93ZXJjYXNlKGFsaWFzKSkgPiAtMSkge1xuICAgICAgICAgICAgICByZXR1cm4gYWxpYXM7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgZm9yIGEgbGFuZ3VhZ2UgY29kZSB3aXRob3V0IHJlZ2lvblxuICAgIHZhciBwYXJ0cyA9IHByZWZlcnJlZC5zcGxpdCgnXycpO1xuXG4gICAgaWYgKHBhcnRzLmxlbmd0aCA+IDEgJiYgaW5kZXhPZihhdmFpbCwgYW5ndWxhci5sb3dlcmNhc2UocGFydHNbMF0pKSA+IC0xKSB7XG4gICAgICByZXR1cm4gcGFydHNbMF07XG4gICAgfVxuXG4gICAgLy8gSWYgZXZlcnl0aGluZyBmYWlscywgcmV0dXJuIHVuZGVmaW5lZC5cbiAgICByZXR1cm47XG4gIH07XG5cbiAgLyoqXG4gICAqIEBuZ2RvYyBmdW5jdGlvblxuICAgKiBAbmFtZSBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVQcm92aWRlciN0cmFuc2xhdGlvbnNcbiAgICogQG1ldGhvZE9mIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVByb3ZpZGVyXG4gICAqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKiBSZWdpc3RlcnMgYSBuZXcgdHJhbnNsYXRpb24gdGFibGUgZm9yIHNwZWNpZmljIGxhbmd1YWdlIGtleS5cbiAgICpcbiAgICogVG8gcmVnaXN0ZXIgYSB0cmFuc2xhdGlvbiB0YWJsZSBmb3Igc3BlY2lmaWMgbGFuZ3VhZ2UsIHBhc3MgYSBkZWZpbmVkIGxhbmd1YWdlXG4gICAqIGtleSBhcyBmaXJzdCBwYXJhbWV0ZXIuXG4gICAqXG4gICAqIDxwcmU+XG4gICAqICAvLyByZWdpc3RlciB0cmFuc2xhdGlvbiB0YWJsZSBmb3IgbGFuZ3VhZ2U6ICdkZV9ERSdcbiAgICogICR0cmFuc2xhdGVQcm92aWRlci50cmFuc2xhdGlvbnMoJ2RlX0RFJywge1xuICAgKiAgICAnR1JFRVRJTkcnOiAnSGFsbG8gV2VsdCEnXG4gICAqICB9KTtcbiAgICpcbiAgICogIC8vIHJlZ2lzdGVyIGFub3RoZXIgb25lXG4gICAqICAkdHJhbnNsYXRlUHJvdmlkZXIudHJhbnNsYXRpb25zKCdlbl9VUycsIHtcbiAgICogICAgJ0dSRUVUSU5HJzogJ0hlbGxvIHdvcmxkISdcbiAgICogIH0pO1xuICAgKiA8L3ByZT5cbiAgICpcbiAgICogV2hlbiByZWdpc3RlcmluZyBtdWx0aXBsZSB0cmFuc2xhdGlvbiB0YWJsZXMgZm9yIGZvciB0aGUgc2FtZSBsYW5ndWFnZSBrZXksXG4gICAqIHRoZSBhY3R1YWwgdHJhbnNsYXRpb24gdGFibGUgZ2V0cyBleHRlbmRlZC4gVGhpcyBhbGxvd3MgeW91IHRvIGRlZmluZSBtb2R1bGVcbiAgICogc3BlY2lmaWMgdHJhbnNsYXRpb24gd2hpY2ggb25seSBnZXQgYWRkZWQsIG9uY2UgYSBzcGVjaWZpYyBtb2R1bGUgaXMgbG9hZGVkIGluXG4gICAqIHlvdXIgYXBwLlxuICAgKlxuICAgKiBJbnZva2luZyB0aGlzIG1ldGhvZCB3aXRoIG5vIGFyZ3VtZW50cyByZXR1cm5zIHRoZSB0cmFuc2xhdGlvbiB0YWJsZSB3aGljaCB3YXNcbiAgICogcmVnaXN0ZXJlZCB3aXRoIG5vIGxhbmd1YWdlIGtleS4gSW52b2tpbmcgaXQgd2l0aCBhIGxhbmd1YWdlIGtleSByZXR1cm5zIHRoZVxuICAgKiByZWxhdGVkIHRyYW5zbGF0aW9uIHRhYmxlLlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gbGFuZ0tleSBBIGxhbmd1YWdlIGtleS5cbiAgICogQHBhcmFtIHtvYmplY3R9IHRyYW5zbGF0aW9uVGFibGUgQSBwbGFpbiBvbGQgSmF2YVNjcmlwdCBvYmplY3QgdGhhdCByZXByZXNlbnRzIGEgdHJhbnNsYXRpb24gdGFibGUuXG4gICAqXG4gICAqL1xuICB2YXIgdHJhbnNsYXRpb25zID0gZnVuY3Rpb24gKGxhbmdLZXksIHRyYW5zbGF0aW9uVGFibGUpIHtcblxuICAgIGlmICghbGFuZ0tleSAmJiAhdHJhbnNsYXRpb25UYWJsZSkge1xuICAgICAgcmV0dXJuICR0cmFuc2xhdGlvblRhYmxlO1xuICAgIH1cblxuICAgIGlmIChsYW5nS2V5ICYmICF0cmFuc2xhdGlvblRhYmxlKSB7XG4gICAgICBpZiAoYW5ndWxhci5pc1N0cmluZyhsYW5nS2V5KSkge1xuICAgICAgICByZXR1cm4gJHRyYW5zbGF0aW9uVGFibGVbbGFuZ0tleV07XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghYW5ndWxhci5pc09iamVjdCgkdHJhbnNsYXRpb25UYWJsZVtsYW5nS2V5XSkpIHtcbiAgICAgICAgJHRyYW5zbGF0aW9uVGFibGVbbGFuZ0tleV0gPSB7fTtcbiAgICAgIH1cbiAgICAgIGFuZ3VsYXIuZXh0ZW5kKCR0cmFuc2xhdGlvblRhYmxlW2xhbmdLZXldLCBmbGF0T2JqZWN0KHRyYW5zbGF0aW9uVGFibGUpKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXM7XG4gIH07XG5cbiAgdGhpcy50cmFuc2xhdGlvbnMgPSB0cmFuc2xhdGlvbnM7XG5cbiAgLyoqXG4gICAqIEBuZ2RvYyBmdW5jdGlvblxuICAgKiBAbmFtZSBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVQcm92aWRlciNjbG9ha0NsYXNzTmFtZVxuICAgKiBAbWV0aG9kT2YgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlUHJvdmlkZXJcbiAgICpcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqXG4gICAqIExldCdzIHlvdSBjaGFuZ2UgdGhlIGNsYXNzIG5hbWUgZm9yIGB0cmFuc2xhdGUtY2xvYWtgIGRpcmVjdGl2ZS5cbiAgICogRGVmYXVsdCBjbGFzcyBuYW1lIGlzIGB0cmFuc2xhdGUtY2xvYWtgLlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSB0cmFuc2xhdGUtY2xvYWsgY2xhc3MgbmFtZVxuICAgKi9cbiAgdGhpcy5jbG9ha0NsYXNzTmFtZSA9IGZ1bmN0aW9uIChuYW1lKSB7XG4gICAgaWYgKCFuYW1lKSB7XG4gICAgICByZXR1cm4gJGNsb2FrQ2xhc3NOYW1lO1xuICAgIH1cbiAgICAkY2xvYWtDbGFzc05hbWUgPSBuYW1lO1xuICAgIHJldHVybiB0aGlzO1xuICB9O1xuXG4gIC8qKlxuICAgKiBAbmdkb2MgZnVuY3Rpb25cbiAgICogQG5hbWUgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlUHJvdmlkZXIjbmVzdGVkT2JqZWN0RGVsaW1ldGVyXG4gICAqIEBtZXRob2RPZiBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVQcm92aWRlclxuICAgKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICpcbiAgICogTGV0J3MgeW91IGNoYW5nZSB0aGUgZGVsaW1pdGVyIGZvciBuYW1lc3BhY2VkIHRyYW5zbGF0aW9ucy5cbiAgICogRGVmYXVsdCBkZWxpbWl0ZXIgaXMgYC5gLlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gZGVsaW1pdGVyIG5hbWVzcGFjZSBzZXBhcmF0b3JcbiAgICovXG4gIHRoaXMubmVzdGVkT2JqZWN0RGVsaW1ldGVyID0gZnVuY3Rpb24gKGRlbGltaXRlcikge1xuICAgIGlmICghZGVsaW1pdGVyKSB7XG4gICAgICByZXR1cm4gJG5lc3RlZE9iamVjdERlbGltZXRlcjtcbiAgICB9XG4gICAgJG5lc3RlZE9iamVjdERlbGltZXRlciA9IGRlbGltaXRlcjtcbiAgICByZXR1cm4gdGhpcztcbiAgfTtcblxuICAvKipcbiAgICogQG5hbWUgZmxhdE9iamVjdFxuICAgKiBAcHJpdmF0ZVxuICAgKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICogRmxhdHMgYW4gb2JqZWN0LiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQgdG8gZmxhdHRlbiBnaXZlbiB0cmFuc2xhdGlvbiBkYXRhIHdpdGhcbiAgICogbmFtZXNwYWNlcywgc28gdGhleSBhcmUgbGF0ZXIgYWNjZXNzaWJsZSB2aWEgZG90IG5vdGF0aW9uLlxuICAgKi9cbiAgdmFyIGZsYXRPYmplY3QgPSBmdW5jdGlvbiAoZGF0YSwgcGF0aCwgcmVzdWx0LCBwcmV2S2V5KSB7XG4gICAgdmFyIGtleSwga2V5V2l0aFBhdGgsIGtleVdpdGhTaG9ydFBhdGgsIHZhbDtcblxuICAgIGlmICghcGF0aCkge1xuICAgICAgcGF0aCA9IFtdO1xuICAgIH1cbiAgICBpZiAoIXJlc3VsdCkge1xuICAgICAgcmVzdWx0ID0ge307XG4gICAgfVxuICAgIGZvciAoa2V5IGluIGRhdGEpIHtcbiAgICAgIGlmICghT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGRhdGEsIGtleSkpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICB2YWwgPSBkYXRhW2tleV07XG4gICAgICBpZiAoYW5ndWxhci5pc09iamVjdCh2YWwpKSB7XG4gICAgICAgIGZsYXRPYmplY3QodmFsLCBwYXRoLmNvbmNhdChrZXkpLCByZXN1bHQsIGtleSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBrZXlXaXRoUGF0aCA9IHBhdGgubGVuZ3RoID8gKCcnICsgcGF0aC5qb2luKCRuZXN0ZWRPYmplY3REZWxpbWV0ZXIpICsgJG5lc3RlZE9iamVjdERlbGltZXRlciArIGtleSkgOiBrZXk7XG4gICAgICAgIGlmIChwYXRoLmxlbmd0aCAmJiBrZXkgPT09IHByZXZLZXkpIHtcbiAgICAgICAgICAvLyBDcmVhdGUgc2hvcnRjdXQgcGF0aCAoZm9vLmJhciA9PSBmb28uYmFyLmJhcilcbiAgICAgICAgICBrZXlXaXRoU2hvcnRQYXRoID0gJycgKyBwYXRoLmpvaW4oJG5lc3RlZE9iamVjdERlbGltZXRlcik7XG4gICAgICAgICAgLy8gTGluayBpdCB0byBvcmlnaW5hbCBwYXRoXG4gICAgICAgICAgcmVzdWx0W2tleVdpdGhTaG9ydFBhdGhdID0gJ0A6JyArIGtleVdpdGhQYXRoO1xuICAgICAgICB9XG4gICAgICAgIHJlc3VsdFtrZXlXaXRoUGF0aF0gPSB2YWw7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH07XG4gIGZsYXRPYmplY3QuZGlzcGxheU5hbWUgPSAnZmxhdE9iamVjdCc7XG5cbiAgLyoqXG4gICAqIEBuZ2RvYyBmdW5jdGlvblxuICAgKiBAbmFtZSBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVQcm92aWRlciNhZGRJbnRlcnBvbGF0aW9uXG4gICAqIEBtZXRob2RPZiBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVQcm92aWRlclxuICAgKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICogQWRkcyBpbnRlcnBvbGF0aW9uIHNlcnZpY2VzIHRvIGFuZ3VsYXItdHJhbnNsYXRlLCBzbyBpdCBjYW4gbWFuYWdlIHRoZW0uXG4gICAqXG4gICAqIEBwYXJhbSB7b2JqZWN0fSBmYWN0b3J5IEludGVycG9sYXRpb24gc2VydmljZSBmYWN0b3J5XG4gICAqL1xuICB0aGlzLmFkZEludGVycG9sYXRpb24gPSBmdW5jdGlvbiAoZmFjdG9yeSkge1xuICAgICRpbnRlcnBvbGF0b3JGYWN0b3JpZXMucHVzaChmYWN0b3J5KTtcbiAgICByZXR1cm4gdGhpcztcbiAgfTtcblxuICAvKipcbiAgICogQG5nZG9jIGZ1bmN0aW9uXG4gICAqIEBuYW1lIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVByb3ZpZGVyI3VzZU1lc3NhZ2VGb3JtYXRJbnRlcnBvbGF0aW9uXG4gICAqIEBtZXRob2RPZiBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVQcm92aWRlclxuICAgKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICogVGVsbHMgYW5ndWxhci10cmFuc2xhdGUgdG8gdXNlIGludGVycG9sYXRpb24gZnVuY3Rpb25hbGl0eSBvZiBtZXNzYWdlZm9ybWF0LmpzLlxuICAgKiBUaGlzIGlzIHVzZWZ1bCB3aGVuIGhhdmluZyBoaWdoIGxldmVsIHBsdXJhbGl6YXRpb24gYW5kIGdlbmRlciBzZWxlY3Rpb24uXG4gICAqL1xuICB0aGlzLnVzZU1lc3NhZ2VGb3JtYXRJbnRlcnBvbGF0aW9uID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiB0aGlzLnVzZUludGVycG9sYXRpb24oJyR0cmFuc2xhdGVNZXNzYWdlRm9ybWF0SW50ZXJwb2xhdGlvbicpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBAbmdkb2MgZnVuY3Rpb25cbiAgICogQG5hbWUgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlUHJvdmlkZXIjdXNlSW50ZXJwb2xhdGlvblxuICAgKiBAbWV0aG9kT2YgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlUHJvdmlkZXJcbiAgICpcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqIFRlbGxzIGFuZ3VsYXItdHJhbnNsYXRlIHdoaWNoIGludGVycG9sYXRpb24gc3R5bGUgdG8gdXNlIGFzIGRlZmF1bHQsIGFwcGxpY2F0aW9uLXdpZGUuXG4gICAqIFNpbXBseSBwYXNzIGEgZmFjdG9yeS9zZXJ2aWNlIG5hbWUuIFRoZSBpbnRlcnBvbGF0aW9uIHNlcnZpY2UgaGFzIHRvIGltcGxlbWVudFxuICAgKiB0aGUgY29ycmVjdCBpbnRlcmZhY2UuXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBmYWN0b3J5IEludGVycG9sYXRpb24gc2VydmljZSBuYW1lLlxuICAgKi9cbiAgdGhpcy51c2VJbnRlcnBvbGF0aW9uID0gZnVuY3Rpb24gKGZhY3RvcnkpIHtcbiAgICAkaW50ZXJwb2xhdGlvbkZhY3RvcnkgPSBmYWN0b3J5O1xuICAgIHJldHVybiB0aGlzO1xuICB9O1xuXG4gIC8qKlxuICAgKiBAbmdkb2MgZnVuY3Rpb25cbiAgICogQG5hbWUgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlUHJvdmlkZXIjdXNlU2FuaXRpemVTdHJhdGVneVxuICAgKiBAbWV0aG9kT2YgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlUHJvdmlkZXJcbiAgICpcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqIFNpbXBseSBzZXRzIGEgc2FuaXRhdGlvbiBzdHJhdGVneSB0eXBlLlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUgU3RyYXRlZ3kgdHlwZS5cbiAgICovXG4gIHRoaXMudXNlU2FuaXRpemVWYWx1ZVN0cmF0ZWd5ID0gZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgJHRyYW5zbGF0ZVNhbml0aXphdGlvblByb3ZpZGVyLnVzZVN0cmF0ZWd5KHZhbHVlKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfTtcblxuICAvKipcbiAgICogQG5nZG9jIGZ1bmN0aW9uXG4gICAqIEBuYW1lIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVByb3ZpZGVyI3ByZWZlcnJlZExhbmd1YWdlXG4gICAqIEBtZXRob2RPZiBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVQcm92aWRlclxuICAgKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICogVGVsbHMgdGhlIG1vZHVsZSB3aGljaCBvZiB0aGUgcmVnaXN0ZXJlZCB0cmFuc2xhdGlvbiB0YWJsZXMgdG8gdXNlIGZvciB0cmFuc2xhdGlvblxuICAgKiBhdCBpbml0aWFsIHN0YXJ0dXAgYnkgcGFzc2luZyBhIGxhbmd1YWdlIGtleS4gU2ltaWxhciB0byBgJHRyYW5zbGF0ZVByb3ZpZGVyI3VzZWBcbiAgICogb25seSB0aGF0IGl0IHNheXMgd2hpY2ggbGFuZ3VhZ2UgdG8gKipwcmVmZXIqKi5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IGxhbmdLZXkgQSBsYW5ndWFnZSBrZXkuXG4gICAqL1xuICB0aGlzLnByZWZlcnJlZExhbmd1YWdlID0gZnVuY3Rpb24gKGxhbmdLZXkpIHtcbiAgICBpZiAobGFuZ0tleSkge1xuICAgICAgc2V0dXBQcmVmZXJyZWRMYW5ndWFnZShsYW5nS2V5KTtcbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cbiAgICByZXR1cm4gJHByZWZlcnJlZExhbmd1YWdlO1xuICB9O1xuICB2YXIgc2V0dXBQcmVmZXJyZWRMYW5ndWFnZSA9IGZ1bmN0aW9uIChsYW5nS2V5KSB7XG4gICAgaWYgKGxhbmdLZXkpIHtcbiAgICAgICRwcmVmZXJyZWRMYW5ndWFnZSA9IGxhbmdLZXk7XG4gICAgfVxuICAgIHJldHVybiAkcHJlZmVycmVkTGFuZ3VhZ2U7XG4gIH07XG4gIC8qKlxuICAgKiBAbmdkb2MgZnVuY3Rpb25cbiAgICogQG5hbWUgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlUHJvdmlkZXIjdHJhbnNsYXRpb25Ob3RGb3VuZEluZGljYXRvclxuICAgKiBAbWV0aG9kT2YgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlUHJvdmlkZXJcbiAgICpcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqIFNldHMgYW4gaW5kaWNhdG9yIHdoaWNoIGlzIHVzZWQgd2hlbiBhIHRyYW5zbGF0aW9uIGlzbid0IGZvdW5kLiBFLmcuIHdoZW5cbiAgICogc2V0dGluZyB0aGUgaW5kaWNhdG9yIGFzICdYJyBhbmQgb25lIHRyaWVzIHRvIHRyYW5zbGF0ZSBhIHRyYW5zbGF0aW9uIGlkXG4gICAqIGNhbGxlZCBgTk9UX0ZPVU5EYCwgdGhpcyB3aWxsIHJlc3VsdCBpbiBgWCBOT1RfRk9VTkQgWGAuXG4gICAqXG4gICAqIEludGVybmFsbHkgdGhpcyBtZXRob2RzIHNldHMgYSBsZWZ0IGluZGljYXRvciBhbmQgYSByaWdodCBpbmRpY2F0b3IgdXNpbmdcbiAgICogYCR0cmFuc2xhdGVQcm92aWRlci50cmFuc2xhdGlvbk5vdEZvdW5kSW5kaWNhdG9yTGVmdCgpYCBhbmRcbiAgICogYCR0cmFuc2xhdGVQcm92aWRlci50cmFuc2xhdGlvbk5vdEZvdW5kSW5kaWNhdG9yUmlnaHQoKWAuXG4gICAqXG4gICAqICoqTm90ZSoqOiBUaGVzZSBtZXRob2RzIGF1dG9tYXRpY2FsbHkgYWRkIGEgd2hpdGVzcGFjZSBiZXR3ZWVuIHRoZSBpbmRpY2F0b3JzXG4gICAqIGFuZCB0aGUgdHJhbnNsYXRpb24gaWQuXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBpbmRpY2F0b3IgQW4gaW5kaWNhdG9yLCBjb3VsZCBiZSBhbnkgc3RyaW5nLlxuICAgKi9cbiAgdGhpcy50cmFuc2xhdGlvbk5vdEZvdW5kSW5kaWNhdG9yID0gZnVuY3Rpb24gKGluZGljYXRvcikge1xuICAgIHRoaXMudHJhbnNsYXRpb25Ob3RGb3VuZEluZGljYXRvckxlZnQoaW5kaWNhdG9yKTtcbiAgICB0aGlzLnRyYW5zbGF0aW9uTm90Rm91bmRJbmRpY2F0b3JSaWdodChpbmRpY2F0b3IpO1xuICAgIHJldHVybiB0aGlzO1xuICB9O1xuXG4gIC8qKlxuICAgKiBuZ2RvYyBmdW5jdGlvblxuICAgKiBAbmFtZSBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVQcm92aWRlciN0cmFuc2xhdGlvbk5vdEZvdW5kSW5kaWNhdG9yTGVmdFxuICAgKiBAbWV0aG9kT2YgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlUHJvdmlkZXJcbiAgICpcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqIFNldHMgYW4gaW5kaWNhdG9yIHdoaWNoIGlzIHVzZWQgd2hlbiBhIHRyYW5zbGF0aW9uIGlzbid0IGZvdW5kIGxlZnQgdG8gdGhlXG4gICAqIHRyYW5zbGF0aW9uIGlkLlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gaW5kaWNhdG9yIEFuIGluZGljYXRvci5cbiAgICovXG4gIHRoaXMudHJhbnNsYXRpb25Ob3RGb3VuZEluZGljYXRvckxlZnQgPSBmdW5jdGlvbiAoaW5kaWNhdG9yKSB7XG4gICAgaWYgKCFpbmRpY2F0b3IpIHtcbiAgICAgIHJldHVybiAkbm90Rm91bmRJbmRpY2F0b3JMZWZ0O1xuICAgIH1cbiAgICAkbm90Rm91bmRJbmRpY2F0b3JMZWZ0ID0gaW5kaWNhdG9yO1xuICAgIHJldHVybiB0aGlzO1xuICB9O1xuXG4gIC8qKlxuICAgKiBuZ2RvYyBmdW5jdGlvblxuICAgKiBAbmFtZSBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVQcm92aWRlciN0cmFuc2xhdGlvbk5vdEZvdW5kSW5kaWNhdG9yTGVmdFxuICAgKiBAbWV0aG9kT2YgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlUHJvdmlkZXJcbiAgICpcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqIFNldHMgYW4gaW5kaWNhdG9yIHdoaWNoIGlzIHVzZWQgd2hlbiBhIHRyYW5zbGF0aW9uIGlzbid0IGZvdW5kIHJpZ2h0IHRvIHRoZVxuICAgKiB0cmFuc2xhdGlvbiBpZC5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IGluZGljYXRvciBBbiBpbmRpY2F0b3IuXG4gICAqL1xuICB0aGlzLnRyYW5zbGF0aW9uTm90Rm91bmRJbmRpY2F0b3JSaWdodCA9IGZ1bmN0aW9uIChpbmRpY2F0b3IpIHtcbiAgICBpZiAoIWluZGljYXRvcikge1xuICAgICAgcmV0dXJuICRub3RGb3VuZEluZGljYXRvclJpZ2h0O1xuICAgIH1cbiAgICAkbm90Rm91bmRJbmRpY2F0b3JSaWdodCA9IGluZGljYXRvcjtcbiAgICByZXR1cm4gdGhpcztcbiAgfTtcblxuICAvKipcbiAgICogQG5nZG9jIGZ1bmN0aW9uXG4gICAqIEBuYW1lIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVByb3ZpZGVyI2ZhbGxiYWNrTGFuZ3VhZ2VcbiAgICogQG1ldGhvZE9mIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVByb3ZpZGVyXG4gICAqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKiBUZWxscyB0aGUgbW9kdWxlIHdoaWNoIG9mIHRoZSByZWdpc3RlcmVkIHRyYW5zbGF0aW9uIHRhYmxlcyB0byB1c2Ugd2hlbiBtaXNzaW5nIHRyYW5zbGF0aW9uc1xuICAgKiBhdCBpbml0aWFsIHN0YXJ0dXAgYnkgcGFzc2luZyBhIGxhbmd1YWdlIGtleS4gU2ltaWxhciB0byBgJHRyYW5zbGF0ZVByb3ZpZGVyI3VzZWBcbiAgICogb25seSB0aGF0IGl0IHNheXMgd2hpY2ggbGFuZ3VhZ2UgdG8gKipmYWxsYmFjayoqLlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ3x8YXJyYXl9IGxhbmdLZXkgQSBsYW5ndWFnZSBrZXkuXG4gICAqXG4gICAqL1xuICB0aGlzLmZhbGxiYWNrTGFuZ3VhZ2UgPSBmdW5jdGlvbiAobGFuZ0tleSkge1xuICAgIGZhbGxiYWNrU3RhY2sobGFuZ0tleSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH07XG5cbiAgdmFyIGZhbGxiYWNrU3RhY2sgPSBmdW5jdGlvbiAobGFuZ0tleSkge1xuICAgIGlmIChsYW5nS2V5KSB7XG4gICAgICBpZiAoYW5ndWxhci5pc1N0cmluZyhsYW5nS2V5KSkge1xuICAgICAgICAkZmFsbGJhY2tXYXNTdHJpbmcgPSB0cnVlO1xuICAgICAgICAkZmFsbGJhY2tMYW5ndWFnZSA9IFtsYW5nS2V5XTtcbiAgICAgIH0gZWxzZSBpZiAoYW5ndWxhci5pc0FycmF5KGxhbmdLZXkpKSB7XG4gICAgICAgICRmYWxsYmFja1dhc1N0cmluZyA9IGZhbHNlO1xuICAgICAgICAkZmFsbGJhY2tMYW5ndWFnZSA9IGxhbmdLZXk7XG4gICAgICB9XG4gICAgICBpZiAoYW5ndWxhci5pc1N0cmluZygkcHJlZmVycmVkTGFuZ3VhZ2UpICYmIGluZGV4T2YoJGZhbGxiYWNrTGFuZ3VhZ2UsICRwcmVmZXJyZWRMYW5ndWFnZSkgPCAwKSB7XG4gICAgICAgICRmYWxsYmFja0xhbmd1YWdlLnB1c2goJHByZWZlcnJlZExhbmd1YWdlKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICgkZmFsbGJhY2tXYXNTdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuICRmYWxsYmFja0xhbmd1YWdlWzBdO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuICRmYWxsYmFja0xhbmd1YWdlO1xuICAgICAgfVxuICAgIH1cbiAgfTtcblxuICAvKipcbiAgICogQG5nZG9jIGZ1bmN0aW9uXG4gICAqIEBuYW1lIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVByb3ZpZGVyI3VzZVxuICAgKiBAbWV0aG9kT2YgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlUHJvdmlkZXJcbiAgICpcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqIFNldCB3aGljaCB0cmFuc2xhdGlvbiB0YWJsZSB0byB1c2UgZm9yIHRyYW5zbGF0aW9uIGJ5IGdpdmVuIGxhbmd1YWdlIGtleS4gV2hlblxuICAgKiB0cnlpbmcgdG8gJ3VzZScgYSBsYW5ndWFnZSB3aGljaCBpc24ndCBwcm92aWRlZCwgaXQnbGwgdGhyb3cgYW4gZXJyb3IuXG4gICAqXG4gICAqIFlvdSBhY3R1YWxseSBkb24ndCBoYXZlIHRvIHVzZSB0aGlzIG1ldGhvZCBzaW5jZSBgJHRyYW5zbGF0ZVByb3ZpZGVyI3ByZWZlcnJlZExhbmd1YWdlYFxuICAgKiBkb2VzIHRoZSBqb2IgdG9vLlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gbGFuZ0tleSBBIGxhbmd1YWdlIGtleS5cbiAgICovXG4gIHRoaXMudXNlID0gZnVuY3Rpb24gKGxhbmdLZXkpIHtcbiAgICBpZiAobGFuZ0tleSkge1xuICAgICAgaWYgKCEkdHJhbnNsYXRpb25UYWJsZVtsYW5nS2V5XSAmJiAoISRsb2FkZXJGYWN0b3J5KSkge1xuICAgICAgICAvLyBvbmx5IHRocm93IGFuIGVycm9yLCB3aGVuIG5vdCBsb2FkaW5nIHRyYW5zbGF0aW9uIGRhdGEgYXN5bmNocm9ub3VzbHlcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCckdHJhbnNsYXRlUHJvdmlkZXIgY291bGRuXFwndCBmaW5kIHRyYW5zbGF0aW9uVGFibGUgZm9yIGxhbmdLZXk6IFxcJycgKyBsYW5nS2V5ICsgJ1xcJycpO1xuICAgICAgfVxuICAgICAgJHVzZXMgPSBsYW5nS2V5O1xuICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuICAgIHJldHVybiAkdXNlcztcbiAgfTtcblxuICAvKipcbiAgICogQG5nZG9jIGZ1bmN0aW9uXG4gICAqIEBuYW1lIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVByb3ZpZGVyI3Jlc29sdmVDbGllbnRMb2NhbGVcbiAgICogQG1ldGhvZE9mIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVByb3ZpZGVyXG4gICAqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKiBUaGlzIHJldHVybnMgdGhlIGN1cnJlbnQgYnJvd3Nlci9jbGllbnQncyBsYW5ndWFnZSBrZXkuIFRoZSByZXN1bHQgaXMgcHJvY2Vzc2VkIHdpdGggdGhlIGNvbmZpZ3VyZWQgdW5pZm9ybSB0YWcgcmVzb2x2ZXIuXG4gICAqXG4gICAqIEByZXR1cm5zIHtzdHJpbmd9IHRoZSBjdXJyZW50IGNsaWVudC9icm93c2VyIGxhbmd1YWdlIGtleVxuICAgKi9cbiAgdGhpcy5yZXNvbHZlQ2xpZW50TG9jYWxlID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBnZXRMb2NhbGUoKTtcbiAgfTtcblxuICAvKipcbiAgICogQG5nZG9jIGZ1bmN0aW9uXG4gICAqIEBuYW1lIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVByb3ZpZGVyI3N0b3JhZ2VLZXlcbiAgICogQG1ldGhvZE9mIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVByb3ZpZGVyXG4gICAqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKiBUZWxscyB0aGUgbW9kdWxlIHdoaWNoIGtleSBtdXN0IHJlcHJlc2VudCB0aGUgY2hvb3NlZCBsYW5ndWFnZSBieSBhIHVzZXIgaW4gdGhlIHN0b3JhZ2UuXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgQSBrZXkgZm9yIHRoZSBzdG9yYWdlLlxuICAgKi9cbiAgdmFyIHN0b3JhZ2VLZXkgPSBmdW5jdGlvbiAoa2V5KSB7XG4gICAgaWYgKCFrZXkpIHtcbiAgICAgIGlmICgkc3RvcmFnZVByZWZpeCkge1xuICAgICAgICByZXR1cm4gJHN0b3JhZ2VQcmVmaXggKyAkc3RvcmFnZUtleTtcbiAgICAgIH1cbiAgICAgIHJldHVybiAkc3RvcmFnZUtleTtcbiAgICB9XG4gICAgJHN0b3JhZ2VLZXkgPSBrZXk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH07XG5cbiAgdGhpcy5zdG9yYWdlS2V5ID0gc3RvcmFnZUtleTtcblxuICAvKipcbiAgICogQG5nZG9jIGZ1bmN0aW9uXG4gICAqIEBuYW1lIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVByb3ZpZGVyI3VzZVVybExvYWRlclxuICAgKiBAbWV0aG9kT2YgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlUHJvdmlkZXJcbiAgICpcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqIFRlbGxzIGFuZ3VsYXItdHJhbnNsYXRlIHRvIHVzZSBgJHRyYW5zbGF0ZVVybExvYWRlcmAgZXh0ZW5zaW9uIHNlcnZpY2UgYXMgbG9hZGVyLlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFVybFxuICAgKiBAcGFyYW0ge09iamVjdD19IG9wdGlvbnMgT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvYmplY3RcbiAgICovXG4gIHRoaXMudXNlVXJsTG9hZGVyID0gZnVuY3Rpb24gKHVybCwgb3B0aW9ucykge1xuICAgIHJldHVybiB0aGlzLnVzZUxvYWRlcignJHRyYW5zbGF0ZVVybExvYWRlcicsIGFuZ3VsYXIuZXh0ZW5kKHt1cmwgOiB1cmx9LCBvcHRpb25zKSk7XG4gIH07XG5cbiAgLyoqXG4gICAqIEBuZ2RvYyBmdW5jdGlvblxuICAgKiBAbmFtZSBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVQcm92aWRlciN1c2VTdGF0aWNGaWxlc0xvYWRlclxuICAgKiBAbWV0aG9kT2YgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlUHJvdmlkZXJcbiAgICpcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqIFRlbGxzIGFuZ3VsYXItdHJhbnNsYXRlIHRvIHVzZSBgJHRyYW5zbGF0ZVN0YXRpY0ZpbGVzTG9hZGVyYCBleHRlbnNpb24gc2VydmljZSBhcyBsb2FkZXIuXG4gICAqXG4gICAqIEBwYXJhbSB7T2JqZWN0PX0gb3B0aW9ucyBPcHRpb25hbCBjb25maWd1cmF0aW9uIG9iamVjdFxuICAgKi9cbiAgdGhpcy51c2VTdGF0aWNGaWxlc0xvYWRlciA9IGZ1bmN0aW9uIChvcHRpb25zKSB7XG4gICAgcmV0dXJuIHRoaXMudXNlTG9hZGVyKCckdHJhbnNsYXRlU3RhdGljRmlsZXNMb2FkZXInLCBvcHRpb25zKTtcbiAgfTtcblxuICAvKipcbiAgICogQG5nZG9jIGZ1bmN0aW9uXG4gICAqIEBuYW1lIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVByb3ZpZGVyI3VzZUxvYWRlclxuICAgKiBAbWV0aG9kT2YgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlUHJvdmlkZXJcbiAgICpcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqIFRlbGxzIGFuZ3VsYXItdHJhbnNsYXRlIHRvIHVzZSBhbnkgb3RoZXIgc2VydmljZSBhcyBsb2FkZXIuXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBsb2FkZXJGYWN0b3J5IEZhY3RvcnkgbmFtZSB0byB1c2VcbiAgICogQHBhcmFtIHtPYmplY3Q9fSBvcHRpb25zIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0XG4gICAqL1xuICB0aGlzLnVzZUxvYWRlciA9IGZ1bmN0aW9uIChsb2FkZXJGYWN0b3J5LCBvcHRpb25zKSB7XG4gICAgJGxvYWRlckZhY3RvcnkgPSBsb2FkZXJGYWN0b3J5O1xuICAgICRsb2FkZXJPcHRpb25zID0gb3B0aW9ucyB8fCB7fTtcbiAgICByZXR1cm4gdGhpcztcbiAgfTtcblxuICAvKipcbiAgICogQG5nZG9jIGZ1bmN0aW9uXG4gICAqIEBuYW1lIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVByb3ZpZGVyI3VzZUxvY2FsU3RvcmFnZVxuICAgKiBAbWV0aG9kT2YgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlUHJvdmlkZXJcbiAgICpcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqIFRlbGxzIGFuZ3VsYXItdHJhbnNsYXRlIHRvIHVzZSBgJHRyYW5zbGF0ZUxvY2FsU3RvcmFnZWAgc2VydmljZSBhcyBzdG9yYWdlIGxheWVyLlxuICAgKlxuICAgKi9cbiAgdGhpcy51c2VMb2NhbFN0b3JhZ2UgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIHRoaXMudXNlU3RvcmFnZSgnJHRyYW5zbGF0ZUxvY2FsU3RvcmFnZScpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBAbmdkb2MgZnVuY3Rpb25cbiAgICogQG5hbWUgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlUHJvdmlkZXIjdXNlQ29va2llU3RvcmFnZVxuICAgKiBAbWV0aG9kT2YgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlUHJvdmlkZXJcbiAgICpcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqIFRlbGxzIGFuZ3VsYXItdHJhbnNsYXRlIHRvIHVzZSBgJHRyYW5zbGF0ZUNvb2tpZVN0b3JhZ2VgIHNlcnZpY2UgYXMgc3RvcmFnZSBsYXllci5cbiAgICovXG4gIHRoaXMudXNlQ29va2llU3RvcmFnZSA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gdGhpcy51c2VTdG9yYWdlKCckdHJhbnNsYXRlQ29va2llU3RvcmFnZScpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBAbmdkb2MgZnVuY3Rpb25cbiAgICogQG5hbWUgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlUHJvdmlkZXIjdXNlU3RvcmFnZVxuICAgKiBAbWV0aG9kT2YgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlUHJvdmlkZXJcbiAgICpcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqIFRlbGxzIGFuZ3VsYXItdHJhbnNsYXRlIHRvIHVzZSBjdXN0b20gc2VydmljZSBhcyBzdG9yYWdlIGxheWVyLlxuICAgKi9cbiAgdGhpcy51c2VTdG9yYWdlID0gZnVuY3Rpb24gKHN0b3JhZ2VGYWN0b3J5KSB7XG4gICAgJHN0b3JhZ2VGYWN0b3J5ID0gc3RvcmFnZUZhY3Rvcnk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH07XG5cbiAgLyoqXG4gICAqIEBuZ2RvYyBmdW5jdGlvblxuICAgKiBAbmFtZSBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVQcm92aWRlciNzdG9yYWdlUHJlZml4XG4gICAqIEBtZXRob2RPZiBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVQcm92aWRlclxuICAgKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICogU2V0cyBwcmVmaXggZm9yIHN0b3JhZ2Uga2V5LlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gcHJlZml4IFN0b3JhZ2Uga2V5IHByZWZpeFxuICAgKi9cbiAgdGhpcy5zdG9yYWdlUHJlZml4ID0gZnVuY3Rpb24gKHByZWZpeCkge1xuICAgIGlmICghcHJlZml4KSB7XG4gICAgICByZXR1cm4gcHJlZml4O1xuICAgIH1cbiAgICAkc3RvcmFnZVByZWZpeCA9IHByZWZpeDtcbiAgICByZXR1cm4gdGhpcztcbiAgfTtcblxuICAvKipcbiAgICogQG5nZG9jIGZ1bmN0aW9uXG4gICAqIEBuYW1lIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVByb3ZpZGVyI3VzZU1pc3NpbmdUcmFuc2xhdGlvbkhhbmRsZXJMb2dcbiAgICogQG1ldGhvZE9mIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVByb3ZpZGVyXG4gICAqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKiBUZWxscyBhbmd1bGFyLXRyYW5zbGF0ZSB0byB1c2UgYnVpbHQtaW4gbG9nIGhhbmRsZXIgd2hlbiB0cnlpbmcgdG8gdHJhbnNsYXRlXG4gICAqIGEgdHJhbnNsYXRpb24gSWQgd2hpY2ggZG9lc24ndCBleGlzdC5cbiAgICpcbiAgICogVGhpcyBpcyBhY3R1YWxseSBhIHNob3J0Y3V0IG1ldGhvZCBmb3IgYHVzZU1pc3NpbmdUcmFuc2xhdGlvbkhhbmRsZXIoKWAuXG4gICAqXG4gICAqL1xuICB0aGlzLnVzZU1pc3NpbmdUcmFuc2xhdGlvbkhhbmRsZXJMb2cgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIHRoaXMudXNlTWlzc2luZ1RyYW5zbGF0aW9uSGFuZGxlcignJHRyYW5zbGF0ZU1pc3NpbmdUcmFuc2xhdGlvbkhhbmRsZXJMb2cnKTtcbiAgfTtcblxuICAvKipcbiAgICogQG5nZG9jIGZ1bmN0aW9uXG4gICAqIEBuYW1lIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVByb3ZpZGVyI3VzZU1pc3NpbmdUcmFuc2xhdGlvbkhhbmRsZXJcbiAgICogQG1ldGhvZE9mIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVByb3ZpZGVyXG4gICAqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKiBFeHBlY3RzIGEgZmFjdG9yeSBuYW1lIHdoaWNoIGxhdGVyIGdldHMgaW5zdGFudGlhdGVkIHdpdGggYCRpbmplY3RvcmAuXG4gICAqIFRoaXMgbWV0aG9kIGNhbiBiZSB1c2VkIHRvIHRlbGwgYW5ndWxhci10cmFuc2xhdGUgdG8gdXNlIGEgY3VzdG9tXG4gICAqIG1pc3NpbmdUcmFuc2xhdGlvbkhhbmRsZXIuIEp1c3QgYnVpbGQgYSBmYWN0b3J5IHdoaWNoIHJldHVybnMgYSBmdW5jdGlvblxuICAgKiBhbmQgZXhwZWN0cyBhIHRyYW5zbGF0aW9uIGlkIGFzIGFyZ3VtZW50LlxuICAgKlxuICAgKiBFeGFtcGxlOlxuICAgKiA8cHJlPlxuICAgKiAgYXBwLmNvbmZpZyhmdW5jdGlvbiAoJHRyYW5zbGF0ZVByb3ZpZGVyKSB7XG4gICAqICAgICR0cmFuc2xhdGVQcm92aWRlci51c2VNaXNzaW5nVHJhbnNsYXRpb25IYW5kbGVyKCdjdXN0b21IYW5kbGVyJyk7XG4gICAqICB9KTtcbiAgICpcbiAgICogIGFwcC5mYWN0b3J5KCdjdXN0b21IYW5kbGVyJywgZnVuY3Rpb24gKGRlcDEsIGRlcDIpIHtcbiAgICogICAgcmV0dXJuIGZ1bmN0aW9uICh0cmFuc2xhdGlvbklkKSB7XG4gICAqICAgICAgLy8gc29tZXRoaW5nIHdpdGggdHJhbnNsYXRpb25JZCBhbmQgZGVwMSBhbmQgZGVwMlxuICAgKiAgICB9O1xuICAgKiAgfSk7XG4gICAqIDwvcHJlPlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gZmFjdG9yeSBGYWN0b3J5IG5hbWVcbiAgICovXG4gIHRoaXMudXNlTWlzc2luZ1RyYW5zbGF0aW9uSGFuZGxlciA9IGZ1bmN0aW9uIChmYWN0b3J5KSB7XG4gICAgJG1pc3NpbmdUcmFuc2xhdGlvbkhhbmRsZXJGYWN0b3J5ID0gZmFjdG9yeTtcbiAgICByZXR1cm4gdGhpcztcbiAgfTtcblxuICAvKipcbiAgICogQG5nZG9jIGZ1bmN0aW9uXG4gICAqIEBuYW1lIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVByb3ZpZGVyI3VzZVBvc3RDb21waWxpbmdcbiAgICogQG1ldGhvZE9mIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVByb3ZpZGVyXG4gICAqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKiBJZiBwb3N0IGNvbXBpbGluZyBpcyBlbmFibGVkLCBhbGwgdHJhbnNsYXRlZCB2YWx1ZXMgd2lsbCBiZSBwcm9jZXNzZWRcbiAgICogYWdhaW4gd2l0aCBBbmd1bGFySlMnICRjb21waWxlLlxuICAgKlxuICAgKiBFeGFtcGxlOlxuICAgKiA8cHJlPlxuICAgKiAgYXBwLmNvbmZpZyhmdW5jdGlvbiAoJHRyYW5zbGF0ZVByb3ZpZGVyKSB7XG4gICAqICAgICR0cmFuc2xhdGVQcm92aWRlci51c2VQb3N0Q29tcGlsaW5nKHRydWUpO1xuICAgKiAgfSk7XG4gICAqIDwvcHJlPlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gZmFjdG9yeSBGYWN0b3J5IG5hbWVcbiAgICovXG4gIHRoaXMudXNlUG9zdENvbXBpbGluZyA9IGZ1bmN0aW9uICh2YWx1ZSkge1xuICAgICRwb3N0Q29tcGlsaW5nRW5hYmxlZCA9ICEoIXZhbHVlKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfTtcblxuICAvKipcbiAgICogQG5nZG9jIGZ1bmN0aW9uXG4gICAqIEBuYW1lIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVByb3ZpZGVyI2ZvcmNlQXN5bmNSZWxvYWRcbiAgICogQG1ldGhvZE9mIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVByb3ZpZGVyXG4gICAqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKiBJZiBmb3JjZSBhc3luYyByZWxvYWQgaXMgZW5hYmxlZCwgYXN5bmMgbG9hZGVyIHdpbGwgYWx3YXlzIGJlIGNhbGxlZFxuICAgKiBldmVuIGlmICR0cmFuc2xhdGlvblRhYmxlIGFscmVhZHkgY29udGFpbnMgdGhlIGxhbmd1YWdlIGtleSwgYWRkaW5nXG4gICAqIHBvc3NpYmxlIG5ldyBlbnRyaWVzIHRvIHRoZSAkdHJhbnNsYXRpb25UYWJsZS5cbiAgICpcbiAgICogRXhhbXBsZTpcbiAgICogPHByZT5cbiAgICogIGFwcC5jb25maWcoZnVuY3Rpb24gKCR0cmFuc2xhdGVQcm92aWRlcikge1xuICAgKiAgICAkdHJhbnNsYXRlUHJvdmlkZXIuZm9yY2VBc3luY1JlbG9hZCh0cnVlKTtcbiAgICogIH0pO1xuICAgKiA8L3ByZT5cbiAgICpcbiAgICogQHBhcmFtIHtib29sZWFufSB2YWx1ZSAtIHZhbGlkIHZhbHVlcyBhcmUgdHJ1ZSBvciBmYWxzZVxuICAgKi9cbiAgdGhpcy5mb3JjZUFzeW5jUmVsb2FkID0gZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgJGZvcmNlQXN5bmNSZWxvYWRFbmFibGVkID0gISghdmFsdWUpO1xuICAgIHJldHVybiB0aGlzO1xuICB9O1xuXG4gIC8qKlxuICAgKiBAbmdkb2MgZnVuY3Rpb25cbiAgICogQG5hbWUgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlUHJvdmlkZXIjdW5pZm9ybUxhbmd1YWdlVGFnXG4gICAqIEBtZXRob2RPZiBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVQcm92aWRlclxuICAgKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICogVGVsbHMgYW5ndWxhci10cmFuc2xhdGUgd2hpY2ggbGFuZ3VhZ2UgdGFnIHNob3VsZCBiZSB1c2VkIGFzIGEgcmVzdWx0IHdoZW4gZGV0ZXJtaW5pbmdcbiAgICogdGhlIGN1cnJlbnQgYnJvd3NlciBsYW5ndWFnZS5cbiAgICpcbiAgICogVGhpcyBzZXR0aW5nIG11c3QgYmUgc2V0IGJlZm9yZSBpbnZva2luZyB7QGxpbmsgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlUHJvdmlkZXIjbWV0aG9kc19kZXRlcm1pbmVQcmVmZXJyZWRMYW5ndWFnZSBkZXRlcm1pbmVQcmVmZXJyZWRMYW5ndWFnZSgpfS5cbiAgICpcbiAgICogPHByZT5cbiAgICogJHRyYW5zbGF0ZVByb3ZpZGVyXG4gICAqICAgLnVuaWZvcm1MYW5ndWFnZVRhZygnYmNwNDcnKVxuICAgKiAgIC5kZXRlcm1pbmVQcmVmZXJyZWRMYW5ndWFnZSgpXG4gICAqIDwvcHJlPlxuICAgKlxuICAgKiBUaGUgcmVzb2x2ZXIgY3VycmVudGx5IHN1cHBvcnRzOlxuICAgKiAqIGRlZmF1bHRcbiAgICogICAgICh0cmFkaXRpb25hbGx5OiBoeXBoZW5zIHdpbGwgYmUgY29udmVydGVkIGludG8gdW5kZXJzY29yZXMsIGkuZS4gZW4tVVMgPT4gZW5fVVMpXG4gICAqICAgICBlbi1VUyA9PiBlbl9VU1xuICAgKiAgICAgZW5fVVMgPT4gZW5fVVNcbiAgICogICAgIGVuLXVzID0+IGVuX3VzXG4gICAqICogamF2YVxuICAgKiAgICAgbGlrZSBkZWZhdWx0LCBidXQgdGhlIHNlY29uZCBwYXJ0IHdpbGwgYmUgYWx3YXlzIGluIHVwcGVyY2FzZVxuICAgKiAgICAgZW4tVVMgPT4gZW5fVVNcbiAgICogICAgIGVuX1VTID0+IGVuX1VTXG4gICAqICAgICBlbi11cyA9PiBlbl9VU1xuICAgKiAqIEJDUCA0NyAoUkZDIDQ2NDYgJiA0NjQ3KVxuICAgKiAgICAgZW4tVVMgPT4gZW4tVVNcbiAgICogICAgIGVuX1VTID0+IGVuLVVTXG4gICAqICAgICBlbi11cyA9PiBlbi1VU1xuICAgKlxuICAgKiBTZWUgYWxzbzpcbiAgICogKiBodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0lFVEZfbGFuZ3VhZ2VfdGFnXG4gICAqICogaHR0cDovL3d3dy53My5vcmcvSW50ZXJuYXRpb25hbC9jb3JlL2xhbmd0YWdzL1xuICAgKiAqIGh0dHA6Ly90b29scy5pZXRmLm9yZy9odG1sL2JjcDQ3XG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfG9iamVjdH0gb3B0aW9ucyAtIG9wdGlvbnMgKG9yIHN0YW5kYXJkKVxuICAgKiBAcGFyYW0ge3N0cmluZ30gb3B0aW9ucy5zdGFuZGFyZCAtIHZhbGlkIHZhbHVlcyBhcmUgJ2RlZmF1bHQnLCAnYmNwNDcnLCAnamF2YSdcbiAgICovXG4gIHRoaXMudW5pZm9ybUxhbmd1YWdlVGFnID0gZnVuY3Rpb24gKG9wdGlvbnMpIHtcblxuICAgIGlmICghb3B0aW9ucykge1xuICAgICAgb3B0aW9ucyA9IHt9O1xuICAgIH0gZWxzZSBpZiAoYW5ndWxhci5pc1N0cmluZyhvcHRpb25zKSkge1xuICAgICAgb3B0aW9ucyA9IHtcbiAgICAgICAgc3RhbmRhcmQgOiBvcHRpb25zXG4gICAgICB9O1xuICAgIH1cblxuICAgIHVuaWZvcm1MYW5ndWFnZVRhZ1Jlc29sdmVyID0gb3B0aW9ucy5zdGFuZGFyZDtcblxuICAgIHJldHVybiB0aGlzO1xuICB9O1xuXG4gIC8qKlxuICAgKiBAbmdkb2MgZnVuY3Rpb25cbiAgICogQG5hbWUgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlUHJvdmlkZXIjZGV0ZXJtaW5lUHJlZmVycmVkTGFuZ3VhZ2VcbiAgICogQG1ldGhvZE9mIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVByb3ZpZGVyXG4gICAqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKiBUZWxscyBhbmd1bGFyLXRyYW5zbGF0ZSB0byB0cnkgdG8gZGV0ZXJtaW5lIG9uIGl0cyBvd24gd2hpY2ggbGFuZ3VhZ2Uga2V5XG4gICAqIHRvIHNldCBhcyBwcmVmZXJyZWQgbGFuZ3VhZ2UuIFdoZW4gYGZuYCBpcyBnaXZlbiwgYW5ndWxhci10cmFuc2xhdGUgdXNlcyBpdFxuICAgKiB0byBkZXRlcm1pbmUgYSBsYW5ndWFnZSBrZXksIG90aGVyd2lzZSBpdCB1c2VzIHRoZSBidWlsdC1pbiBgZ2V0TG9jYWxlKClgXG4gICAqIG1ldGhvZC5cbiAgICpcbiAgICogVGhlIGBnZXRMb2NhbGUoKWAgcmV0dXJucyBhIGxhbmd1YWdlIGtleSBpbiB0aGUgZm9ybWF0IGBbbGFuZ11fW2NvdW50cnldYCBvclxuICAgKiBgW2xhbmddYCBkZXBlbmRpbmcgb24gd2hhdCB0aGUgYnJvd3NlciBwcm92aWRlcy5cbiAgICpcbiAgICogVXNlIHRoaXMgbWV0aG9kIGF0IHlvdXIgb3duIHJpc2ssIHNpbmNlIG5vdCBhbGwgYnJvd3NlcnMgcmV0dXJuIGEgdmFsaWRcbiAgICogbG9jYWxlIChzZWUge0BsaW5rIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVByb3ZpZGVyI21ldGhvZHNfdW5pZm9ybUxhbmd1YWdlVGFnIHVuaWZvcm1MYW5ndWFnZVRhZygpfSkuXG4gICAqXG4gICAqIEBwYXJhbSB7RnVuY3Rpb249fSBmbiBGdW5jdGlvbiB0byBkZXRlcm1pbmUgYSBicm93c2VyJ3MgbG9jYWxlXG4gICAqL1xuICB0aGlzLmRldGVybWluZVByZWZlcnJlZExhbmd1YWdlID0gZnVuY3Rpb24gKGZuKSB7XG5cbiAgICB2YXIgbG9jYWxlID0gKGZuICYmIGFuZ3VsYXIuaXNGdW5jdGlvbihmbikpID8gZm4oKSA6IGdldExvY2FsZSgpO1xuXG4gICAgaWYgKCEkYXZhaWxhYmxlTGFuZ3VhZ2VLZXlzLmxlbmd0aCkge1xuICAgICAgJHByZWZlcnJlZExhbmd1YWdlID0gbG9jYWxlO1xuICAgIH0gZWxzZSB7XG4gICAgICAkcHJlZmVycmVkTGFuZ3VhZ2UgPSBuZWdvdGlhdGVMb2NhbGUobG9jYWxlKSB8fCBsb2NhbGU7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXM7XG4gIH07XG5cbiAgLyoqXG4gICAqIEBuZ2RvYyBmdW5jdGlvblxuICAgKiBAbmFtZSBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVQcm92aWRlciNyZWdpc3RlckF2YWlsYWJsZUxhbmd1YWdlS2V5c1xuICAgKiBAbWV0aG9kT2YgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlUHJvdmlkZXJcbiAgICpcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqIFJlZ2lzdGVycyBhIHNldCBvZiBsYW5ndWFnZSBrZXlzIHRoZSBhcHAgd2lsbCB3b3JrIHdpdGguIFVzZSB0aGlzIG1ldGhvZCBpblxuICAgKiBjb21iaW5hdGlvbiB3aXRoXG4gICAqIHtAbGluayBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVQcm92aWRlciNkZXRlcm1pbmVQcmVmZXJyZWRMYW5ndWFnZSBkZXRlcm1pbmVQcmVmZXJyZWRMYW5ndWFnZX0uXG4gICAqIFdoZW4gYXZhaWxhYmxlIGxhbmd1YWdlcyBrZXlzIGFyZSByZWdpc3RlcmVkLCBhbmd1bGFyLXRyYW5zbGF0ZVxuICAgKiB0cmllcyB0byBmaW5kIHRoZSBiZXN0IGZpdHRpbmcgbGFuZ3VhZ2Uga2V5IGRlcGVuZGluZyBvbiB0aGUgYnJvd3NlcnMgbG9jYWxlLFxuICAgKiBjb25zaWRlcmluZyB5b3VyIGxhbmd1YWdlIGtleSBjb252ZW50aW9uLlxuICAgKlxuICAgKiBAcGFyYW0ge29iamVjdH0gbGFuZ3VhZ2VLZXlzIEFycmF5IG9mIGxhbmd1YWdlIGtleXMgdGhlIHlvdXIgYXBwIHdpbGwgdXNlXG4gICAqIEBwYXJhbSB7b2JqZWN0PX0gYWxpYXNlcyBBbGlhcyBtYXAuXG4gICAqL1xuICB0aGlzLnJlZ2lzdGVyQXZhaWxhYmxlTGFuZ3VhZ2VLZXlzID0gZnVuY3Rpb24gKGxhbmd1YWdlS2V5cywgYWxpYXNlcykge1xuICAgIGlmIChsYW5ndWFnZUtleXMpIHtcbiAgICAgICRhdmFpbGFibGVMYW5ndWFnZUtleXMgPSBsYW5ndWFnZUtleXM7XG4gICAgICBpZiAoYWxpYXNlcykge1xuICAgICAgICAkbGFuZ3VhZ2VLZXlBbGlhc2VzID0gYWxpYXNlcztcbiAgICAgIH1cbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cbiAgICByZXR1cm4gJGF2YWlsYWJsZUxhbmd1YWdlS2V5cztcbiAgfTtcblxuICAvKipcbiAgICogQG5nZG9jIGZ1bmN0aW9uXG4gICAqIEBuYW1lIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVByb3ZpZGVyI3VzZUxvYWRlckNhY2hlXG4gICAqIEBtZXRob2RPZiBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVQcm92aWRlclxuICAgKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICogUmVnaXN0ZXJzIGEgY2FjaGUgZm9yIGludGVybmFsICRodHRwIGJhc2VkIGxvYWRlcnMuXG4gICAqIHtAbGluayBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGlvbkNhY2hlICR0cmFuc2xhdGlvbkNhY2hlfS5cbiAgICogV2hlbiBmYWxzZSB0aGUgY2FjaGUgd2lsbCBiZSBkaXNhYmxlZCAoZGVmYXVsdCkuIFdoZW4gdHJ1ZSBvciB1bmRlZmluZWRcbiAgICogdGhlIGNhY2hlIHdpbGwgYmUgYSBkZWZhdWx0IChzZWUgJGNhY2hlRmFjdG9yeSkuIFdoZW4gYW4gb2JqZWN0IGl0IHdpbGxcbiAgICogYmUgdHJlYXQgYXMgYSBjYWNoZSBvYmplY3QgaXRzZWxmOiB0aGUgdXNhZ2UgaXMgJGh0dHAoe2NhY2hlOiBjYWNoZX0pXG4gICAqXG4gICAqIEBwYXJhbSB7b2JqZWN0fSBjYWNoZSBib29sZWFuLCBzdHJpbmcgb3IgY2FjaGUtb2JqZWN0XG4gICAqL1xuICB0aGlzLnVzZUxvYWRlckNhY2hlID0gZnVuY3Rpb24gKGNhY2hlKSB7XG4gICAgaWYgKGNhY2hlID09PSBmYWxzZSkge1xuICAgICAgLy8gZGlzYWJsZSBjYWNoZVxuICAgICAgbG9hZGVyQ2FjaGUgPSB1bmRlZmluZWQ7XG4gICAgfSBlbHNlIGlmIChjYWNoZSA9PT0gdHJ1ZSkge1xuICAgICAgLy8gZW5hYmxlIGNhY2hlIHVzaW5nIEFKUyBkZWZhdWx0c1xuICAgICAgbG9hZGVyQ2FjaGUgPSB0cnVlO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mKGNhY2hlKSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIC8vIGVuYWJsZSBjYWNoZSB1c2luZyBkZWZhdWx0XG4gICAgICBsb2FkZXJDYWNoZSA9ICckdHJhbnNsYXRpb25DYWNoZSc7XG4gICAgfSBlbHNlIGlmIChjYWNoZSkge1xuICAgICAgLy8gZW5hYmxlIGNhY2hlIHVzaW5nIGdpdmVuIG9uZSAoc2VlICRjYWNoZUZhY3RvcnkpXG4gICAgICBsb2FkZXJDYWNoZSA9IGNhY2hlO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcztcbiAgfTtcblxuICAvKipcbiAgICogQG5nZG9jIGZ1bmN0aW9uXG4gICAqIEBuYW1lIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVByb3ZpZGVyI2RpcmVjdGl2ZVByaW9yaXR5XG4gICAqIEBtZXRob2RPZiBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVQcm92aWRlclxuICAgKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICogU2V0cyB0aGUgZGVmYXVsdCBwcmlvcml0eSBvZiB0aGUgdHJhbnNsYXRlIGRpcmVjdGl2ZS4gVGhlIHN0YW5kYXJkIHZhbHVlIGlzIGAwYC5cbiAgICogQ2FsbGluZyB0aGlzIGZ1bmN0aW9uIHdpdGhvdXQgYW4gYXJndW1lbnQgd2lsbCByZXR1cm4gdGhlIGN1cnJlbnQgdmFsdWUuXG4gICAqXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBwcmlvcml0eSBmb3IgdGhlIHRyYW5zbGF0ZS1kaXJlY3RpdmVcbiAgICovXG4gIHRoaXMuZGlyZWN0aXZlUHJpb3JpdHkgPSBmdW5jdGlvbiAocHJpb3JpdHkpIHtcbiAgICBpZiAocHJpb3JpdHkgPT09IHVuZGVmaW5lZCkge1xuICAgICAgLy8gZ2V0dGVyXG4gICAgICByZXR1cm4gZGlyZWN0aXZlUHJpb3JpdHk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIHNldHRlciB3aXRoIGNoYWluaW5nXG4gICAgICBkaXJlY3RpdmVQcmlvcml0eSA9IHByaW9yaXR5O1xuICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuICB9O1xuXG4gIC8qKlxuICAgKiBAbmdkb2MgZnVuY3Rpb25cbiAgICogQG5hbWUgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlUHJvdmlkZXIjc3RhdGVmdWxGaWx0ZXJcbiAgICogQG1ldGhvZE9mIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVByb3ZpZGVyXG4gICAqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKiBTaW5jZSBBbmd1bGFySlMgMS4zLCBmaWx0ZXJzIHdoaWNoIGFyZSBub3Qgc3RhdGVsZXNzIChkZXBlbmRpbmcgYXQgdGhlIHNjb3BlKVxuICAgKiBoYXZlIHRvIGV4cGxpY2l0IGRlZmluZSB0aGlzIGJlaGF2aW9yLlxuICAgKiBTZXRzIHdoZXRoZXIgdGhlIHRyYW5zbGF0ZSBmaWx0ZXIgc2hvdWxkIGJlIHN0YXRlZnVsIG9yIHN0YXRlbGVzcy4gVGhlIHN0YW5kYXJkIHZhbHVlIGlzIGB0cnVlYFxuICAgKiBtZWFuaW5nIGJlaW5nIHN0YXRlZnVsLlxuICAgKiBDYWxsaW5nIHRoaXMgZnVuY3Rpb24gd2l0aG91dCBhbiBhcmd1bWVudCB3aWxsIHJldHVybiB0aGUgY3VycmVudCB2YWx1ZS5cbiAgICpcbiAgICogQHBhcmFtIHtib29sZWFufSBzdGF0ZSAtIGRlZmluZXMgdGhlIHN0YXRlIG9mIHRoZSBmaWx0ZXJcbiAgICovXG4gIHRoaXMuc3RhdGVmdWxGaWx0ZXIgPSBmdW5jdGlvbiAoc3RhdGUpIHtcbiAgICBpZiAoc3RhdGUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgLy8gZ2V0dGVyXG4gICAgICByZXR1cm4gc3RhdGVmdWxGaWx0ZXI7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIHNldHRlciB3aXRoIGNoYWluaW5nXG4gICAgICBzdGF0ZWZ1bEZpbHRlciA9IHN0YXRlO1xuICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuICB9O1xuXG4gIC8qKlxuICAgKiBAbmdkb2MgZnVuY3Rpb25cbiAgICogQG5hbWUgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlUHJvdmlkZXIjcG9zdFByb2Nlc3NcbiAgICogQG1ldGhvZE9mIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVByb3ZpZGVyXG4gICAqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKiBUaGUgcG9zdCBwcm9jZXNzb3Igd2lsbCBiZSBpbnRlcmNlcHQgcmlnaHQgYWZ0ZXIgdGhlIHRyYW5zbGF0aW9uIHJlc3VsdC4gSXQgY2FuIG1vZGlmeSB0aGUgcmVzdWx0LlxuICAgKlxuICAgKiBAcGFyYW0ge29iamVjdH0gZm4gRnVuY3Rpb24gb3Igc2VydmljZSBuYW1lIChzdHJpbmcpIHRvIGJlIGNhbGxlZCBhZnRlciB0aGUgdHJhbnNsYXRpb24gdmFsdWUgaGFzIGJlZW4gc2V0IC8gcmVzb2x2ZWQuIFRoZSBmdW5jdGlvbiBpdHNlbGYgd2lsbCBlbnJpY2ggZXZlcnkgdmFsdWUgYmVpbmcgcHJvY2Vzc2VkIGFuZCB0aGVuIGNvbnRpbnVlIHRoZSBub3JtYWwgcmVzb2x2ZXIgcHJvY2Vzc1xuICAgKi9cbiAgdGhpcy5wb3N0UHJvY2VzcyA9IGZ1bmN0aW9uIChmbikge1xuICAgIGlmIChmbikge1xuICAgICAgcG9zdFByb2Nlc3NGbiA9IGZuO1xuICAgIH0gZWxzZSB7XG4gICAgICBwb3N0UHJvY2Vzc0ZuID0gdW5kZWZpbmVkO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcztcbiAgfTtcblxuICAvKipcbiAgICogQG5nZG9jIGZ1bmN0aW9uXG4gICAqIEBuYW1lIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVByb3ZpZGVyI2tlZXBDb250ZW50XG4gICAqIEBtZXRob2RPZiBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVQcm92aWRlclxuICAgKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICogSWYga2VlcENvbnRlbnQgaXMgc2V0IHRvIHRydWUgdGhhbiB0cmFuc2xhdGUgZGlyZWN0aXZlIHdpbGwgYWx3YXlzIHVzZSBpbm5lckhUTUxcbiAgICogYXMgYSBkZWZhdWx0IHRyYW5zbGF0aW9uXG4gICAqXG4gICAqIEV4YW1wbGU6XG4gICAqIDxwcmU+XG4gICAqICBhcHAuY29uZmlnKGZ1bmN0aW9uICgkdHJhbnNsYXRlUHJvdmlkZXIpIHtcbiAgICogICAgJHRyYW5zbGF0ZVByb3ZpZGVyLmtlZXBDb250ZW50KHRydWUpO1xuICAgKiAgfSk7XG4gICAqIDwvcHJlPlxuICAgKlxuICAgKiBAcGFyYW0ge2Jvb2xlYW59IHZhbHVlIC0gdmFsaWQgdmFsdWVzIGFyZSB0cnVlIG9yIGZhbHNlXG4gICAqL1xuICB0aGlzLmtlZXBDb250ZW50ID0gZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgJGtlZXBDb250ZW50ID0gISghdmFsdWUpO1xuICAgIHJldHVybiB0aGlzO1xuICB9O1xuXG4gIC8qKlxuICAgKiBAbmdkb2Mgb2JqZWN0XG4gICAqIEBuYW1lIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVxuICAgKiBAcmVxdWlyZXMgJGludGVycG9sYXRlXG4gICAqIEByZXF1aXJlcyAkbG9nXG4gICAqIEByZXF1aXJlcyAkcm9vdFNjb3BlXG4gICAqIEByZXF1aXJlcyAkcVxuICAgKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICogVGhlIGAkdHJhbnNsYXRlYCBzZXJ2aWNlIGlzIHRoZSBhY3R1YWwgY29yZSBvZiBhbmd1bGFyLXRyYW5zbGF0ZS4gSXQgZXhwZWN0cyBhIHRyYW5zbGF0aW9uIGlkXG4gICAqIGFuZCBvcHRpb25hbCBpbnRlcnBvbGF0ZSBwYXJhbWV0ZXJzIHRvIHRyYW5zbGF0ZSBjb250ZW50cy5cbiAgICpcbiAgICogPHByZT5cbiAgICogICR0cmFuc2xhdGUoJ0hFQURMSU5FX1RFWFQnKS50aGVuKGZ1bmN0aW9uICh0cmFuc2xhdGlvbikge1xuICAgKiAgICAkc2NvcGUudHJhbnNsYXRlZFRleHQgPSB0cmFuc2xhdGlvbjtcbiAgICogIH0pO1xuICAgKiA8L3ByZT5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd8YXJyYXl9IHRyYW5zbGF0aW9uSWQgQSB0b2tlbiB3aGljaCByZXByZXNlbnRzIGEgdHJhbnNsYXRpb24gaWRcbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhpcyBjYW4gYmUgb3B0aW9uYWxseSBhbiBhcnJheSBvZiB0cmFuc2xhdGlvbiBpZHMgd2hpY2hcbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0cyB0aGF0IHRoZSBmdW5jdGlvbiByZXR1cm5zIGFuIG9iamVjdCB3aGVyZSBlYWNoIGtleVxuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpcyB0aGUgdHJhbnNsYXRpb24gaWQgYW5kIHRoZSB2YWx1ZSB0aGUgdHJhbnNsYXRpb24uXG4gICAqIEBwYXJhbSB7b2JqZWN0PX0gaW50ZXJwb2xhdGVQYXJhbXMgQW4gb2JqZWN0IGhhc2ggZm9yIGR5bmFtaWMgdmFsdWVzXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBpbnRlcnBvbGF0aW9uSWQgVGhlIGlkIG9mIHRoZSBpbnRlcnBvbGF0aW9uIHRvIHVzZVxuICAgKiBAcGFyYW0ge3N0cmluZ30gZGVmYXVsdFRyYW5zbGF0aW9uVGV4dCB0aGUgb3B0aW9uYWwgZGVmYXVsdCB0cmFuc2xhdGlvbiB0ZXh0IHRoYXQgaXMgd3JpdHRlbiBhc1xuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcyBkZWZhdWx0IHRleHQgaW4gY2FzZSBpdCBpcyBub3QgZm91bmQgaW4gYW55IGNvbmZpZ3VyZWQgbGFuZ3VhZ2VcbiAgICogQHBhcmFtIHtzdHJpbmd9IGZvcmNlTGFuZ3VhZ2UgQSBsYW5ndWFnZSB0byBiZSB1c2VkIGluc3RlYWQgb2YgdGhlIGN1cnJlbnQgbGFuZ3VhZ2VcbiAgICogQHJldHVybnMge29iamVjdH0gcHJvbWlzZVxuICAgKi9cbiAgdGhpcy4kZ2V0ID0gWyckbG9nJywgJyRpbmplY3RvcicsICckcm9vdFNjb3BlJywgJyRxJywgZnVuY3Rpb24gKCRsb2csICRpbmplY3RvciwgJHJvb3RTY29wZSwgJHEpIHtcblxuICAgIHZhciBTdG9yYWdlLFxuICAgICAgZGVmYXVsdEludGVycG9sYXRvciA9ICRpbmplY3Rvci5nZXQoJGludGVycG9sYXRpb25GYWN0b3J5IHx8ICckdHJhbnNsYXRlRGVmYXVsdEludGVycG9sYXRpb24nKSxcbiAgICAgIHBlbmRpbmdMb2FkZXIgPSBmYWxzZSxcbiAgICAgIGludGVycG9sYXRvckhhc2hNYXAgPSB7fSxcbiAgICAgIGxhbmdQcm9taXNlcyA9IHt9LFxuICAgICAgZmFsbGJhY2tJbmRleCxcbiAgICAgIHN0YXJ0RmFsbGJhY2tJdGVyYXRpb247XG5cbiAgICB2YXIgJHRyYW5zbGF0ZSA9IGZ1bmN0aW9uICh0cmFuc2xhdGlvbklkLCBpbnRlcnBvbGF0ZVBhcmFtcywgaW50ZXJwb2xhdGlvbklkLCBkZWZhdWx0VHJhbnNsYXRpb25UZXh0LCBmb3JjZUxhbmd1YWdlKSB7XG4gICAgICBpZiAoISR1c2VzICYmICRwcmVmZXJyZWRMYW5ndWFnZSkge1xuICAgICAgICAkdXNlcyA9ICRwcmVmZXJyZWRMYW5ndWFnZTtcbiAgICAgIH1cbiAgICAgIHZhciB1c2VzID0gKGZvcmNlTGFuZ3VhZ2UgJiYgZm9yY2VMYW5ndWFnZSAhPT0gJHVzZXMpID8gLy8gd2UgZG9uJ3Qgd2FudCB0byByZS1uZWdvdGlhdGUgJHVzZXNcbiAgICAgICAgKG5lZ290aWF0ZUxvY2FsZShmb3JjZUxhbmd1YWdlKSB8fCBmb3JjZUxhbmd1YWdlKSA6ICR1c2VzO1xuXG4gICAgICAvLyBDaGVjayBmb3JjZUxhbmd1YWdlIGlzIHByZXNlbnRcbiAgICAgIGlmIChmb3JjZUxhbmd1YWdlKSB7XG4gICAgICAgIGxvYWRUcmFuc2xhdGlvbnNJZk1pc3NpbmcoZm9yY2VMYW5ndWFnZSk7XG4gICAgICB9XG5cbiAgICAgIC8vIER1Y2sgZGV0ZWN0aW9uOiBJZiB0aGUgZmlyc3QgYXJndW1lbnQgaXMgYW4gYXJyYXksIGEgYnVuY2ggb2YgdHJhbnNsYXRpb25zIHdhcyByZXF1ZXN0ZWQuXG4gICAgICAvLyBUaGUgcmVzdWx0IGlzIGFuIG9iamVjdC5cbiAgICAgIGlmIChhbmd1bGFyLmlzQXJyYXkodHJhbnNsYXRpb25JZCkpIHtcbiAgICAgICAgLy8gSW5zcGlyZWQgYnkgUS5hbGxTZXR0bGVkIGJ5IEtyaXMgS293YWxcbiAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2tyaXNrb3dhbC9xL2Jsb2IvYjBmYTcyOTgwNzE3ZGMyMDJmZmMzY2JmMDNiOTM2ZTEwZWJiYjlkNy9xLmpzI0wxNTUzLTE1NjNcbiAgICAgICAgLy8gVGhpcyB0cmFuc2Zvcm1zIGFsbCBwcm9taXNlcyByZWdhcmRsZXNzIHJlc29sdmVkIG9yIHJlamVjdGVkXG4gICAgICAgIHZhciB0cmFuc2xhdGVBbGwgPSBmdW5jdGlvbiAodHJhbnNsYXRpb25JZHMpIHtcbiAgICAgICAgICB2YXIgcmVzdWx0cyA9IHt9OyAvLyBzdG9yaW5nIHRoZSBhY3R1YWwgcmVzdWx0c1xuICAgICAgICAgIHZhciBwcm9taXNlcyA9IFtdOyAvLyBwcm9taXNlcyB0byB3YWl0IGZvclxuICAgICAgICAgIC8vIFdyYXBzIHRoZSBwcm9taXNlIGEpIGJlaW5nIGFsd2F5cyByZXNvbHZlZCBhbmQgYikgc3RvcmluZyB0aGUgbGluayBpZC0+dmFsdWVcbiAgICAgICAgICB2YXIgdHJhbnNsYXRlID0gZnVuY3Rpb24gKHRyYW5zbGF0aW9uSWQpIHtcbiAgICAgICAgICAgIHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCk7XG4gICAgICAgICAgICB2YXIgcmVnYXJkbGVzcyA9IGZ1bmN0aW9uICh2YWx1ZSkge1xuICAgICAgICAgICAgICByZXN1bHRzW3RyYW5zbGF0aW9uSWRdID0gdmFsdWU7XG4gICAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoW3RyYW5zbGF0aW9uSWQsIHZhbHVlXSk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgLy8gd2UgZG9uJ3QgY2FyZSB3aGV0aGVyIHRoZSBwcm9taXNlIHdhcyByZXNvbHZlZCBvciByZWplY3RlZDsganVzdCBzdG9yZSB0aGUgdmFsdWVzXG4gICAgICAgICAgICAkdHJhbnNsYXRlKHRyYW5zbGF0aW9uSWQsIGludGVycG9sYXRlUGFyYW1zLCBpbnRlcnBvbGF0aW9uSWQsIGRlZmF1bHRUcmFuc2xhdGlvblRleHQsIGZvcmNlTGFuZ3VhZ2UpLnRoZW4ocmVnYXJkbGVzcywgcmVnYXJkbGVzcyk7XG4gICAgICAgICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTtcbiAgICAgICAgICB9O1xuICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjID0gdHJhbnNsYXRpb25JZHMubGVuZ3RoOyBpIDwgYzsgaSsrKSB7XG4gICAgICAgICAgICBwcm9taXNlcy5wdXNoKHRyYW5zbGF0ZSh0cmFuc2xhdGlvbklkc1tpXSkpO1xuICAgICAgICAgIH1cbiAgICAgICAgICAvLyB3YWl0IGZvciBhbGwgKGluY2x1ZGluZyBzdG9yaW5nIHRvIHJlc3VsdHMpXG4gICAgICAgICAgcmV0dXJuICRxLmFsbChwcm9taXNlcykudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAvLyByZXR1cm4gdGhlIHJlc3VsdHNcbiAgICAgICAgICAgIHJldHVybiByZXN1bHRzO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gdHJhbnNsYXRlQWxsKHRyYW5zbGF0aW9uSWQpO1xuICAgICAgfVxuXG4gICAgICB2YXIgZGVmZXJyZWQgPSAkcS5kZWZlcigpO1xuXG4gICAgICAvLyB0cmltIG9mZiBhbnkgd2hpdGVzcGFjZVxuICAgICAgaWYgKHRyYW5zbGF0aW9uSWQpIHtcbiAgICAgICAgdHJhbnNsYXRpb25JZCA9IHRyaW0uYXBwbHkodHJhbnNsYXRpb25JZCk7XG4gICAgICB9XG5cbiAgICAgIHZhciBwcm9taXNlVG9XYWl0Rm9yID0gKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdmFyIHByb21pc2UgPSAkcHJlZmVycmVkTGFuZ3VhZ2UgP1xuICAgICAgICAgIGxhbmdQcm9taXNlc1skcHJlZmVycmVkTGFuZ3VhZ2VdIDpcbiAgICAgICAgICBsYW5nUHJvbWlzZXNbdXNlc107XG5cbiAgICAgICAgZmFsbGJhY2tJbmRleCA9IDA7XG5cbiAgICAgICAgaWYgKCRzdG9yYWdlRmFjdG9yeSAmJiAhcHJvbWlzZSkge1xuICAgICAgICAgIC8vIGxvb2tzIGxpa2UgdGhlcmUncyBubyBwZW5kaW5nIHByb21pc2UgZm9yICRwcmVmZXJyZWRMYW5ndWFnZSBvclxuICAgICAgICAgIC8vICR1c2VzLiBNYXliZSB0aGVyZSdzIG9uZSBwZW5kaW5nIGZvciBhIGxhbmd1YWdlIHRoYXQgY29tZXMgZnJvbVxuICAgICAgICAgIC8vIHN0b3JhZ2UuXG4gICAgICAgICAgdmFyIGxhbmdLZXkgPSBTdG9yYWdlLmdldCgkc3RvcmFnZUtleSk7XG4gICAgICAgICAgcHJvbWlzZSA9IGxhbmdQcm9taXNlc1tsYW5nS2V5XTtcblxuICAgICAgICAgIGlmICgkZmFsbGJhY2tMYW5ndWFnZSAmJiAkZmFsbGJhY2tMYW5ndWFnZS5sZW5ndGgpIHtcbiAgICAgICAgICAgIHZhciBpbmRleCA9IGluZGV4T2YoJGZhbGxiYWNrTGFuZ3VhZ2UsIGxhbmdLZXkpO1xuICAgICAgICAgICAgLy8gbWF5YmUgdGhlIGxhbmd1YWdlIGZyb20gc3RvcmFnZSBpcyBhbHNvIGRlZmluZWQgYXMgZmFsbGJhY2sgbGFuZ3VhZ2VcbiAgICAgICAgICAgIC8vIHdlIGluY3JlYXNlIHRoZSBmYWxsYmFjayBsYW5ndWFnZSBpbmRleCB0byBub3Qgc2VhcmNoIGluIHRoYXQgbGFuZ3VhZ2VcbiAgICAgICAgICAgIC8vIGFzIGZhbGxiYWNrLCBzaW5jZSBpdCdzIHByb2JhYmx5IHRoZSBmaXJzdCB1c2VkIGxhbmd1YWdlXG4gICAgICAgICAgICAvLyBpbiB0aGF0IGNhc2UgdGhlIGluZGV4IHN0YXJ0cyBhZnRlciB0aGUgZmlyc3QgZWxlbWVudFxuICAgICAgICAgICAgZmFsbGJhY2tJbmRleCA9IChpbmRleCA9PT0gMCkgPyAxIDogMDtcblxuICAgICAgICAgICAgLy8gYnV0IHdlIGNhbiBtYWtlIHN1cmUgdG8gQUxXQVlTIGZhbGxiYWNrIHRvIHByZWZlcnJlZCBsYW5ndWFnZSBhdCBsZWFzdFxuICAgICAgICAgICAgaWYgKGluZGV4T2YoJGZhbGxiYWNrTGFuZ3VhZ2UsICRwcmVmZXJyZWRMYW5ndWFnZSkgPCAwKSB7XG4gICAgICAgICAgICAgICRmYWxsYmFja0xhbmd1YWdlLnB1c2goJHByZWZlcnJlZExhbmd1YWdlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHByb21pc2U7XG4gICAgICB9KCkpO1xuXG4gICAgICBpZiAoIXByb21pc2VUb1dhaXRGb3IpIHtcbiAgICAgICAgLy8gbm8gcHJvbWlzZSB0byB3YWl0IGZvcj8gb2theS4gVGhlbiB0aGVyZSdzIG5vIGxvYWRlciByZWdpc3RlcmVkXG4gICAgICAgIC8vIG5vciBpcyBhIG9uZSBwZW5kaW5nIGZvciBsYW5ndWFnZSB0aGF0IGNvbWVzIGZyb20gc3RvcmFnZS5cbiAgICAgICAgLy8gV2UgY2FuIGp1c3QgdHJhbnNsYXRlLlxuICAgICAgICBkZXRlcm1pbmVUcmFuc2xhdGlvbih0cmFuc2xhdGlvbklkLCBpbnRlcnBvbGF0ZVBhcmFtcywgaW50ZXJwb2xhdGlvbklkLCBkZWZhdWx0VHJhbnNsYXRpb25UZXh0LCB1c2VzKS50aGVuKGRlZmVycmVkLnJlc29sdmUsIGRlZmVycmVkLnJlamVjdCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB2YXIgcHJvbWlzZVJlc29sdmVkID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgIC8vICR1c2VzIG1heSBoYXZlIGNoYW5nZWQgd2hpbGUgd2FpdGluZ1xuICAgICAgICAgIGlmICghZm9yY2VMYW5ndWFnZSkge1xuICAgICAgICAgICAgdXNlcyA9ICR1c2VzO1xuICAgICAgICAgIH1cbiAgICAgICAgICBkZXRlcm1pbmVUcmFuc2xhdGlvbih0cmFuc2xhdGlvbklkLCBpbnRlcnBvbGF0ZVBhcmFtcywgaW50ZXJwb2xhdGlvbklkLCBkZWZhdWx0VHJhbnNsYXRpb25UZXh0LCB1c2VzKS50aGVuKGRlZmVycmVkLnJlc29sdmUsIGRlZmVycmVkLnJlamVjdCk7XG4gICAgICAgIH07XG4gICAgICAgIHByb21pc2VSZXNvbHZlZC5kaXNwbGF5TmFtZSA9ICdwcm9taXNlUmVzb2x2ZWQnO1xuXG4gICAgICAgIHByb21pc2VUb1dhaXRGb3JbJ2ZpbmFsbHknXShwcm9taXNlUmVzb2x2ZWQpWydjYXRjaCddKGFuZ3VsYXIubm9vcCk7IC8vIHdlIGRvbid0IGNhcmUgYWJvdXQgZXJyb3JzIGhlcmUsIGFscmVhZHkgaGFuZGxlZFxuICAgICAgfVxuICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7XG4gICAgfTtcblxuICAgIC8qKlxuICAgICAqIEBuYW1lIGFwcGx5Tm90Rm91bmRJbmRpY2F0b3JzXG4gICAgICogQHByaXZhdGVcbiAgICAgKlxuICAgICAqIEBkZXNjcmlwdGlvblxuICAgICAqIEFwcGxpZXMgbm90IGZvdW50IGluZGljYXRvcnMgdG8gZ2l2ZW4gdHJhbnNsYXRpb24gaWQsIGlmIG5lZWRlZC5cbiAgICAgKiBUaGlzIGZ1bmN0aW9uIGdldHMgb25seSBleGVjdXRlZCwgaWYgYSB0cmFuc2xhdGlvbiBpZCBkb2Vzbid0IGV4aXN0LFxuICAgICAqIHdoaWNoIGlzIHdoeSBhIHRyYW5zbGF0aW9uIGlkIGlzIGV4cGVjdGVkIGFzIGFyZ3VtZW50LlxuICAgICAqXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHRyYW5zbGF0aW9uSWQgVHJhbnNsYXRpb24gaWQuXG4gICAgICogQHJldHVybnMge3N0cmluZ30gU2FtZSBhcyBnaXZlbiB0cmFuc2xhdGlvbiBpZCBidXQgYXBwbGllZCB3aXRoIG5vdCBmb3VuZFxuICAgICAqIGluZGljYXRvcnMuXG4gICAgICovXG4gICAgdmFyIGFwcGx5Tm90Rm91bmRJbmRpY2F0b3JzID0gZnVuY3Rpb24gKHRyYW5zbGF0aW9uSWQpIHtcbiAgICAgIC8vIGFwcGx5aW5nIG5vdEZvdW5kSW5kaWNhdG9yc1xuICAgICAgaWYgKCRub3RGb3VuZEluZGljYXRvckxlZnQpIHtcbiAgICAgICAgdHJhbnNsYXRpb25JZCA9IFskbm90Rm91bmRJbmRpY2F0b3JMZWZ0LCB0cmFuc2xhdGlvbklkXS5qb2luKCcgJyk7XG4gICAgICB9XG4gICAgICBpZiAoJG5vdEZvdW5kSW5kaWNhdG9yUmlnaHQpIHtcbiAgICAgICAgdHJhbnNsYXRpb25JZCA9IFt0cmFuc2xhdGlvbklkLCAkbm90Rm91bmRJbmRpY2F0b3JSaWdodF0uam9pbignICcpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHRyYW5zbGF0aW9uSWQ7XG4gICAgfTtcblxuICAgIC8qKlxuICAgICAqIEBuYW1lIHVzZUxhbmd1YWdlXG4gICAgICogQHByaXZhdGVcbiAgICAgKlxuICAgICAqIEBkZXNjcmlwdGlvblxuICAgICAqIE1ha2VzIGFjdHVhbCB1c2Ugb2YgYSBsYW5ndWFnZSBieSBzZXR0aW5nIGEgZ2l2ZW4gbGFuZ3VhZ2Uga2V5IGFzIHVzZWRcbiAgICAgKiBsYW5ndWFnZSBhbmQgaW5mb3JtcyByZWdpc3RlcmVkIGludGVycG9sYXRvcnMgdG8gYWxzbyB1c2UgdGhlIGdpdmVuXG4gICAgICoga2V5IGFzIGxvY2FsZS5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgTG9jYWxlIGtleS5cbiAgICAgKi9cbiAgICB2YXIgdXNlTGFuZ3VhZ2UgPSBmdW5jdGlvbiAoa2V5KSB7XG4gICAgICAkdXNlcyA9IGtleTtcblxuICAgICAgLy8gbWFrZSBzdXJlIHRvIHN0b3JlIG5ldyBsYW5ndWFnZSBrZXkgYmVmb3JlIHRyaWdnZXJpbmcgc3VjY2VzcyBldmVudFxuICAgICAgaWYgKCRzdG9yYWdlRmFjdG9yeSkge1xuICAgICAgICBTdG9yYWdlLnB1dCgkdHJhbnNsYXRlLnN0b3JhZ2VLZXkoKSwgJHVzZXMpO1xuICAgICAgfVxuXG4gICAgICAkcm9vdFNjb3BlLiRlbWl0KCckdHJhbnNsYXRlQ2hhbmdlU3VjY2VzcycsIHtsYW5ndWFnZSA6IGtleX0pO1xuXG4gICAgICAvLyBpbmZvcm0gZGVmYXVsdCBpbnRlcnBvbGF0b3JcbiAgICAgIGRlZmF1bHRJbnRlcnBvbGF0b3Iuc2V0TG9jYWxlKCR1c2VzKTtcblxuICAgICAgdmFyIGVhY2hJbnRlcnBvbGF0b3IgPSBmdW5jdGlvbiAoaW50ZXJwb2xhdG9yLCBpZCkge1xuICAgICAgICBpbnRlcnBvbGF0b3JIYXNoTWFwW2lkXS5zZXRMb2NhbGUoJHVzZXMpO1xuICAgICAgfTtcbiAgICAgIGVhY2hJbnRlcnBvbGF0b3IuZGlzcGxheU5hbWUgPSAnZWFjaEludGVycG9sYXRvckxvY2FsZVNldHRlcic7XG5cbiAgICAgIC8vIGluZm9ybSBhbGwgb3RoZXJzIHRvbyFcbiAgICAgIGFuZ3VsYXIuZm9yRWFjaChpbnRlcnBvbGF0b3JIYXNoTWFwLCBlYWNoSW50ZXJwb2xhdG9yKTtcbiAgICAgICRyb290U2NvcGUuJGVtaXQoJyR0cmFuc2xhdGVDaGFuZ2VFbmQnLCB7bGFuZ3VhZ2UgOiBrZXl9KTtcbiAgICB9O1xuXG4gICAgLyoqXG4gICAgICogQG5hbWUgbG9hZEFzeW5jXG4gICAgICogQHByaXZhdGVcbiAgICAgKlxuICAgICAqIEBkZXNjcmlwdGlvblxuICAgICAqIEtpY2tzIG9mZiByZWdpc3RlcmVkIGFzeW5jIGxvYWRlciB1c2luZyBgJGluamVjdG9yYCBhbmQgYXBwbGllcyBleGlzdGluZ1xuICAgICAqIGxvYWRlciBvcHRpb25zLiBXaGVuIHJlc29sdmVkLCBpdCB1cGRhdGVzIHRyYW5zbGF0aW9uIHRhYmxlcyBhY2NvcmRpbmdseVxuICAgICAqIG9yIHJlamVjdHMgd2l0aCBnaXZlbiBsYW5ndWFnZSBrZXkuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IExhbmd1YWdlIGtleS5cbiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfSBBIHByb21pc2UuXG4gICAgICovXG4gICAgdmFyIGxvYWRBc3luYyA9IGZ1bmN0aW9uIChrZXkpIHtcbiAgICAgIGlmICgha2V5KSB7XG4gICAgICAgIHRocm93ICdObyBsYW5ndWFnZSBrZXkgc3BlY2lmaWVkIGZvciBsb2FkaW5nLic7XG4gICAgICB9XG5cbiAgICAgIHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCk7XG5cbiAgICAgICRyb290U2NvcGUuJGVtaXQoJyR0cmFuc2xhdGVMb2FkaW5nU3RhcnQnLCB7bGFuZ3VhZ2UgOiBrZXl9KTtcbiAgICAgIHBlbmRpbmdMb2FkZXIgPSB0cnVlO1xuXG4gICAgICB2YXIgY2FjaGUgPSBsb2FkZXJDYWNoZTtcbiAgICAgIGlmICh0eXBlb2YoY2FjaGUpID09PSAnc3RyaW5nJykge1xuICAgICAgICAvLyBnZXR0aW5nIG9uLWRlbWFuZCBpbnN0YW5jZSBvZiBsb2FkZXJcbiAgICAgICAgY2FjaGUgPSAkaW5qZWN0b3IuZ2V0KGNhY2hlKTtcbiAgICAgIH1cblxuICAgICAgdmFyIGxvYWRlck9wdGlvbnMgPSBhbmd1bGFyLmV4dGVuZCh7fSwgJGxvYWRlck9wdGlvbnMsIHtcbiAgICAgICAga2V5IDoga2V5LFxuICAgICAgICAkaHR0cCA6IGFuZ3VsYXIuZXh0ZW5kKHt9LCB7XG4gICAgICAgICAgY2FjaGUgOiBjYWNoZVxuICAgICAgICB9LCAkbG9hZGVyT3B0aW9ucy4kaHR0cClcbiAgICAgIH0pO1xuXG4gICAgICB2YXIgb25Mb2FkZXJTdWNjZXNzID0gZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgdmFyIHRyYW5zbGF0aW9uVGFibGUgPSB7fTtcbiAgICAgICAgJHJvb3RTY29wZS4kZW1pdCgnJHRyYW5zbGF0ZUxvYWRpbmdTdWNjZXNzJywge2xhbmd1YWdlIDoga2V5fSk7XG5cbiAgICAgICAgaWYgKGFuZ3VsYXIuaXNBcnJheShkYXRhKSkge1xuICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChkYXRhLCBmdW5jdGlvbiAodGFibGUpIHtcbiAgICAgICAgICAgIGFuZ3VsYXIuZXh0ZW5kKHRyYW5zbGF0aW9uVGFibGUsIGZsYXRPYmplY3QodGFibGUpKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBhbmd1bGFyLmV4dGVuZCh0cmFuc2xhdGlvblRhYmxlLCBmbGF0T2JqZWN0KGRhdGEpKTtcbiAgICAgICAgfVxuICAgICAgICBwZW5kaW5nTG9hZGVyID0gZmFsc2U7XG4gICAgICAgIGRlZmVycmVkLnJlc29sdmUoe1xuICAgICAgICAgIGtleSA6IGtleSxcbiAgICAgICAgICB0YWJsZSA6IHRyYW5zbGF0aW9uVGFibGVcbiAgICAgICAgfSk7XG4gICAgICAgICRyb290U2NvcGUuJGVtaXQoJyR0cmFuc2xhdGVMb2FkaW5nRW5kJywge2xhbmd1YWdlIDoga2V5fSk7XG4gICAgICB9O1xuICAgICAgb25Mb2FkZXJTdWNjZXNzLmRpc3BsYXlOYW1lID0gJ29uTG9hZGVyU3VjY2Vzcyc7XG5cbiAgICAgIHZhciBvbkxvYWRlckVycm9yID0gZnVuY3Rpb24gKGtleSkge1xuICAgICAgICAkcm9vdFNjb3BlLiRlbWl0KCckdHJhbnNsYXRlTG9hZGluZ0Vycm9yJywge2xhbmd1YWdlIDoga2V5fSk7XG4gICAgICAgIGRlZmVycmVkLnJlamVjdChrZXkpO1xuICAgICAgICAkcm9vdFNjb3BlLiRlbWl0KCckdHJhbnNsYXRlTG9hZGluZ0VuZCcsIHtsYW5ndWFnZSA6IGtleX0pO1xuICAgICAgfTtcbiAgICAgIG9uTG9hZGVyRXJyb3IuZGlzcGxheU5hbWUgPSAnb25Mb2FkZXJFcnJvcic7XG5cbiAgICAgICRpbmplY3Rvci5nZXQoJGxvYWRlckZhY3RvcnkpKGxvYWRlck9wdGlvbnMpXG4gICAgICAgIC50aGVuKG9uTG9hZGVyU3VjY2Vzcywgb25Mb2FkZXJFcnJvcik7XG5cbiAgICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlO1xuICAgIH07XG5cbiAgICBpZiAoJHN0b3JhZ2VGYWN0b3J5KSB7XG4gICAgICBTdG9yYWdlID0gJGluamVjdG9yLmdldCgkc3RvcmFnZUZhY3RvcnkpO1xuXG4gICAgICBpZiAoIVN0b3JhZ2UuZ2V0IHx8ICFTdG9yYWdlLnB1dCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkblxcJ3QgdXNlIHN0b3JhZ2UgXFwnJyArICRzdG9yYWdlRmFjdG9yeSArICdcXCcsIG1pc3NpbmcgZ2V0KCkgb3IgcHV0KCkgbWV0aG9kIScpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIGlmIHdlIGhhdmUgYWRkaXRpb25hbCBpbnRlcnBvbGF0aW9ucyB0aGF0IHdlcmUgYWRkZWQgdmlhXG4gICAgLy8gJHRyYW5zbGF0ZVByb3ZpZGVyLmFkZEludGVycG9sYXRpb24oKSwgd2UgaGF2ZSB0byBtYXAnZW1cbiAgICBpZiAoJGludGVycG9sYXRvckZhY3Rvcmllcy5sZW5ndGgpIHtcbiAgICAgIHZhciBlYWNoSW50ZXJwb2xhdGlvbkZhY3RvcnkgPSBmdW5jdGlvbiAoaW50ZXJwb2xhdG9yRmFjdG9yeSkge1xuICAgICAgICB2YXIgaW50ZXJwb2xhdG9yID0gJGluamVjdG9yLmdldChpbnRlcnBvbGF0b3JGYWN0b3J5KTtcbiAgICAgICAgLy8gc2V0dGluZyBpbml0aWFsIGxvY2FsZSBmb3IgZWFjaCBpbnRlcnBvbGF0aW9uIHNlcnZpY2VcbiAgICAgICAgaW50ZXJwb2xhdG9yLnNldExvY2FsZSgkcHJlZmVycmVkTGFuZ3VhZ2UgfHwgJHVzZXMpO1xuICAgICAgICAvLyBtYWtlJ2VtIHJlY29nbml6YWJsZSB0aHJvdWdoIGlkXG4gICAgICAgIGludGVycG9sYXRvckhhc2hNYXBbaW50ZXJwb2xhdG9yLmdldEludGVycG9sYXRpb25JZGVudGlmaWVyKCldID0gaW50ZXJwb2xhdG9yO1xuICAgICAgfTtcbiAgICAgIGVhY2hJbnRlcnBvbGF0aW9uRmFjdG9yeS5kaXNwbGF5TmFtZSA9ICdpbnRlcnBvbGF0aW9uRmFjdG9yeUFkZGVyJztcblxuICAgICAgYW5ndWxhci5mb3JFYWNoKCRpbnRlcnBvbGF0b3JGYWN0b3JpZXMsIGVhY2hJbnRlcnBvbGF0aW9uRmFjdG9yeSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQG5hbWUgZ2V0VHJhbnNsYXRpb25UYWJsZVxuICAgICAqIEBwcml2YXRlXG4gICAgICpcbiAgICAgKiBAZGVzY3JpcHRpb25cbiAgICAgKiBSZXR1cm5zIGEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIHRvIHRoZSB0cmFuc2xhdGlvbiB0YWJsZVxuICAgICAqIG9yIGlzIHJlamVjdGVkIGlmIGFuIGVycm9yIG9jY3VycmVkLlxuICAgICAqXG4gICAgICogQHBhcmFtIGxhbmdLZXlcbiAgICAgKiBAcmV0dXJucyB7US5wcm9taXNlfVxuICAgICAqL1xuICAgIHZhciBnZXRUcmFuc2xhdGlvblRhYmxlID0gZnVuY3Rpb24gKGxhbmdLZXkpIHtcbiAgICAgIHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCk7XG4gICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKCR0cmFuc2xhdGlvblRhYmxlLCBsYW5nS2V5KSkge1xuICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKCR0cmFuc2xhdGlvblRhYmxlW2xhbmdLZXldKTtcbiAgICAgIH0gZWxzZSBpZiAobGFuZ1Byb21pc2VzW2xhbmdLZXldKSB7XG4gICAgICAgIHZhciBvblJlc29sdmUgPSBmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgICAgIHRyYW5zbGF0aW9ucyhkYXRhLmtleSwgZGF0YS50YWJsZSk7XG4gICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShkYXRhLnRhYmxlKTtcbiAgICAgICAgfTtcbiAgICAgICAgb25SZXNvbHZlLmRpc3BsYXlOYW1lID0gJ3RyYW5zbGF0aW9uVGFibGVSZXNvbHZlcic7XG4gICAgICAgIGxhbmdQcm9taXNlc1tsYW5nS2V5XS50aGVuKG9uUmVzb2x2ZSwgZGVmZXJyZWQucmVqZWN0KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGRlZmVycmVkLnJlamVjdCgpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7XG4gICAgfTtcblxuICAgIC8qKlxuICAgICAqIEBuYW1lIGdldEZhbGxiYWNrVHJhbnNsYXRpb25cbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqXG4gICAgICogQGRlc2NyaXB0aW9uXG4gICAgICogUmV0dXJucyBhIHByb21pc2UgdGhhdCB3aWxsIHJlc29sdmUgdG8gdGhlIHRyYW5zbGF0aW9uXG4gICAgICogb3IgYmUgcmVqZWN0ZWQgaWYgbm8gdHJhbnNsYXRpb24gd2FzIGZvdW5kIGZvciB0aGUgbGFuZ3VhZ2UuXG4gICAgICogVGhpcyBmdW5jdGlvbiBpcyBjdXJyZW50bHkgb25seSB1c2VkIGZvciBmYWxsYmFjayBsYW5ndWFnZSB0cmFuc2xhdGlvbi5cbiAgICAgKlxuICAgICAqIEBwYXJhbSBsYW5nS2V5IFRoZSBsYW5ndWFnZSB0byB0cmFuc2xhdGUgdG8uXG4gICAgICogQHBhcmFtIHRyYW5zbGF0aW9uSWRcbiAgICAgKiBAcGFyYW0gaW50ZXJwb2xhdGVQYXJhbXNcbiAgICAgKiBAcGFyYW0gSW50ZXJwb2xhdG9yXG4gICAgICogQHBhcmFtIHNhbml0aXplU3RyYXRlZ3lcbiAgICAgKiBAcmV0dXJucyB7US5wcm9taXNlfVxuICAgICAqL1xuICAgIHZhciBnZXRGYWxsYmFja1RyYW5zbGF0aW9uID0gZnVuY3Rpb24gKGxhbmdLZXksIHRyYW5zbGF0aW9uSWQsIGludGVycG9sYXRlUGFyYW1zLCBJbnRlcnBvbGF0b3IsIHNhbml0aXplU3RyYXRlZ3kpIHtcbiAgICAgIHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCk7XG5cbiAgICAgIHZhciBvblJlc29sdmUgPSBmdW5jdGlvbiAodHJhbnNsYXRpb25UYWJsZSkge1xuICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRyYW5zbGF0aW9uVGFibGUsIHRyYW5zbGF0aW9uSWQpICYmIHRyYW5zbGF0aW9uVGFibGVbdHJhbnNsYXRpb25JZF0gIT09IG51bGwpIHtcbiAgICAgICAgICBJbnRlcnBvbGF0b3Iuc2V0TG9jYWxlKGxhbmdLZXkpO1xuICAgICAgICAgIHZhciB0cmFuc2xhdGlvbiA9IHRyYW5zbGF0aW9uVGFibGVbdHJhbnNsYXRpb25JZF07XG4gICAgICAgICAgaWYgKHRyYW5zbGF0aW9uLnN1YnN0cigwLCAyKSA9PT0gJ0A6Jykge1xuICAgICAgICAgICAgZ2V0RmFsbGJhY2tUcmFuc2xhdGlvbihsYW5nS2V5LCB0cmFuc2xhdGlvbi5zdWJzdHIoMiksIGludGVycG9sYXRlUGFyYW1zLCBJbnRlcnBvbGF0b3IsIHNhbml0aXplU3RyYXRlZ3kpXG4gICAgICAgICAgICAgIC50aGVuKGRlZmVycmVkLnJlc29sdmUsIGRlZmVycmVkLnJlamVjdCk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHZhciBpbnRlcnBvbGF0ZWRWYWx1ZSA9IEludGVycG9sYXRvci5pbnRlcnBvbGF0ZSh0cmFuc2xhdGlvblRhYmxlW3RyYW5zbGF0aW9uSWRdLCBpbnRlcnBvbGF0ZVBhcmFtcywgJ3NlcnZpY2UnLCBzYW5pdGl6ZVN0cmF0ZWd5LCB0cmFuc2xhdGlvbklkKTtcbiAgICAgICAgICAgIGludGVycG9sYXRlZFZhbHVlID0gYXBwbHlQb3N0UHJvY2Vzc2luZyh0cmFuc2xhdGlvbklkLCB0cmFuc2xhdGlvblRhYmxlW3RyYW5zbGF0aW9uSWRdLCBpbnRlcnBvbGF0ZWRWYWx1ZSwgaW50ZXJwb2xhdGVQYXJhbXMsIGxhbmdLZXkpO1xuXG4gICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKGludGVycG9sYXRlZFZhbHVlKTtcblxuICAgICAgICAgIH1cbiAgICAgICAgICBJbnRlcnBvbGF0b3Iuc2V0TG9jYWxlKCR1c2VzKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoKTtcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICAgIG9uUmVzb2x2ZS5kaXNwbGF5TmFtZSA9ICdmYWxsYmFja1RyYW5zbGF0aW9uUmVzb2x2ZXInO1xuXG4gICAgICBnZXRUcmFuc2xhdGlvblRhYmxlKGxhbmdLZXkpLnRoZW4ob25SZXNvbHZlLCBkZWZlcnJlZC5yZWplY3QpO1xuXG4gICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTtcbiAgICB9O1xuXG4gICAgLyoqXG4gICAgICogQG5hbWUgZ2V0RmFsbGJhY2tUcmFuc2xhdGlvbkluc3RhbnRcbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqXG4gICAgICogQGRlc2NyaXB0aW9uXG4gICAgICogUmV0dXJucyBhIHRyYW5zbGF0aW9uXG4gICAgICogVGhpcyBmdW5jdGlvbiBpcyBjdXJyZW50bHkgb25seSB1c2VkIGZvciBmYWxsYmFjayBsYW5ndWFnZSB0cmFuc2xhdGlvbi5cbiAgICAgKlxuICAgICAqIEBwYXJhbSBsYW5nS2V5IFRoZSBsYW5ndWFnZSB0byB0cmFuc2xhdGUgdG8uXG4gICAgICogQHBhcmFtIHRyYW5zbGF0aW9uSWRcbiAgICAgKiBAcGFyYW0gaW50ZXJwb2xhdGVQYXJhbXNcbiAgICAgKiBAcGFyYW0gSW50ZXJwb2xhdG9yXG4gICAgICogQHBhcmFtIHNhbml0aXplU3RyYXRlZ3kgc2FuaXRpemUgc3RyYXRlZ3kgb3ZlcnJpZGVcbiAgICAgKlxuICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IHRyYW5zbGF0aW9uXG4gICAgICovXG4gICAgdmFyIGdldEZhbGxiYWNrVHJhbnNsYXRpb25JbnN0YW50ID0gZnVuY3Rpb24gKGxhbmdLZXksIHRyYW5zbGF0aW9uSWQsIGludGVycG9sYXRlUGFyYW1zLCBJbnRlcnBvbGF0b3IsIHNhbml0aXplU3RyYXRlZ3kpIHtcbiAgICAgIHZhciByZXN1bHQsIHRyYW5zbGF0aW9uVGFibGUgPSAkdHJhbnNsYXRpb25UYWJsZVtsYW5nS2V5XTtcblxuICAgICAgaWYgKHRyYW5zbGF0aW9uVGFibGUgJiYgT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRyYW5zbGF0aW9uVGFibGUsIHRyYW5zbGF0aW9uSWQpICYmIHRyYW5zbGF0aW9uVGFibGVbdHJhbnNsYXRpb25JZF0gIT09IG51bGwpIHtcbiAgICAgICAgSW50ZXJwb2xhdG9yLnNldExvY2FsZShsYW5nS2V5KTtcbiAgICAgICAgcmVzdWx0ID0gSW50ZXJwb2xhdG9yLmludGVycG9sYXRlKHRyYW5zbGF0aW9uVGFibGVbdHJhbnNsYXRpb25JZF0sIGludGVycG9sYXRlUGFyYW1zLCAnZmlsdGVyJywgc2FuaXRpemVTdHJhdGVneSwgdHJhbnNsYXRpb25JZCk7XG4gICAgICAgIHJlc3VsdCA9IGFwcGx5UG9zdFByb2Nlc3NpbmcodHJhbnNsYXRpb25JZCwgdHJhbnNsYXRpb25UYWJsZVt0cmFuc2xhdGlvbklkXSwgcmVzdWx0LCBpbnRlcnBvbGF0ZVBhcmFtcywgbGFuZ0tleSwgc2FuaXRpemVTdHJhdGVneSk7XG4gICAgICAgIC8vIHdvcmthcm91bmQgZm9yIFRydXN0ZWRWYWx1ZUhvbGRlclR5cGVcbiAgICAgICAgaWYgKCFhbmd1bGFyLmlzU3RyaW5nKHJlc3VsdCkgJiYgYW5ndWxhci5pc0Z1bmN0aW9uKHJlc3VsdC4kJHVud3JhcFRydXN0ZWRWYWx1ZSkpIHtcbiAgICAgICAgICB2YXIgcmVzdWx0MiA9IHJlc3VsdC4kJHVud3JhcFRydXN0ZWRWYWx1ZSgpO1xuICAgICAgICAgIGlmIChyZXN1bHQyLnN1YnN0cigwLCAyKSA9PT0gJ0A6Jykge1xuICAgICAgICAgICAgcmV0dXJuIGdldEZhbGxiYWNrVHJhbnNsYXRpb25JbnN0YW50KGxhbmdLZXksIHJlc3VsdDIuc3Vic3RyKDIpLCBpbnRlcnBvbGF0ZVBhcmFtcywgSW50ZXJwb2xhdG9yLCBzYW5pdGl6ZVN0cmF0ZWd5KTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAocmVzdWx0LnN1YnN0cigwLCAyKSA9PT0gJ0A6Jykge1xuICAgICAgICAgIHJldHVybiBnZXRGYWxsYmFja1RyYW5zbGF0aW9uSW5zdGFudChsYW5nS2V5LCByZXN1bHQuc3Vic3RyKDIpLCBpbnRlcnBvbGF0ZVBhcmFtcywgSW50ZXJwb2xhdG9yLCBzYW5pdGl6ZVN0cmF0ZWd5KTtcbiAgICAgICAgfVxuICAgICAgICBJbnRlcnBvbGF0b3Iuc2V0TG9jYWxlKCR1c2VzKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9O1xuXG5cbiAgICAvKipcbiAgICAgKiBAbmFtZSB0cmFuc2xhdGVCeUhhbmRsZXJcbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqXG4gICAgICogVHJhbnNsYXRlIGJ5IG1pc3NpbmcgdHJhbnNsYXRpb24gaGFuZGxlci5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB0cmFuc2xhdGlvbklkXG4gICAgICogQHBhcmFtIGludGVycG9sYXRlUGFyYW1zXG4gICAgICogQHBhcmFtIGRlZmF1bHRUcmFuc2xhdGlvblRleHRcbiAgICAgKiBAcGFyYW0gc2FuaXRpemVTdHJhdGVneSBzYW5pdGl6ZSBzdHJhdGVneSBvdmVycmlkZVxuICAgICAqXG4gICAgICogQHJldHVybnMgdHJhbnNsYXRpb24gY3JlYXRlZCBieSAkbWlzc2luZ1RyYW5zbGF0aW9uSGFuZGxlciBvciB0cmFuc2xhdGlvbklkIGlzICRtaXNzaW5nVHJhbnNsYXRpb25IYW5kbGVyIGlzXG4gICAgICogYWJzZW50XG4gICAgICovXG4gICAgdmFyIHRyYW5zbGF0ZUJ5SGFuZGxlciA9IGZ1bmN0aW9uICh0cmFuc2xhdGlvbklkLCBpbnRlcnBvbGF0ZVBhcmFtcywgZGVmYXVsdFRyYW5zbGF0aW9uVGV4dCwgc2FuaXRpemVTdHJhdGVneSkge1xuICAgICAgLy8gSWYgd2UgaGF2ZSBhIGhhbmRsZXIgZmFjdG9yeSAtIHdlIG1pZ2h0IGFsc28gY2FsbCBpdCBoZXJlIHRvIGRldGVybWluZSBpZiBpdCBwcm92aWRlc1xuICAgICAgLy8gYSBkZWZhdWx0IHRleHQgZm9yIGEgdHJhbnNsYXRpb25pZCB0aGF0IGNhbid0IGJlIGZvdW5kIGFueXdoZXJlIGluIG91ciB0YWJsZXNcbiAgICAgIGlmICgkbWlzc2luZ1RyYW5zbGF0aW9uSGFuZGxlckZhY3RvcnkpIHtcbiAgICAgICAgcmV0dXJuICRpbmplY3Rvci5nZXQoJG1pc3NpbmdUcmFuc2xhdGlvbkhhbmRsZXJGYWN0b3J5KSh0cmFuc2xhdGlvbklkLCAkdXNlcywgaW50ZXJwb2xhdGVQYXJhbXMsIGRlZmF1bHRUcmFuc2xhdGlvblRleHQsIHNhbml0aXplU3RyYXRlZ3kpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHRyYW5zbGF0aW9uSWQ7XG4gICAgICB9XG4gICAgfTtcblxuICAgIC8qKlxuICAgICAqIEBuYW1lIHJlc29sdmVGb3JGYWxsYmFja0xhbmd1YWdlXG4gICAgICogQHByaXZhdGVcbiAgICAgKlxuICAgICAqIFJlY3Vyc2l2ZSBoZWxwZXIgZnVuY3Rpb24gZm9yIGZhbGxiYWNrVHJhbnNsYXRpb24gdGhhdCB3aWxsIHNlcXVlbnRpYWxseSBsb29rXG4gICAgICogZm9yIGEgdHJhbnNsYXRpb24gaW4gdGhlIGZhbGxiYWNrTGFuZ3VhZ2VzIHN0YXJ0aW5nIHdpdGggZmFsbGJhY2tMYW5ndWFnZUluZGV4LlxuICAgICAqXG4gICAgICogQHBhcmFtIGZhbGxiYWNrTGFuZ3VhZ2VJbmRleFxuICAgICAqIEBwYXJhbSB0cmFuc2xhdGlvbklkXG4gICAgICogQHBhcmFtIGludGVycG9sYXRlUGFyYW1zXG4gICAgICogQHBhcmFtIEludGVycG9sYXRvclxuICAgICAqIEBwYXJhbSBkZWZhdWx0VHJhbnNsYXRpb25UZXh0XG4gICAgICogQHBhcmFtIHNhbml0aXplU3RyYXRlZ3lcbiAgICAgKiBAcmV0dXJucyB7US5wcm9taXNlfSBQcm9taXNlIHRoYXQgd2lsbCByZXNvbHZlIHRvIHRoZSB0cmFuc2xhdGlvbi5cbiAgICAgKi9cbiAgICB2YXIgcmVzb2x2ZUZvckZhbGxiYWNrTGFuZ3VhZ2UgPSBmdW5jdGlvbiAoZmFsbGJhY2tMYW5ndWFnZUluZGV4LCB0cmFuc2xhdGlvbklkLCBpbnRlcnBvbGF0ZVBhcmFtcywgSW50ZXJwb2xhdG9yLCBkZWZhdWx0VHJhbnNsYXRpb25UZXh0LCBzYW5pdGl6ZVN0cmF0ZWd5KSB7XG4gICAgICB2YXIgZGVmZXJyZWQgPSAkcS5kZWZlcigpO1xuXG4gICAgICBpZiAoZmFsbGJhY2tMYW5ndWFnZUluZGV4IDwgJGZhbGxiYWNrTGFuZ3VhZ2UubGVuZ3RoKSB7XG4gICAgICAgIHZhciBsYW5nS2V5ID0gJGZhbGxiYWNrTGFuZ3VhZ2VbZmFsbGJhY2tMYW5ndWFnZUluZGV4XTtcbiAgICAgICAgZ2V0RmFsbGJhY2tUcmFuc2xhdGlvbihsYW5nS2V5LCB0cmFuc2xhdGlvbklkLCBpbnRlcnBvbGF0ZVBhcmFtcywgSW50ZXJwb2xhdG9yLCBzYW5pdGl6ZVN0cmF0ZWd5KS50aGVuKFxuICAgICAgICAgIGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKGRhdGEpO1xuICAgICAgICAgIH0sXG4gICAgICAgICAgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgLy8gTG9vayBpbiB0aGUgbmV4dCBmYWxsYmFjayBsYW5ndWFnZSBmb3IgYSB0cmFuc2xhdGlvbi5cbiAgICAgICAgICAgIC8vIEl0IGRlbGF5cyB0aGUgcmVzb2x2aW5nIGJ5IHBhc3NpbmcgYW5vdGhlciBwcm9taXNlIHRvIHJlc29sdmUuXG4gICAgICAgICAgICByZXR1cm4gcmVzb2x2ZUZvckZhbGxiYWNrTGFuZ3VhZ2UoZmFsbGJhY2tMYW5ndWFnZUluZGV4ICsgMSwgdHJhbnNsYXRpb25JZCwgaW50ZXJwb2xhdGVQYXJhbXMsIEludGVycG9sYXRvciwgZGVmYXVsdFRyYW5zbGF0aW9uVGV4dCwgc2FuaXRpemVTdHJhdGVneSkudGhlbihkZWZlcnJlZC5yZXNvbHZlLCBkZWZlcnJlZC5yZWplY3QpO1xuICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIE5vIHRyYW5zbGF0aW9uIGZvdW5kIGluIGFueSBmYWxsYmFjayBsYW5ndWFnZVxuICAgICAgICAvLyBpZiBhIGRlZmF1bHQgdHJhbnNsYXRpb24gdGV4dCBpcyBzZXQgaW4gdGhlIGRpcmVjdGl2ZSwgdGhlbiByZXR1cm4gdGhpcyBhcyBhIHJlc3VsdFxuICAgICAgICBpZiAoZGVmYXVsdFRyYW5zbGF0aW9uVGV4dCkge1xuICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoZGVmYXVsdFRyYW5zbGF0aW9uVGV4dCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdmFyIG1pc3NpbmdUcmFuc2xhdGlvbkhhbmRsZXJUcmFuc2xhdGlvbiA9IHRyYW5zbGF0ZUJ5SGFuZGxlcih0cmFuc2xhdGlvbklkLCBpbnRlcnBvbGF0ZVBhcmFtcywgZGVmYXVsdFRyYW5zbGF0aW9uVGV4dCk7XG5cbiAgICAgICAgICAvLyBpZiBubyBkZWZhdWx0IHRyYW5zbGF0aW9uIGlzIHNldCBhbmQgYW4gZXJyb3IgaGFuZGxlciBpcyBkZWZpbmVkLCBzZW5kIGl0IHRvIHRoZSBoYW5kbGVyXG4gICAgICAgICAgLy8gYW5kIHRoZW4gcmV0dXJuIHRoZSByZXN1bHQgaWYgaXQgaXNuJ3QgdW5kZWZpbmVkXG4gICAgICAgICAgaWYgKCRtaXNzaW5nVHJhbnNsYXRpb25IYW5kbGVyRmFjdG9yeSAmJiBtaXNzaW5nVHJhbnNsYXRpb25IYW5kbGVyVHJhbnNsYXRpb24pIHtcbiAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUobWlzc2luZ1RyYW5zbGF0aW9uSGFuZGxlclRyYW5zbGF0aW9uKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0KGFwcGx5Tm90Rm91bmRJbmRpY2F0b3JzKHRyYW5zbGF0aW9uSWQpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlO1xuICAgIH07XG5cbiAgICAvKipcbiAgICAgKiBAbmFtZSByZXNvbHZlRm9yRmFsbGJhY2tMYW5ndWFnZUluc3RhbnRcbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqXG4gICAgICogUmVjdXJzaXZlIGhlbHBlciBmdW5jdGlvbiBmb3IgZmFsbGJhY2tUcmFuc2xhdGlvbiB0aGF0IHdpbGwgc2VxdWVudGlhbGx5IGxvb2tcbiAgICAgKiBmb3IgYSB0cmFuc2xhdGlvbiBpbiB0aGUgZmFsbGJhY2tMYW5ndWFnZXMgc3RhcnRpbmcgd2l0aCBmYWxsYmFja0xhbmd1YWdlSW5kZXguXG4gICAgICpcbiAgICAgKiBAcGFyYW0gZmFsbGJhY2tMYW5ndWFnZUluZGV4XG4gICAgICogQHBhcmFtIHRyYW5zbGF0aW9uSWRcbiAgICAgKiBAcGFyYW0gaW50ZXJwb2xhdGVQYXJhbXNcbiAgICAgKiBAcGFyYW0gSW50ZXJwb2xhdG9yXG4gICAgICogQHBhcmFtIHNhbml0aXplU3RyYXRlZ3lcbiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSB0cmFuc2xhdGlvblxuICAgICAqL1xuICAgIHZhciByZXNvbHZlRm9yRmFsbGJhY2tMYW5ndWFnZUluc3RhbnQgPSBmdW5jdGlvbiAoZmFsbGJhY2tMYW5ndWFnZUluZGV4LCB0cmFuc2xhdGlvbklkLCBpbnRlcnBvbGF0ZVBhcmFtcywgSW50ZXJwb2xhdG9yLCBzYW5pdGl6ZVN0cmF0ZWd5KSB7XG4gICAgICB2YXIgcmVzdWx0O1xuXG4gICAgICBpZiAoZmFsbGJhY2tMYW5ndWFnZUluZGV4IDwgJGZhbGxiYWNrTGFuZ3VhZ2UubGVuZ3RoKSB7XG4gICAgICAgIHZhciBsYW5nS2V5ID0gJGZhbGxiYWNrTGFuZ3VhZ2VbZmFsbGJhY2tMYW5ndWFnZUluZGV4XTtcbiAgICAgICAgcmVzdWx0ID0gZ2V0RmFsbGJhY2tUcmFuc2xhdGlvbkluc3RhbnQobGFuZ0tleSwgdHJhbnNsYXRpb25JZCwgaW50ZXJwb2xhdGVQYXJhbXMsIEludGVycG9sYXRvciwgc2FuaXRpemVTdHJhdGVneSk7XG4gICAgICAgIGlmICghcmVzdWx0ICYmIHJlc3VsdCAhPT0gJycpIHtcbiAgICAgICAgICByZXN1bHQgPSByZXNvbHZlRm9yRmFsbGJhY2tMYW5ndWFnZUluc3RhbnQoZmFsbGJhY2tMYW5ndWFnZUluZGV4ICsgMSwgdHJhbnNsYXRpb25JZCwgaW50ZXJwb2xhdGVQYXJhbXMsIEludGVycG9sYXRvcik7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfTtcblxuICAgIC8qKlxuICAgICAqIFRyYW5zbGF0ZXMgd2l0aCB0aGUgdXNhZ2Ugb2YgdGhlIGZhbGxiYWNrIGxhbmd1YWdlcy5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB0cmFuc2xhdGlvbklkXG4gICAgICogQHBhcmFtIGludGVycG9sYXRlUGFyYW1zXG4gICAgICogQHBhcmFtIEludGVycG9sYXRvclxuICAgICAqIEBwYXJhbSBkZWZhdWx0VHJhbnNsYXRpb25UZXh0XG4gICAgICogQHBhcmFtIHNhbml0aXplU3RyYXRlZ3lcbiAgICAgKiBAcmV0dXJucyB7US5wcm9taXNlfSBQcm9taXNlLCB0aGF0IHJlc29sdmVzIHRvIHRoZSB0cmFuc2xhdGlvbi5cbiAgICAgKi9cbiAgICB2YXIgZmFsbGJhY2tUcmFuc2xhdGlvbiA9IGZ1bmN0aW9uICh0cmFuc2xhdGlvbklkLCBpbnRlcnBvbGF0ZVBhcmFtcywgSW50ZXJwb2xhdG9yLCBkZWZhdWx0VHJhbnNsYXRpb25UZXh0LCBzYW5pdGl6ZVN0cmF0ZWd5KSB7XG4gICAgICAvLyBTdGFydCB3aXRoIHRoZSBmYWxsYmFja0xhbmd1YWdlIHdpdGggaW5kZXggMFxuICAgICAgcmV0dXJuIHJlc29sdmVGb3JGYWxsYmFja0xhbmd1YWdlKChzdGFydEZhbGxiYWNrSXRlcmF0aW9uID4gMCA/IHN0YXJ0RmFsbGJhY2tJdGVyYXRpb24gOiBmYWxsYmFja0luZGV4KSwgdHJhbnNsYXRpb25JZCwgaW50ZXJwb2xhdGVQYXJhbXMsIEludGVycG9sYXRvciwgZGVmYXVsdFRyYW5zbGF0aW9uVGV4dCwgc2FuaXRpemVTdHJhdGVneSk7XG4gICAgfTtcblxuICAgIC8qKlxuICAgICAqIFRyYW5zbGF0ZXMgd2l0aCB0aGUgdXNhZ2Ugb2YgdGhlIGZhbGxiYWNrIGxhbmd1YWdlcy5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB0cmFuc2xhdGlvbklkXG4gICAgICogQHBhcmFtIGludGVycG9sYXRlUGFyYW1zXG4gICAgICogQHBhcmFtIEludGVycG9sYXRvclxuICAgICAqIEBwYXJhbSBzYW5pdGl6ZVN0cmF0ZWd5XG4gICAgICogQHJldHVybnMge1N0cmluZ30gdHJhbnNsYXRpb25cbiAgICAgKi9cbiAgICB2YXIgZmFsbGJhY2tUcmFuc2xhdGlvbkluc3RhbnQgPSBmdW5jdGlvbiAodHJhbnNsYXRpb25JZCwgaW50ZXJwb2xhdGVQYXJhbXMsIEludGVycG9sYXRvciwgc2FuaXRpemVTdHJhdGVneSkge1xuICAgICAgLy8gU3RhcnQgd2l0aCB0aGUgZmFsbGJhY2tMYW5ndWFnZSB3aXRoIGluZGV4IDBcbiAgICAgIHJldHVybiByZXNvbHZlRm9yRmFsbGJhY2tMYW5ndWFnZUluc3RhbnQoKHN0YXJ0RmFsbGJhY2tJdGVyYXRpb24gPiAwID8gc3RhcnRGYWxsYmFja0l0ZXJhdGlvbiA6IGZhbGxiYWNrSW5kZXgpLCB0cmFuc2xhdGlvbklkLCBpbnRlcnBvbGF0ZVBhcmFtcywgSW50ZXJwb2xhdG9yLCBzYW5pdGl6ZVN0cmF0ZWd5KTtcbiAgICB9O1xuXG4gICAgdmFyIGRldGVybWluZVRyYW5zbGF0aW9uID0gZnVuY3Rpb24gKHRyYW5zbGF0aW9uSWQsIGludGVycG9sYXRlUGFyYW1zLCBpbnRlcnBvbGF0aW9uSWQsIGRlZmF1bHRUcmFuc2xhdGlvblRleHQsIHVzZXMsIHNhbml0aXplU3RyYXRlZ3kpIHtcblxuICAgICAgdmFyIGRlZmVycmVkID0gJHEuZGVmZXIoKTtcblxuICAgICAgdmFyIHRhYmxlID0gdXNlcyA/ICR0cmFuc2xhdGlvblRhYmxlW3VzZXNdIDogJHRyYW5zbGF0aW9uVGFibGUsXG4gICAgICAgIEludGVycG9sYXRvciA9IChpbnRlcnBvbGF0aW9uSWQpID8gaW50ZXJwb2xhdG9ySGFzaE1hcFtpbnRlcnBvbGF0aW9uSWRdIDogZGVmYXVsdEludGVycG9sYXRvcjtcblxuICAgICAgLy8gaWYgdGhlIHRyYW5zbGF0aW9uIGlkIGV4aXN0cywgd2UgY2FuIGp1c3QgaW50ZXJwb2xhdGUgaXRcbiAgICAgIGlmICh0YWJsZSAmJiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodGFibGUsIHRyYW5zbGF0aW9uSWQpICYmIHRhYmxlW3RyYW5zbGF0aW9uSWRdICE9PSBudWxsKSB7XG4gICAgICAgIHZhciB0cmFuc2xhdGlvbiA9IHRhYmxlW3RyYW5zbGF0aW9uSWRdO1xuXG4gICAgICAgIC8vIElmIHVzaW5nIGxpbmssIHJlcnVuICR0cmFuc2xhdGUgd2l0aCBsaW5rZWQgdHJhbnNsYXRpb25JZCBhbmQgcmV0dXJuIGl0XG4gICAgICAgIGlmICh0cmFuc2xhdGlvbi5zdWJzdHIoMCwgMikgPT09ICdAOicpIHtcblxuICAgICAgICAgICR0cmFuc2xhdGUodHJhbnNsYXRpb24uc3Vic3RyKDIpLCBpbnRlcnBvbGF0ZVBhcmFtcywgaW50ZXJwb2xhdGlvbklkLCBkZWZhdWx0VHJhbnNsYXRpb25UZXh0LCB1c2VzKVxuICAgICAgICAgICAgLnRoZW4oZGVmZXJyZWQucmVzb2x2ZSwgZGVmZXJyZWQucmVqZWN0KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvL1xuICAgICAgICAgIHZhciByZXNvbHZlZFRyYW5zbGF0aW9uID0gSW50ZXJwb2xhdG9yLmludGVycG9sYXRlKHRyYW5zbGF0aW9uLCBpbnRlcnBvbGF0ZVBhcmFtcywgJ3NlcnZpY2UnLCBzYW5pdGl6ZVN0cmF0ZWd5LCB0cmFuc2xhdGlvbklkKTtcbiAgICAgICAgICByZXNvbHZlZFRyYW5zbGF0aW9uID0gYXBwbHlQb3N0UHJvY2Vzc2luZyh0cmFuc2xhdGlvbklkLCB0cmFuc2xhdGlvbiwgcmVzb2x2ZWRUcmFuc2xhdGlvbiwgaW50ZXJwb2xhdGVQYXJhbXMsIHVzZXMpO1xuICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUocmVzb2x2ZWRUcmFuc2xhdGlvbik7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHZhciBtaXNzaW5nVHJhbnNsYXRpb25IYW5kbGVyVHJhbnNsYXRpb247XG4gICAgICAgIC8vIGZvciBsb2dnaW5nIHB1cnBvc2VzIG9ubHkgKGFzIGluICR0cmFuc2xhdGVNaXNzaW5nVHJhbnNsYXRpb25IYW5kbGVyTG9nKSwgdmFsdWUgaXMgbm90IHJldHVybmVkIHRvIHByb21pc2VcbiAgICAgICAgaWYgKCRtaXNzaW5nVHJhbnNsYXRpb25IYW5kbGVyRmFjdG9yeSAmJiAhcGVuZGluZ0xvYWRlcikge1xuICAgICAgICAgIG1pc3NpbmdUcmFuc2xhdGlvbkhhbmRsZXJUcmFuc2xhdGlvbiA9IHRyYW5zbGF0ZUJ5SGFuZGxlcih0cmFuc2xhdGlvbklkLCBpbnRlcnBvbGF0ZVBhcmFtcywgZGVmYXVsdFRyYW5zbGF0aW9uVGV4dCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBzaW5jZSB3ZSBjb3VsZG4ndCB0cmFuc2xhdGUgdGhlIGluaXRhbCByZXF1ZXN0ZWQgdHJhbnNsYXRpb24gaWQsXG4gICAgICAgIC8vIHdlIHRyeSBpdCBub3cgd2l0aCBvbmUgb3IgbW9yZSBmYWxsYmFjayBsYW5ndWFnZXMsIGlmIGZhbGxiYWNrIGxhbmd1YWdlKHMpIGlzXG4gICAgICAgIC8vIGNvbmZpZ3VyZWQuXG4gICAgICAgIGlmICh1c2VzICYmICRmYWxsYmFja0xhbmd1YWdlICYmICRmYWxsYmFja0xhbmd1YWdlLmxlbmd0aCkge1xuICAgICAgICAgIGZhbGxiYWNrVHJhbnNsYXRpb24odHJhbnNsYXRpb25JZCwgaW50ZXJwb2xhdGVQYXJhbXMsIEludGVycG9sYXRvciwgZGVmYXVsdFRyYW5zbGF0aW9uVGV4dCwgc2FuaXRpemVTdHJhdGVneSlcbiAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uICh0cmFuc2xhdGlvbikge1xuICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHRyYW5zbGF0aW9uKTtcbiAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChfdHJhbnNsYXRpb25JZCkge1xuICAgICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoYXBwbHlOb3RGb3VuZEluZGljYXRvcnMoX3RyYW5zbGF0aW9uSWQpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2UgaWYgKCRtaXNzaW5nVHJhbnNsYXRpb25IYW5kbGVyRmFjdG9yeSAmJiAhcGVuZGluZ0xvYWRlciAmJiBtaXNzaW5nVHJhbnNsYXRpb25IYW5kbGVyVHJhbnNsYXRpb24pIHtcbiAgICAgICAgICAvLyBsb29rcyBsaWtlIHRoZSByZXF1ZXN0ZWQgdHJhbnNsYXRpb24gaWQgZG9lc24ndCBleGlzdHMuXG4gICAgICAgICAgLy8gTm93LCBpZiB0aGVyZSBpcyBhIHJlZ2lzdGVyZWQgaGFuZGxlciBmb3IgbWlzc2luZyB0cmFuc2xhdGlvbnMgYW5kIG5vXG4gICAgICAgICAgLy8gYXN5bmNMb2FkZXIgaXMgcGVuZGluZywgd2UgZXhlY3V0ZSB0aGUgaGFuZGxlclxuICAgICAgICAgIGlmIChkZWZhdWx0VHJhbnNsYXRpb25UZXh0KSB7XG4gICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKGRlZmF1bHRUcmFuc2xhdGlvblRleHQpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKG1pc3NpbmdUcmFuc2xhdGlvbkhhbmRsZXJUcmFuc2xhdGlvbik7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmIChkZWZhdWx0VHJhbnNsYXRpb25UZXh0KSB7XG4gICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKGRlZmF1bHRUcmFuc2xhdGlvblRleHQpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoYXBwbHlOb3RGb3VuZEluZGljYXRvcnModHJhbnNsYXRpb25JZCkpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7XG4gICAgfTtcblxuICAgIHZhciBkZXRlcm1pbmVUcmFuc2xhdGlvbkluc3RhbnQgPSBmdW5jdGlvbiAodHJhbnNsYXRpb25JZCwgaW50ZXJwb2xhdGVQYXJhbXMsIGludGVycG9sYXRpb25JZCwgdXNlcywgc2FuaXRpemVTdHJhdGVneSkge1xuXG4gICAgICB2YXIgcmVzdWx0LCB0YWJsZSA9IHVzZXMgPyAkdHJhbnNsYXRpb25UYWJsZVt1c2VzXSA6ICR0cmFuc2xhdGlvblRhYmxlLFxuICAgICAgICBJbnRlcnBvbGF0b3IgPSBkZWZhdWx0SW50ZXJwb2xhdG9yO1xuXG4gICAgICAvLyBpZiB0aGUgaW50ZXJwb2xhdGlvbiBpZCBleGlzdHMgdXNlIGN1c3RvbSBpbnRlcnBvbGF0b3JcbiAgICAgIGlmIChpbnRlcnBvbGF0b3JIYXNoTWFwICYmIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChpbnRlcnBvbGF0b3JIYXNoTWFwLCBpbnRlcnBvbGF0aW9uSWQpKSB7XG4gICAgICAgIEludGVycG9sYXRvciA9IGludGVycG9sYXRvckhhc2hNYXBbaW50ZXJwb2xhdGlvbklkXTtcbiAgICAgIH1cblxuICAgICAgLy8gaWYgdGhlIHRyYW5zbGF0aW9uIGlkIGV4aXN0cywgd2UgY2FuIGp1c3QgaW50ZXJwb2xhdGUgaXRcbiAgICAgIGlmICh0YWJsZSAmJiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodGFibGUsIHRyYW5zbGF0aW9uSWQpICYmIHRhYmxlW3RyYW5zbGF0aW9uSWRdICE9PSBudWxsKSB7XG4gICAgICAgIHZhciB0cmFuc2xhdGlvbiA9IHRhYmxlW3RyYW5zbGF0aW9uSWRdO1xuXG4gICAgICAgIC8vIElmIHVzaW5nIGxpbmssIHJlcnVuICR0cmFuc2xhdGUgd2l0aCBsaW5rZWQgdHJhbnNsYXRpb25JZCBhbmQgcmV0dXJuIGl0XG4gICAgICAgIGlmICh0cmFuc2xhdGlvbi5zdWJzdHIoMCwgMikgPT09ICdAOicpIHtcbiAgICAgICAgICByZXN1bHQgPSBkZXRlcm1pbmVUcmFuc2xhdGlvbkluc3RhbnQodHJhbnNsYXRpb24uc3Vic3RyKDIpLCBpbnRlcnBvbGF0ZVBhcmFtcywgaW50ZXJwb2xhdGlvbklkLCB1c2VzLCBzYW5pdGl6ZVN0cmF0ZWd5KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHQgPSBJbnRlcnBvbGF0b3IuaW50ZXJwb2xhdGUodHJhbnNsYXRpb24sIGludGVycG9sYXRlUGFyYW1zLCAnZmlsdGVyJywgc2FuaXRpemVTdHJhdGVneSwgdHJhbnNsYXRpb25JZCk7XG4gICAgICAgICAgcmVzdWx0ID0gYXBwbHlQb3N0UHJvY2Vzc2luZyh0cmFuc2xhdGlvbklkLCB0cmFuc2xhdGlvbiwgcmVzdWx0LCBpbnRlcnBvbGF0ZVBhcmFtcywgdXNlcywgc2FuaXRpemVTdHJhdGVneSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHZhciBtaXNzaW5nVHJhbnNsYXRpb25IYW5kbGVyVHJhbnNsYXRpb247XG4gICAgICAgIC8vIGZvciBsb2dnaW5nIHB1cnBvc2VzIG9ubHkgKGFzIGluICR0cmFuc2xhdGVNaXNzaW5nVHJhbnNsYXRpb25IYW5kbGVyTG9nKSwgdmFsdWUgaXMgbm90IHJldHVybmVkIHRvIHByb21pc2VcbiAgICAgICAgaWYgKCRtaXNzaW5nVHJhbnNsYXRpb25IYW5kbGVyRmFjdG9yeSAmJiAhcGVuZGluZ0xvYWRlcikge1xuICAgICAgICAgIG1pc3NpbmdUcmFuc2xhdGlvbkhhbmRsZXJUcmFuc2xhdGlvbiA9IHRyYW5zbGF0ZUJ5SGFuZGxlcih0cmFuc2xhdGlvbklkLCBpbnRlcnBvbGF0ZVBhcmFtcywgc2FuaXRpemVTdHJhdGVneSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBzaW5jZSB3ZSBjb3VsZG4ndCB0cmFuc2xhdGUgdGhlIGluaXRhbCByZXF1ZXN0ZWQgdHJhbnNsYXRpb24gaWQsXG4gICAgICAgIC8vIHdlIHRyeSBpdCBub3cgd2l0aCBvbmUgb3IgbW9yZSBmYWxsYmFjayBsYW5ndWFnZXMsIGlmIGZhbGxiYWNrIGxhbmd1YWdlKHMpIGlzXG4gICAgICAgIC8vIGNvbmZpZ3VyZWQuXG4gICAgICAgIGlmICh1c2VzICYmICRmYWxsYmFja0xhbmd1YWdlICYmICRmYWxsYmFja0xhbmd1YWdlLmxlbmd0aCkge1xuICAgICAgICAgIGZhbGxiYWNrSW5kZXggPSAwO1xuICAgICAgICAgIHJlc3VsdCA9IGZhbGxiYWNrVHJhbnNsYXRpb25JbnN0YW50KHRyYW5zbGF0aW9uSWQsIGludGVycG9sYXRlUGFyYW1zLCBJbnRlcnBvbGF0b3IsIHNhbml0aXplU3RyYXRlZ3kpO1xuICAgICAgICB9IGVsc2UgaWYgKCRtaXNzaW5nVHJhbnNsYXRpb25IYW5kbGVyRmFjdG9yeSAmJiAhcGVuZGluZ0xvYWRlciAmJiBtaXNzaW5nVHJhbnNsYXRpb25IYW5kbGVyVHJhbnNsYXRpb24pIHtcbiAgICAgICAgICAvLyBsb29rcyBsaWtlIHRoZSByZXF1ZXN0ZWQgdHJhbnNsYXRpb24gaWQgZG9lc24ndCBleGlzdHMuXG4gICAgICAgICAgLy8gTm93LCBpZiB0aGVyZSBpcyBhIHJlZ2lzdGVyZWQgaGFuZGxlciBmb3IgbWlzc2luZyB0cmFuc2xhdGlvbnMgYW5kIG5vXG4gICAgICAgICAgLy8gYXN5bmNMb2FkZXIgaXMgcGVuZGluZywgd2UgZXhlY3V0ZSB0aGUgaGFuZGxlclxuICAgICAgICAgIHJlc3VsdCA9IG1pc3NpbmdUcmFuc2xhdGlvbkhhbmRsZXJUcmFuc2xhdGlvbjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHQgPSBhcHBseU5vdEZvdW5kSW5kaWNhdG9ycyh0cmFuc2xhdGlvbklkKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH07XG5cbiAgICB2YXIgY2xlYXJOZXh0TGFuZ0FuZFByb21pc2UgPSBmdW5jdGlvbiAoa2V5KSB7XG4gICAgICBpZiAoJG5leHRMYW5nID09PSBrZXkpIHtcbiAgICAgICAgJG5leHRMYW5nID0gdW5kZWZpbmVkO1xuICAgICAgfVxuICAgICAgbGFuZ1Byb21pc2VzW2tleV0gPSB1bmRlZmluZWQ7XG4gICAgfTtcblxuICAgIHZhciBhcHBseVBvc3RQcm9jZXNzaW5nID0gZnVuY3Rpb24gKHRyYW5zbGF0aW9uSWQsIHRyYW5zbGF0aW9uLCByZXNvbHZlZFRyYW5zbGF0aW9uLCBpbnRlcnBvbGF0ZVBhcmFtcywgdXNlcywgc2FuaXRpemVTdHJhdGVneSkge1xuICAgICAgdmFyIGZuID0gcG9zdFByb2Nlc3NGbjtcblxuICAgICAgaWYgKGZuKSB7XG5cbiAgICAgICAgaWYgKHR5cGVvZihmbikgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgLy8gZ2V0dGluZyBvbi1kZW1hbmQgaW5zdGFuY2VcbiAgICAgICAgICBmbiA9ICRpbmplY3Rvci5nZXQoZm4pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChmbikge1xuICAgICAgICAgIHJldHVybiBmbih0cmFuc2xhdGlvbklkLCB0cmFuc2xhdGlvbiwgcmVzb2x2ZWRUcmFuc2xhdGlvbiwgaW50ZXJwb2xhdGVQYXJhbXMsIHVzZXMsIHNhbml0aXplU3RyYXRlZ3kpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZXNvbHZlZFRyYW5zbGF0aW9uO1xuICAgIH07XG5cbiAgICB2YXIgbG9hZFRyYW5zbGF0aW9uc0lmTWlzc2luZyA9IGZ1bmN0aW9uIChrZXkpIHtcbiAgICAgIGlmICghJHRyYW5zbGF0aW9uVGFibGVba2V5XSAmJiAkbG9hZGVyRmFjdG9yeSAmJiAhbGFuZ1Byb21pc2VzW2tleV0pIHtcbiAgICAgICAgbGFuZ1Byb21pc2VzW2tleV0gPSBsb2FkQXN5bmMoa2V5KS50aGVuKGZ1bmN0aW9uICh0cmFuc2xhdGlvbikge1xuICAgICAgICAgIHRyYW5zbGF0aW9ucyh0cmFuc2xhdGlvbi5rZXksIHRyYW5zbGF0aW9uLnRhYmxlKTtcbiAgICAgICAgICByZXR1cm4gdHJhbnNsYXRpb247XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH07XG5cbiAgICAvKipcbiAgICAgKiBAbmdkb2MgZnVuY3Rpb25cbiAgICAgKiBAbmFtZSBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGUjcHJlZmVycmVkTGFuZ3VhZ2VcbiAgICAgKiBAbWV0aG9kT2YgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlXG4gICAgICpcbiAgICAgKiBAZGVzY3JpcHRpb25cbiAgICAgKiBSZXR1cm5zIHRoZSBsYW5ndWFnZSBrZXkgZm9yIHRoZSBwcmVmZXJyZWQgbGFuZ3VhZ2UuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbGFuZ0tleSBsYW5ndWFnZSBTdHJpbmcgb3IgQXJyYXkgdG8gYmUgdXNlZCBhcyBwcmVmZXJyZWRMYW5ndWFnZSAoY2hhbmdpbmcgYXQgcnVudGltZSlcbiAgICAgKlxuICAgICAqIEByZXR1cm4ge3N0cmluZ30gcHJlZmVycmVkIGxhbmd1YWdlIGtleVxuICAgICAqL1xuICAgICR0cmFuc2xhdGUucHJlZmVycmVkTGFuZ3VhZ2UgPSBmdW5jdGlvbiAobGFuZ0tleSkge1xuICAgICAgaWYgKGxhbmdLZXkpIHtcbiAgICAgICAgc2V0dXBQcmVmZXJyZWRMYW5ndWFnZShsYW5nS2V5KTtcbiAgICAgIH1cbiAgICAgIHJldHVybiAkcHJlZmVycmVkTGFuZ3VhZ2U7XG4gICAgfTtcblxuICAgIC8qKlxuICAgICAqIEBuZ2RvYyBmdW5jdGlvblxuICAgICAqIEBuYW1lIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZSNjbG9ha0NsYXNzTmFtZVxuICAgICAqIEBtZXRob2RPZiBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVcbiAgICAgKlxuICAgICAqIEBkZXNjcmlwdGlvblxuICAgICAqIFJldHVybnMgdGhlIGNvbmZpZ3VyZWQgY2xhc3MgbmFtZSBmb3IgYHRyYW5zbGF0ZS1jbG9ha2AgZGlyZWN0aXZlLlxuICAgICAqXG4gICAgICogQHJldHVybiB7c3RyaW5nfSBjbG9ha0NsYXNzTmFtZVxuICAgICAqL1xuICAgICR0cmFuc2xhdGUuY2xvYWtDbGFzc05hbWUgPSBmdW5jdGlvbiAoKSB7XG4gICAgICByZXR1cm4gJGNsb2FrQ2xhc3NOYW1lO1xuICAgIH07XG5cbiAgICAvKipcbiAgICAgKiBAbmdkb2MgZnVuY3Rpb25cbiAgICAgKiBAbmFtZSBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGUjbmVzdGVkT2JqZWN0RGVsaW1ldGVyXG4gICAgICogQG1ldGhvZE9mIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVxuICAgICAqXG4gICAgICogQGRlc2NyaXB0aW9uXG4gICAgICogUmV0dXJucyB0aGUgY29uZmlndXJlZCBkZWxpbWl0ZXIgZm9yIG5lc3RlZCBuYW1lc3BhY2VzLlxuICAgICAqXG4gICAgICogQHJldHVybiB7c3RyaW5nfSBuZXN0ZWRPYmplY3REZWxpbWV0ZXJcbiAgICAgKi9cbiAgICAkdHJhbnNsYXRlLm5lc3RlZE9iamVjdERlbGltZXRlciA9IGZ1bmN0aW9uICgpIHtcbiAgICAgIHJldHVybiAkbmVzdGVkT2JqZWN0RGVsaW1ldGVyO1xuICAgIH07XG5cbiAgICAvKipcbiAgICAgKiBAbmdkb2MgZnVuY3Rpb25cbiAgICAgKiBAbmFtZSBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGUjZmFsbGJhY2tMYW5ndWFnZVxuICAgICAqIEBtZXRob2RPZiBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVcbiAgICAgKlxuICAgICAqIEBkZXNjcmlwdGlvblxuICAgICAqIFJldHVybnMgdGhlIGxhbmd1YWdlIGtleSBmb3IgdGhlIGZhbGxiYWNrIGxhbmd1YWdlcyBvciBzZXRzIGEgbmV3IGZhbGxiYWNrIHN0YWNrLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtzdHJpbmc9fSBsYW5nS2V5IGxhbmd1YWdlIFN0cmluZyBvciBBcnJheSBvZiBmYWxsYmFjayBsYW5ndWFnZXMgdG8gYmUgdXNlZCAodG8gY2hhbmdlIHN0YWNrIGF0IHJ1bnRpbWUpXG4gICAgICpcbiAgICAgKiBAcmV0dXJuIHtzdHJpbmd8fGFycmF5fSBmYWxsYmFjayBsYW5ndWFnZSBrZXlcbiAgICAgKi9cbiAgICAkdHJhbnNsYXRlLmZhbGxiYWNrTGFuZ3VhZ2UgPSBmdW5jdGlvbiAobGFuZ0tleSkge1xuICAgICAgaWYgKGxhbmdLZXkgIT09IHVuZGVmaW5lZCAmJiBsYW5nS2V5ICE9PSBudWxsKSB7XG4gICAgICAgIGZhbGxiYWNrU3RhY2sobGFuZ0tleSk7XG5cbiAgICAgICAgLy8gYXMgd2UgbWlnaHQgaGF2ZSBhbiBhc3luYyBsb2FkZXIgaW5pdGlhdGVkIGFuZCBhIG5ldyB0cmFuc2xhdGlvbiBsYW5ndWFnZSBtaWdodCBoYXZlIGJlZW4gZGVmaW5lZFxuICAgICAgICAvLyB3ZSBuZWVkIHRvIGFkZCB0aGUgcHJvbWlzZSB0byB0aGUgc3RhY2sgYWxzby4gU28gLSBpdGVyYXRlLlxuICAgICAgICBpZiAoJGxvYWRlckZhY3RvcnkpIHtcbiAgICAgICAgICBpZiAoJGZhbGxiYWNrTGFuZ3VhZ2UgJiYgJGZhbGxiYWNrTGFuZ3VhZ2UubGVuZ3RoKSB7XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gJGZhbGxiYWNrTGFuZ3VhZ2UubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHtcbiAgICAgICAgICAgICAgaWYgKCFsYW5nUHJvbWlzZXNbJGZhbGxiYWNrTGFuZ3VhZ2VbaV1dKSB7XG4gICAgICAgICAgICAgICAgbGFuZ1Byb21pc2VzWyRmYWxsYmFja0xhbmd1YWdlW2ldXSA9IGxvYWRBc3luYygkZmFsbGJhY2tMYW5ndWFnZVtpXSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgJHRyYW5zbGF0ZS51c2UoJHRyYW5zbGF0ZS51c2UoKSk7XG4gICAgICB9XG4gICAgICBpZiAoJGZhbGxiYWNrV2FzU3RyaW5nKSB7XG4gICAgICAgIHJldHVybiAkZmFsbGJhY2tMYW5ndWFnZVswXTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiAkZmFsbGJhY2tMYW5ndWFnZTtcbiAgICAgIH1cblxuICAgIH07XG5cbiAgICAvKipcbiAgICAgKiBAbmdkb2MgZnVuY3Rpb25cbiAgICAgKiBAbmFtZSBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGUjdXNlRmFsbGJhY2tMYW5ndWFnZVxuICAgICAqIEBtZXRob2RPZiBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVcbiAgICAgKlxuICAgICAqIEBkZXNjcmlwdGlvblxuICAgICAqIFNldHMgdGhlIGZpcnN0IGtleSBvZiB0aGUgZmFsbGJhY2sgbGFuZ3VhZ2Ugc3RhY2sgdG8gYmUgdXNlZCBmb3IgdHJhbnNsYXRpb24uXG4gICAgICogVGhlcmVmb3JlIGFsbCBsYW5ndWFnZXMgaW4gdGhlIGZhbGxiYWNrIGFycmF5IEJFRk9SRSB0aGlzIGtleSB3aWxsIGJlIHNraXBwZWQhXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge3N0cmluZz19IGxhbmdLZXkgQ29udGFpbnMgdGhlIGxhbmdLZXkgdGhlIGl0ZXJhdGlvbiBzaGFsbCBzdGFydCB3aXRoLiBTZXQgdG8gZmFsc2UgaWYgeW91IHdhbnQgdG9cbiAgICAgKiBnZXQgYmFjayB0byB0aGUgd2hvbGUgc3RhY2tcbiAgICAgKi9cbiAgICAkdHJhbnNsYXRlLnVzZUZhbGxiYWNrTGFuZ3VhZ2UgPSBmdW5jdGlvbiAobGFuZ0tleSkge1xuICAgICAgaWYgKGxhbmdLZXkgIT09IHVuZGVmaW5lZCAmJiBsYW5nS2V5ICE9PSBudWxsKSB7XG4gICAgICAgIGlmICghbGFuZ0tleSkge1xuICAgICAgICAgIHN0YXJ0RmFsbGJhY2tJdGVyYXRpb24gPSAwO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHZhciBsYW5nS2V5UG9zaXRpb24gPSBpbmRleE9mKCRmYWxsYmFja0xhbmd1YWdlLCBsYW5nS2V5KTtcbiAgICAgICAgICBpZiAobGFuZ0tleVBvc2l0aW9uID4gLTEpIHtcbiAgICAgICAgICAgIHN0YXJ0RmFsbGJhY2tJdGVyYXRpb24gPSBsYW5nS2V5UG9zaXRpb247XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgIH1cblxuICAgIH07XG5cbiAgICAvKipcbiAgICAgKiBAbmdkb2MgZnVuY3Rpb25cbiAgICAgKiBAbmFtZSBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGUjcHJvcG9zZWRMYW5ndWFnZVxuICAgICAqIEBtZXRob2RPZiBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVcbiAgICAgKlxuICAgICAqIEBkZXNjcmlwdGlvblxuICAgICAqIFJldHVybnMgdGhlIGxhbmd1YWdlIGtleSBvZiBsYW5ndWFnZSB0aGF0IGlzIGN1cnJlbnRseSBsb2FkZWQgYXN5bmNocm9ub3VzbHkuXG4gICAgICpcbiAgICAgKiBAcmV0dXJuIHtzdHJpbmd9IGxhbmd1YWdlIGtleVxuICAgICAqL1xuICAgICR0cmFuc2xhdGUucHJvcG9zZWRMYW5ndWFnZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgIHJldHVybiAkbmV4dExhbmc7XG4gICAgfTtcblxuICAgIC8qKlxuICAgICAqIEBuZ2RvYyBmdW5jdGlvblxuICAgICAqIEBuYW1lIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZSNzdG9yYWdlXG4gICAgICogQG1ldGhvZE9mIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVxuICAgICAqXG4gICAgICogQGRlc2NyaXB0aW9uXG4gICAgICogUmV0dXJucyByZWdpc3RlcmVkIHN0b3JhZ2UuXG4gICAgICpcbiAgICAgKiBAcmV0dXJuIHtvYmplY3R9IFN0b3JhZ2VcbiAgICAgKi9cbiAgICAkdHJhbnNsYXRlLnN0b3JhZ2UgPSBmdW5jdGlvbiAoKSB7XG4gICAgICByZXR1cm4gU3RvcmFnZTtcbiAgICB9O1xuXG4gICAgLyoqXG4gICAgICogQG5nZG9jIGZ1bmN0aW9uXG4gICAgICogQG5hbWUgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlI25lZ290aWF0ZUxvY2FsZVxuICAgICAqIEBtZXRob2RPZiBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVcbiAgICAgKlxuICAgICAqIEBkZXNjcmlwdGlvblxuICAgICAqIFJldHVybnMgYSBsYW5ndWFnZSBrZXkgYmFzZWQgb24gYXZhaWxhYmxlIGxhbmd1YWdlcyBhbmQgbGFuZ3VhZ2UgYWxpYXNlcy4gSWYgYVxuICAgICAqIGxhbmd1YWdlIGtleSBjYW5ub3QgYmUgcmVzb2x2ZWQsIHJldHVybnMgdW5kZWZpbmVkLlxuICAgICAqXG4gICAgICogSWYgbm8gb3IgYSBmYWxzeSBrZXkgaXMgZ2l2ZW4sIHJldHVybnMgdW5kZWZpbmVkLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IFtrZXldIExhbmd1YWdlIGtleVxuICAgICAqIEByZXR1cm4ge3N0cmluZ3x1bmRlZmluZWR9IExhbmd1YWdlIGtleSBvciB1bmRlZmluZWQgaWYgbm8gbGFuZ3VhZ2Uga2V5IGlzIGZvdW5kLlxuICAgICAqL1xuICAgICR0cmFuc2xhdGUubmVnb3RpYXRlTG9jYWxlID0gbmVnb3RpYXRlTG9jYWxlO1xuXG4gICAgLyoqXG4gICAgICogQG5nZG9jIGZ1bmN0aW9uXG4gICAgICogQG5hbWUgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlI3VzZVxuICAgICAqIEBtZXRob2RPZiBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVcbiAgICAgKlxuICAgICAqIEBkZXNjcmlwdGlvblxuICAgICAqIFRlbGxzIGFuZ3VsYXItdHJhbnNsYXRlIHdoaWNoIGxhbmd1YWdlIHRvIHVzZSBieSBnaXZlbiBsYW5ndWFnZSBrZXkuIFRoaXMgbWV0aG9kIGlzXG4gICAgICogdXNlZCB0byBjaGFuZ2UgbGFuZ3VhZ2UgYXQgcnVudGltZS4gSXQgYWxzbyB0YWtlcyBjYXJlIG9mIHN0b3JpbmcgdGhlIGxhbmd1YWdlXG4gICAgICoga2V5IGluIGEgY29uZmlndXJlZCBzdG9yZSB0byBsZXQgeW91ciBhcHAgcmVtZW1iZXIgdGhlIGNob29zZWQgbGFuZ3VhZ2UuXG4gICAgICpcbiAgICAgKiBXaGVuIHRyeWluZyB0byAndXNlJyBhIGxhbmd1YWdlIHdoaWNoIGlzbid0IGF2YWlsYWJsZSBpdCB0cmllcyB0byBsb2FkIGl0XG4gICAgICogYXN5bmNocm9ub3VzbHkgd2l0aCByZWdpc3RlcmVkIGxvYWRlcnMuXG4gICAgICpcbiAgICAgKiBSZXR1cm5zIHByb21pc2Ugb2JqZWN0IHdpdGggbG9hZGVkIGxhbmd1YWdlIGZpbGUgZGF0YSBvciBzdHJpbmcgb2YgdGhlIGN1cnJlbnRseSB1c2VkIGxhbmd1YWdlLlxuICAgICAqXG4gICAgICogSWYgbm8gb3IgYSBmYWxzeSBrZXkgaXMgZ2l2ZW4gaXQgcmV0dXJucyB0aGUgY3VycmVudGx5IHVzZWQgbGFuZ3VhZ2Uga2V5LlxuICAgICAqIFRoZSByZXR1cm5lZCBzdHJpbmcgd2lsbCBiZSBgYGB1bmRlZmluZWRgYGAgaWYgc2V0dGluZyB1cCAkdHJhbnNsYXRlIGhhc24ndCBmaW5pc2hlZC5cbiAgICAgKiBAZXhhbXBsZVxuICAgICAqICR0cmFuc2xhdGUudXNlKFwiZW5fVVNcIikudGhlbihmdW5jdGlvbihkYXRhKXtcbiAgICAgICAqICAgJHNjb3BlLnRleHQgPSAkdHJhbnNsYXRlKFwiSEVMTE9cIik7XG4gICAgICAgKiB9KTtcbiAgICAgKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBba2V5XSBMYW5ndWFnZSBrZXlcbiAgICAgKiBAcmV0dXJuIHtvYmplY3R8c3RyaW5nfSBQcm9taXNlIHdpdGggbG9hZGVkIGxhbmd1YWdlIGRhdGEgb3IgdGhlIGxhbmd1YWdlIGtleSBpZiBhIGZhbHN5IHBhcmFtIHdhcyBnaXZlbi5cbiAgICAgKi9cbiAgICAkdHJhbnNsYXRlLnVzZSA9IGZ1bmN0aW9uIChrZXkpIHtcbiAgICAgIGlmICgha2V5KSB7XG4gICAgICAgIHJldHVybiAkdXNlcztcbiAgICAgIH1cblxuICAgICAgdmFyIGRlZmVycmVkID0gJHEuZGVmZXIoKTtcbiAgICAgIGRlZmVycmVkLnByb21pc2UudGhlbihudWxsLCBhbmd1bGFyLm5vb3ApOyAvLyBBSlMgXCJQb3NzaWJseSB1bmhhbmRsZWQgcmVqZWN0aW9uXCJcblxuICAgICAgJHJvb3RTY29wZS4kZW1pdCgnJHRyYW5zbGF0ZUNoYW5nZVN0YXJ0Jywge2xhbmd1YWdlIDoga2V5fSk7XG5cbiAgICAgIC8vIFRyeSB0byBnZXQgdGhlIGFsaWFzZWQgbGFuZ3VhZ2Uga2V5XG4gICAgICB2YXIgYWxpYXNlZEtleSA9IG5lZ290aWF0ZUxvY2FsZShrZXkpO1xuICAgICAgLy8gRW5zdXJlIG9ubHkgcmVnaXN0ZXJlZCBsYW5ndWFnZSBrZXlzIHdpbGwgYmUgbG9hZGVkXG4gICAgICBpZiAoJGF2YWlsYWJsZUxhbmd1YWdlS2V5cy5sZW5ndGggPiAwICYmICFhbGlhc2VkS2V5KSB7XG4gICAgICAgIHJldHVybiAkcS5yZWplY3Qoa2V5KTtcbiAgICAgIH1cblxuICAgICAgaWYgKGFsaWFzZWRLZXkpIHtcbiAgICAgICAga2V5ID0gYWxpYXNlZEtleTtcbiAgICAgIH1cblxuICAgICAgLy8gaWYgdGhlcmUgaXNuJ3QgYSB0cmFuc2xhdGlvbiB0YWJsZSBmb3IgdGhlIGxhbmd1YWdlIHdlJ3ZlIHJlcXVlc3RlZCxcbiAgICAgIC8vIHdlIGxvYWQgaXQgYXN5bmNocm9ub3VzbHlcbiAgICAgICRuZXh0TGFuZyA9IGtleTtcbiAgICAgIGlmICgoJGZvcmNlQXN5bmNSZWxvYWRFbmFibGVkIHx8ICEkdHJhbnNsYXRpb25UYWJsZVtrZXldKSAmJiAkbG9hZGVyRmFjdG9yeSAmJiAhbGFuZ1Byb21pc2VzW2tleV0pIHtcbiAgICAgICAgbGFuZ1Byb21pc2VzW2tleV0gPSBsb2FkQXN5bmMoa2V5KS50aGVuKGZ1bmN0aW9uICh0cmFuc2xhdGlvbikge1xuICAgICAgICAgIHRyYW5zbGF0aW9ucyh0cmFuc2xhdGlvbi5rZXksIHRyYW5zbGF0aW9uLnRhYmxlKTtcbiAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHRyYW5zbGF0aW9uLmtleSk7XG4gICAgICAgICAgaWYgKCRuZXh0TGFuZyA9PT0ga2V5KSB7XG4gICAgICAgICAgICB1c2VMYW5ndWFnZSh0cmFuc2xhdGlvbi5rZXkpO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gdHJhbnNsYXRpb247XG4gICAgICAgIH0sIGZ1bmN0aW9uIChrZXkpIHtcbiAgICAgICAgICAkcm9vdFNjb3BlLiRlbWl0KCckdHJhbnNsYXRlQ2hhbmdlRXJyb3InLCB7bGFuZ3VhZ2UgOiBrZXl9KTtcbiAgICAgICAgICBkZWZlcnJlZC5yZWplY3Qoa2V5KTtcbiAgICAgICAgICAkcm9vdFNjb3BlLiRlbWl0KCckdHJhbnNsYXRlQ2hhbmdlRW5kJywge2xhbmd1YWdlIDoga2V5fSk7XG4gICAgICAgICAgcmV0dXJuICRxLnJlamVjdChrZXkpO1xuICAgICAgICB9KTtcbiAgICAgICAgbGFuZ1Byb21pc2VzW2tleV1bJ2ZpbmFsbHknXShmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgY2xlYXJOZXh0TGFuZ0FuZFByb21pc2Uoa2V5KTtcbiAgICAgICAgfSlbJ2NhdGNoJ10oYW5ndWxhci5ub29wKTsgLy8gd2UgZG9uJ3QgY2FyZSBhYm91dCBlcnJvcnMgKGNsZWFyaW5nKVxuICAgICAgfSBlbHNlIGlmIChsYW5nUHJvbWlzZXNba2V5XSkge1xuICAgICAgICAvLyB3ZSBhcmUgYWxyZWFkeSBsb2FkaW5nIHRoaXMgYXN5bmNocm9ub3VzbHlcbiAgICAgICAgLy8gcmVzb2x2ZSBvdXIgbmV3IGRlZmVycmVkIHdoZW4gdGhlIG9sZCBsYW5nUHJvbWlzZSBpcyByZXNvbHZlZFxuICAgICAgICBsYW5nUHJvbWlzZXNba2V5XS50aGVuKGZ1bmN0aW9uICh0cmFuc2xhdGlvbikge1xuICAgICAgICAgIGlmICgkbmV4dExhbmcgPT09IHRyYW5zbGF0aW9uLmtleSkge1xuICAgICAgICAgICAgdXNlTGFuZ3VhZ2UodHJhbnNsYXRpb24ua2V5KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZSh0cmFuc2xhdGlvbi5rZXkpO1xuICAgICAgICAgIHJldHVybiB0cmFuc2xhdGlvbjtcbiAgICAgICAgfSwgZnVuY3Rpb24gKGtleSkge1xuICAgICAgICAgIC8vIGZpbmQgZmlyc3QgYXZhaWxhYmxlIGZhbGxiYWNrIGxhbmd1YWdlIGlmIHRoYXQgcmVxdWVzdCBoYXMgZmFpbGVkXG4gICAgICAgICAgaWYgKCEkdXNlcyAmJiAkZmFsbGJhY2tMYW5ndWFnZSAmJiAkZmFsbGJhY2tMYW5ndWFnZS5sZW5ndGggPiAwICYmICRmYWxsYmFja0xhbmd1YWdlWzBdICE9PSBrZXkpIHtcbiAgICAgICAgICAgIHJldHVybiAkdHJhbnNsYXRlLnVzZSgkZmFsbGJhY2tMYW5ndWFnZVswXSkudGhlbihkZWZlcnJlZC5yZXNvbHZlLCBkZWZlcnJlZC5yZWplY3QpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gZGVmZXJyZWQucmVqZWN0KGtleSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGRlZmVycmVkLnJlc29sdmUoa2V5KTtcbiAgICAgICAgdXNlTGFuZ3VhZ2Uoa2V5KTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7XG4gICAgfTtcblxuICAgIC8qKlxuICAgICAqIEBuZ2RvYyBmdW5jdGlvblxuICAgICAqIEBuYW1lIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZSNyZXNvbHZlQ2xpZW50TG9jYWxlXG4gICAgICogQG1ldGhvZE9mIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVxuICAgICAqXG4gICAgICogQGRlc2NyaXB0aW9uXG4gICAgICogVGhpcyByZXR1cm5zIHRoZSBjdXJyZW50IGJyb3dzZXIvY2xpZW50J3MgbGFuZ3VhZ2Uga2V5LiBUaGUgcmVzdWx0IGlzIHByb2Nlc3NlZCB3aXRoIHRoZSBjb25maWd1cmVkIHVuaWZvcm0gdGFnIHJlc29sdmVyLlxuICAgICAqXG4gICAgICogQHJldHVybnMge3N0cmluZ30gdGhlIGN1cnJlbnQgY2xpZW50L2Jyb3dzZXIgbGFuZ3VhZ2Uga2V5XG4gICAgICovXG4gICAgJHRyYW5zbGF0ZS5yZXNvbHZlQ2xpZW50TG9jYWxlID0gZnVuY3Rpb24gKCkge1xuICAgICAgcmV0dXJuIGdldExvY2FsZSgpO1xuICAgIH07XG5cbiAgICAvKipcbiAgICAgKiBAbmdkb2MgZnVuY3Rpb25cbiAgICAgKiBAbmFtZSBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGUjc3RvcmFnZUtleVxuICAgICAqIEBtZXRob2RPZiBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVcbiAgICAgKlxuICAgICAqIEBkZXNjcmlwdGlvblxuICAgICAqIFJldHVybnMgdGhlIGtleSBmb3IgdGhlIHN0b3JhZ2UuXG4gICAgICpcbiAgICAgKiBAcmV0dXJuIHtzdHJpbmd9IHN0b3JhZ2Uga2V5XG4gICAgICovXG4gICAgJHRyYW5zbGF0ZS5zdG9yYWdlS2V5ID0gZnVuY3Rpb24gKCkge1xuICAgICAgcmV0dXJuIHN0b3JhZ2VLZXkoKTtcbiAgICB9O1xuXG4gICAgLyoqXG4gICAgICogQG5nZG9jIGZ1bmN0aW9uXG4gICAgICogQG5hbWUgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlI2lzUG9zdENvbXBpbGluZ0VuYWJsZWRcbiAgICAgKiBAbWV0aG9kT2YgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlXG4gICAgICpcbiAgICAgKiBAZGVzY3JpcHRpb25cbiAgICAgKiBSZXR1cm5zIHdoZXRoZXIgcG9zdCBjb21waWxpbmcgaXMgZW5hYmxlZCBvciBub3RcbiAgICAgKlxuICAgICAqIEByZXR1cm4ge2Jvb2x9IHN0b3JhZ2Uga2V5XG4gICAgICovXG4gICAgJHRyYW5zbGF0ZS5pc1Bvc3RDb21waWxpbmdFbmFibGVkID0gZnVuY3Rpb24gKCkge1xuICAgICAgcmV0dXJuICRwb3N0Q29tcGlsaW5nRW5hYmxlZDtcbiAgICB9O1xuXG4gICAgLyoqXG4gICAgICogQG5nZG9jIGZ1bmN0aW9uXG4gICAgICogQG5hbWUgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlI2lzRm9yY2VBc3luY1JlbG9hZEVuYWJsZWRcbiAgICAgKiBAbWV0aG9kT2YgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlXG4gICAgICpcbiAgICAgKiBAZGVzY3JpcHRpb25cbiAgICAgKiBSZXR1cm5zIHdoZXRoZXIgZm9yY2UgYXN5bmMgcmVsb2FkIGlzIGVuYWJsZWQgb3Igbm90XG4gICAgICpcbiAgICAgKiBAcmV0dXJuIHtib29sZWFufSBmb3JjZUFzeW5jUmVsb2FkIHZhbHVlXG4gICAgICovXG4gICAgJHRyYW5zbGF0ZS5pc0ZvcmNlQXN5bmNSZWxvYWRFbmFibGVkID0gZnVuY3Rpb24gKCkge1xuICAgICAgcmV0dXJuICRmb3JjZUFzeW5jUmVsb2FkRW5hYmxlZDtcbiAgICB9O1xuXG4gICAgLyoqXG4gICAgICogQG5nZG9jIGZ1bmN0aW9uXG4gICAgICogQG5hbWUgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlI2lzS2VlcENvbnRlbnRcbiAgICAgKiBAbWV0aG9kT2YgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlXG4gICAgICpcbiAgICAgKiBAZGVzY3JpcHRpb25cbiAgICAgKiBSZXR1cm5zIHdoZXRoZXIga2VlcENvbnRlbnQgb3Igbm90XG4gICAgICpcbiAgICAgKiBAcmV0dXJuIHtib29sZWFufSBrZWVwQ29udGVudCB2YWx1ZVxuICAgICAqL1xuICAgICR0cmFuc2xhdGUuaXNLZWVwQ29udGVudCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgIHJldHVybiAka2VlcENvbnRlbnQ7XG4gICAgfTtcblxuICAgIC8qKlxuICAgICAqIEBuZ2RvYyBmdW5jdGlvblxuICAgICAqIEBuYW1lIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZSNyZWZyZXNoXG4gICAgICogQG1ldGhvZE9mIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVxuICAgICAqXG4gICAgICogQGRlc2NyaXB0aW9uXG4gICAgICogUmVmcmVzaGVzIGEgdHJhbnNsYXRpb24gdGFibGUgcG9pbnRlZCBieSB0aGUgZ2l2ZW4gbGFuZ0tleS4gSWYgbGFuZ0tleSBpcyBub3Qgc3BlY2lmaWVkLFxuICAgICAqIHRoZSBtb2R1bGUgd2lsbCBkcm9wIGFsbCBleGlzdGVudCB0cmFuc2xhdGlvbiB0YWJsZXMgYW5kIGxvYWQgbmV3IHZlcnNpb24gb2YgdGhvc2Ugd2hpY2hcbiAgICAgKiBhcmUgY3VycmVudGx5IGluIHVzZS5cbiAgICAgKlxuICAgICAqIFJlZnJlc2ggbWVhbnMgdGhhdCB0aGUgbW9kdWxlIHdpbGwgZHJvcCB0YXJnZXQgdHJhbnNsYXRpb24gdGFibGUgYW5kIHRyeSB0byBsb2FkIGl0IGFnYWluLlxuICAgICAqXG4gICAgICogSW4gY2FzZSB0aGVyZSBhcmUgbm8gbG9hZGVycyByZWdpc3RlcmVkIHRoZSByZWZyZXNoKCkgbWV0aG9kIHdpbGwgdGhyb3cgYW4gRXJyb3IuXG4gICAgICpcbiAgICAgKiBJZiB0aGUgbW9kdWxlIGlzIGFibGUgdG8gcmVmcmVzaCB0cmFuc2xhdGlvbiB0YWJsZXMgcmVmcmVzaCgpIG1ldGhvZCB3aWxsIGJyb2FkY2FzdFxuICAgICAqICR0cmFuc2xhdGVSZWZyZXNoU3RhcnQgYW5kICR0cmFuc2xhdGVSZWZyZXNoRW5kIGV2ZW50cy5cbiAgICAgKlxuICAgICAqIEBleGFtcGxlXG4gICAgICogLy8gdGhpcyB3aWxsIGRyb3AgYWxsIGN1cnJlbnRseSBleGlzdGVudCB0cmFuc2xhdGlvbiB0YWJsZXMgYW5kIHJlbG9hZCB0aG9zZSB3aGljaCBhcmVcbiAgICAgKiAvLyBjdXJyZW50bHkgaW4gdXNlXG4gICAgICogJHRyYW5zbGF0ZS5yZWZyZXNoKCk7XG4gICAgICogLy8gdGhpcyB3aWxsIHJlZnJlc2ggYSB0cmFuc2xhdGlvbiB0YWJsZSBmb3IgdGhlIGVuX1VTIGxhbmd1YWdlXG4gICAgICogJHRyYW5zbGF0ZS5yZWZyZXNoKCdlbl9VUycpO1xuICAgICAqXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGxhbmdLZXkgQSBsYW5ndWFnZSBrZXkgb2YgdGhlIHRhYmxlLCB3aGljaCBoYXMgdG8gYmUgcmVmcmVzaGVkXG4gICAgICpcbiAgICAgKiBAcmV0dXJuIHtwcm9taXNlfSBQcm9taXNlLCB3aGljaCB3aWxsIGJlIHJlc29sdmVkIGluIGNhc2UgYSB0cmFuc2xhdGlvbiB0YWJsZXMgcmVmcmVzaGluZ1xuICAgICAqIHByb2Nlc3MgaXMgZmluaXNoZWQgc3VjY2Vzc2Z1bGx5LCBhbmQgcmVqZWN0IGlmIG5vdC5cbiAgICAgKi9cbiAgICAkdHJhbnNsYXRlLnJlZnJlc2ggPSBmdW5jdGlvbiAobGFuZ0tleSkge1xuICAgICAgaWYgKCEkbG9hZGVyRmFjdG9yeSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkblxcJ3QgcmVmcmVzaCB0cmFuc2xhdGlvbiB0YWJsZSwgbm8gbG9hZGVyIHJlZ2lzdGVyZWQhJyk7XG4gICAgICB9XG5cbiAgICAgICRyb290U2NvcGUuJGVtaXQoJyR0cmFuc2xhdGVSZWZyZXNoU3RhcnQnLCB7bGFuZ3VhZ2UgOiBsYW5nS2V5fSk7XG5cbiAgICAgIHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCksIHVwZGF0ZWRMYW5ndWFnZXMgPSB7fTtcblxuICAgICAgLy9wcml2YXRlIGhlbHBlclxuICAgICAgZnVuY3Rpb24gbG9hZE5ld0RhdGEobGFuZ3VhZ2VLZXkpIHtcbiAgICAgICAgdmFyIHByb21pc2UgPSBsb2FkQXN5bmMobGFuZ3VhZ2VLZXkpO1xuICAgICAgICAvL3VwZGF0ZSB0aGUgbG9hZCBwcm9taXNlIGNhY2hlIGZvciB0aGlzIGxhbmd1YWdlXG4gICAgICAgIGxhbmdQcm9taXNlc1tsYW5ndWFnZUtleV0gPSBwcm9taXNlO1xuICAgICAgICAvL3JlZ2lzdGVyIGEgZGF0YSBoYW5kbGVyIGZvciB0aGUgcHJvbWlzZVxuICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgICAgIC8vY2xlYXIgdGhlIGNhY2hlIGZvciB0aGlzIGxhbmd1YWdlXG4gICAgICAgICAgICAkdHJhbnNsYXRpb25UYWJsZVtsYW5ndWFnZUtleV0gPSB7fTtcbiAgICAgICAgICAgIC8vYWRkIHRoZSBuZXcgZGF0YSBmb3IgdGhpcyBsYW5ndWFnZVxuICAgICAgICAgICAgdHJhbnNsYXRpb25zKGxhbmd1YWdlS2V5LCBkYXRhLnRhYmxlKTtcbiAgICAgICAgICAgIC8vdHJhY2sgdGhhdCB3ZSB1cGRhdGVkIHRoaXMgbGFuZ3VhZ2VcbiAgICAgICAgICAgIHVwZGF0ZWRMYW5ndWFnZXNbbGFuZ3VhZ2VLZXldID0gdHJ1ZTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIC8vaGFuZGxlIHJlamVjdGlvbiB0byBhcHBlYXNlIHRoZSAkcSB2YWxpZGF0aW9uXG4gICAgICAgICAgYW5ndWxhci5ub29wKTtcbiAgICAgICAgcmV0dXJuIHByb21pc2U7XG4gICAgICB9XG5cbiAgICAgIC8vc2V0IHVwIHBvc3QtcHJvY2Vzc2luZ1xuICAgICAgZGVmZXJyZWQucHJvbWlzZS50aGVuKFxuICAgICAgICBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgZm9yICh2YXIga2V5IGluICR0cmFuc2xhdGlvblRhYmxlKSB7XG4gICAgICAgICAgICBpZiAoJHRyYW5zbGF0aW9uVGFibGUuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICAgICAgICAvL2RlbGV0ZSBjYWNoZSBlbnRyaWVzIHRoYXQgd2VyZSBub3QgdXBkYXRlZFxuICAgICAgICAgICAgICBpZiAoIShrZXkgaW4gdXBkYXRlZExhbmd1YWdlcykpIHtcbiAgICAgICAgICAgICAgICBkZWxldGUgJHRyYW5zbGF0aW9uVGFibGVba2V5XTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoJHVzZXMpIHtcbiAgICAgICAgICAgIHVzZUxhbmd1YWdlKCR1c2VzKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIC8vaGFuZGxlIHJlamVjdGlvbiB0byBhcHBlYXNlIHRoZSAkcSB2YWxpZGF0aW9uXG4gICAgICAgIGFuZ3VsYXIubm9vcFxuICAgICAgKVsnZmluYWxseSddKFxuICAgICAgICBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgJHJvb3RTY29wZS4kZW1pdCgnJHRyYW5zbGF0ZVJlZnJlc2hFbmQnLCB7bGFuZ3VhZ2UgOiBsYW5nS2V5fSk7XG4gICAgICAgIH1cbiAgICAgICk7XG5cbiAgICAgIGlmICghbGFuZ0tleSkge1xuICAgICAgICAvLyBpZiB0aGVyZSdzIG5vIGxhbmd1YWdlIGtleSBzcGVjaWZpZWQgd2UgcmVmcmVzaCBBTEwgVEhFIFRISU5HUyFcbiAgICAgICAgdmFyIGxhbmd1YWdlc1RvUmVsb2FkID0gJGZhbGxiYWNrTGFuZ3VhZ2UgJiYgJGZhbGxiYWNrTGFuZ3VhZ2Uuc2xpY2UoKSB8fCBbXTtcbiAgICAgICAgaWYgKCR1c2VzICYmIGxhbmd1YWdlc1RvUmVsb2FkLmluZGV4T2YoJHVzZXMpID09PSAtMSkge1xuICAgICAgICAgIGxhbmd1YWdlc1RvUmVsb2FkLnB1c2goJHVzZXMpO1xuICAgICAgICB9XG4gICAgICAgICRxLmFsbChsYW5ndWFnZXNUb1JlbG9hZC5tYXAobG9hZE5ld0RhdGEpKS50aGVuKGRlZmVycmVkLnJlc29sdmUsIGRlZmVycmVkLnJlamVjdCk7XG5cbiAgICAgIH0gZWxzZSBpZiAoJHRyYW5zbGF0aW9uVGFibGVbbGFuZ0tleV0pIHtcbiAgICAgICAgLy9qdXN0IHJlZnJlc2ggdGhlIHNwZWNpZmllZCBsYW5ndWFnZSBjYWNoZVxuICAgICAgICBsb2FkTmV3RGF0YShsYW5nS2V5KS50aGVuKGRlZmVycmVkLnJlc29sdmUsIGRlZmVycmVkLnJlamVjdCk7XG5cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGRlZmVycmVkLnJlamVjdCgpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTtcbiAgICB9O1xuXG4gICAgLyoqXG4gICAgICogQG5nZG9jIGZ1bmN0aW9uXG4gICAgICogQG5hbWUgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlI2luc3RhbnRcbiAgICAgKiBAbWV0aG9kT2YgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlXG4gICAgICpcbiAgICAgKiBAZGVzY3JpcHRpb25cbiAgICAgKiBSZXR1cm5zIGEgdHJhbnNsYXRpb24gaW5zdGFudGx5IGZyb20gdGhlIGludGVybmFsIHN0YXRlIG9mIGxvYWRlZCB0cmFuc2xhdGlvbi4gQWxsIHJ1bGVzXG4gICAgICogcmVnYXJkaW5nIHRoZSBjdXJyZW50IGxhbmd1YWdlLCB0aGUgcHJlZmVycmVkIGxhbmd1YWdlIG9mIGV2ZW4gZmFsbGJhY2sgbGFuZ3VhZ2VzIHdpbGwgYmVcbiAgICAgKiB1c2VkIGV4Y2VwdCBhbnkgcHJvbWlzZSBoYW5kbGluZy4gSWYgYSBsYW5ndWFnZSB3YXMgbm90IGZvdW5kLCBhbiBhc3luY2hyb25vdXMgbG9hZGluZ1xuICAgICAqIHdpbGwgYmUgaW52b2tlZCBpbiB0aGUgYmFja2dyb3VuZC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfGFycmF5fSB0cmFuc2xhdGlvbklkIEEgdG9rZW4gd2hpY2ggcmVwcmVzZW50cyBhIHRyYW5zbGF0aW9uIGlkXG4gICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhpcyBjYW4gYmUgb3B0aW9uYWxseSBhbiBhcnJheSBvZiB0cmFuc2xhdGlvbiBpZHMgd2hpY2hcbiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzIHRoYXQgdGhlIGZ1bmN0aW9uJ3MgcHJvbWlzZSByZXR1cm5zIGFuIG9iamVjdCB3aGVyZVxuICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVhY2gga2V5IGlzIHRoZSB0cmFuc2xhdGlvbiBpZCBhbmQgdGhlIHZhbHVlIHRoZSB0cmFuc2xhdGlvbi5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gaW50ZXJwb2xhdGVQYXJhbXMgUGFyYW1zXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGludGVycG9sYXRpb25JZCBUaGUgaWQgb2YgdGhlIGludGVycG9sYXRpb24gdG8gdXNlXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGZvcmNlTGFuZ3VhZ2UgQSBsYW5ndWFnZSB0byBiZSB1c2VkIGluc3RlYWQgb2YgdGhlIGN1cnJlbnQgbGFuZ3VhZ2VcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc2FuaXRpemVTdHJhdGVneSBmb3JjZSBzYW5pdGl6ZSBzdHJhdGVneSBmb3IgdGhpcyBjYWxsIGluc3RlYWQgb2YgdXNpbmcgdGhlIGNvbmZpZ3VyZWQgb25lXG4gICAgICpcbiAgICAgKiBAcmV0dXJuIHtzdHJpbmd8b2JqZWN0fSB0cmFuc2xhdGlvblxuICAgICAqL1xuICAgICR0cmFuc2xhdGUuaW5zdGFudCA9IGZ1bmN0aW9uICh0cmFuc2xhdGlvbklkLCBpbnRlcnBvbGF0ZVBhcmFtcywgaW50ZXJwb2xhdGlvbklkLCBmb3JjZUxhbmd1YWdlLCBzYW5pdGl6ZVN0cmF0ZWd5KSB7XG5cbiAgICAgIC8vIHdlIGRvbid0IHdhbnQgdG8gcmUtbmVnb3RpYXRlICR1c2VzXG4gICAgICB2YXIgdXNlcyA9IChmb3JjZUxhbmd1YWdlICYmIGZvcmNlTGFuZ3VhZ2UgIT09ICR1c2VzKSA/IC8vIHdlIGRvbid0IHdhbnQgdG8gcmUtbmVnb3RpYXRlICR1c2VzXG4gICAgICAgIChuZWdvdGlhdGVMb2NhbGUoZm9yY2VMYW5ndWFnZSkgfHwgZm9yY2VMYW5ndWFnZSkgOiAkdXNlcztcblxuICAgICAgLy8gRGV0ZWN0IHVuZGVmaW5lZCBhbmQgbnVsbCB2YWx1ZXMgdG8gc2hvcnRlbiB0aGUgZXhlY3V0aW9uIGFuZCBwcmV2ZW50IGV4Y2VwdGlvbnNcbiAgICAgIGlmICh0cmFuc2xhdGlvbklkID09PSBudWxsIHx8IGFuZ3VsYXIuaXNVbmRlZmluZWQodHJhbnNsYXRpb25JZCkpIHtcbiAgICAgICAgcmV0dXJuIHRyYW5zbGF0aW9uSWQ7XG4gICAgICB9XG5cbiAgICAgIC8vIENoZWNrIGZvcmNlTGFuZ3VhZ2UgaXMgcHJlc2VudFxuICAgICAgaWYgKGZvcmNlTGFuZ3VhZ2UpIHtcbiAgICAgICAgbG9hZFRyYW5zbGF0aW9uc0lmTWlzc2luZyhmb3JjZUxhbmd1YWdlKTtcbiAgICAgIH1cblxuICAgICAgLy8gRHVjayBkZXRlY3Rpb246IElmIHRoZSBmaXJzdCBhcmd1bWVudCBpcyBhbiBhcnJheSwgYSBidW5jaCBvZiB0cmFuc2xhdGlvbnMgd2FzIHJlcXVlc3RlZC5cbiAgICAgIC8vIFRoZSByZXN1bHQgaXMgYW4gb2JqZWN0LlxuICAgICAgaWYgKGFuZ3VsYXIuaXNBcnJheSh0cmFuc2xhdGlvbklkKSkge1xuICAgICAgICB2YXIgcmVzdWx0cyA9IHt9O1xuICAgICAgICBmb3IgKHZhciBpID0gMCwgYyA9IHRyYW5zbGF0aW9uSWQubGVuZ3RoOyBpIDwgYzsgaSsrKSB7XG4gICAgICAgICAgcmVzdWx0c1t0cmFuc2xhdGlvbklkW2ldXSA9ICR0cmFuc2xhdGUuaW5zdGFudCh0cmFuc2xhdGlvbklkW2ldLCBpbnRlcnBvbGF0ZVBhcmFtcywgaW50ZXJwb2xhdGlvbklkLCBmb3JjZUxhbmd1YWdlLCBzYW5pdGl6ZVN0cmF0ZWd5KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0cztcbiAgICAgIH1cblxuICAgICAgLy8gV2UgZGlzY2FyZGVkIHVuYWNjZXB0YWJsZSB2YWx1ZXMuIFNvIHdlIGp1c3QgbmVlZCB0byB2ZXJpZnkgaWYgdHJhbnNsYXRpb25JZCBpcyBlbXB0eSBTdHJpbmdcbiAgICAgIGlmIChhbmd1bGFyLmlzU3RyaW5nKHRyYW5zbGF0aW9uSWQpICYmIHRyYW5zbGF0aW9uSWQubGVuZ3RoIDwgMSkge1xuICAgICAgICByZXR1cm4gdHJhbnNsYXRpb25JZDtcbiAgICAgIH1cblxuICAgICAgLy8gdHJpbSBvZmYgYW55IHdoaXRlc3BhY2VcbiAgICAgIGlmICh0cmFuc2xhdGlvbklkKSB7XG4gICAgICAgIHRyYW5zbGF0aW9uSWQgPSB0cmltLmFwcGx5KHRyYW5zbGF0aW9uSWQpO1xuICAgICAgfVxuXG4gICAgICB2YXIgcmVzdWx0LCBwb3NzaWJsZUxhbmdLZXlzID0gW107XG4gICAgICBpZiAoJHByZWZlcnJlZExhbmd1YWdlKSB7XG4gICAgICAgIHBvc3NpYmxlTGFuZ0tleXMucHVzaCgkcHJlZmVycmVkTGFuZ3VhZ2UpO1xuICAgICAgfVxuICAgICAgaWYgKHVzZXMpIHtcbiAgICAgICAgcG9zc2libGVMYW5nS2V5cy5wdXNoKHVzZXMpO1xuICAgICAgfVxuICAgICAgaWYgKCRmYWxsYmFja0xhbmd1YWdlICYmICRmYWxsYmFja0xhbmd1YWdlLmxlbmd0aCkge1xuICAgICAgICBwb3NzaWJsZUxhbmdLZXlzID0gcG9zc2libGVMYW5nS2V5cy5jb25jYXQoJGZhbGxiYWNrTGFuZ3VhZ2UpO1xuICAgICAgfVxuICAgICAgZm9yICh2YXIgaiA9IDAsIGQgPSBwb3NzaWJsZUxhbmdLZXlzLmxlbmd0aDsgaiA8IGQ7IGorKykge1xuICAgICAgICB2YXIgcG9zc2libGVMYW5nS2V5ID0gcG9zc2libGVMYW5nS2V5c1tqXTtcbiAgICAgICAgaWYgKCR0cmFuc2xhdGlvblRhYmxlW3Bvc3NpYmxlTGFuZ0tleV0pIHtcbiAgICAgICAgICBpZiAodHlwZW9mICR0cmFuc2xhdGlvblRhYmxlW3Bvc3NpYmxlTGFuZ0tleV1bdHJhbnNsYXRpb25JZF0gIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICByZXN1bHQgPSBkZXRlcm1pbmVUcmFuc2xhdGlvbkluc3RhbnQodHJhbnNsYXRpb25JZCwgaW50ZXJwb2xhdGVQYXJhbXMsIGludGVycG9sYXRpb25JZCwgdXNlcywgc2FuaXRpemVTdHJhdGVneSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICh0eXBlb2YgcmVzdWx0ICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmICghcmVzdWx0ICYmIHJlc3VsdCAhPT0gJycpIHtcbiAgICAgICAgaWYgKCRub3RGb3VuZEluZGljYXRvckxlZnQgfHwgJG5vdEZvdW5kSW5kaWNhdG9yUmlnaHQpIHtcbiAgICAgICAgICByZXN1bHQgPSBhcHBseU5vdEZvdW5kSW5kaWNhdG9ycyh0cmFuc2xhdGlvbklkKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyBSZXR1cm4gdHJhbnNsYXRpb24gb2YgZGVmYXVsdCBpbnRlcnBvbGF0b3IgaWYgbm90IGZvdW5kIGFueXRoaW5nLlxuICAgICAgICAgIHJlc3VsdCA9IGRlZmF1bHRJbnRlcnBvbGF0b3IuaW50ZXJwb2xhdGUodHJhbnNsYXRpb25JZCwgaW50ZXJwb2xhdGVQYXJhbXMsICdmaWx0ZXInLCBzYW5pdGl6ZVN0cmF0ZWd5KTtcblxuICAgICAgICAgIC8vIGxvb2tzIGxpa2UgdGhlIHJlcXVlc3RlZCB0cmFuc2xhdGlvbiBpZCBkb2Vzbid0IGV4aXN0cy5cbiAgICAgICAgICAvLyBOb3csIGlmIHRoZXJlIGlzIGEgcmVnaXN0ZXJlZCBoYW5kbGVyIGZvciBtaXNzaW5nIHRyYW5zbGF0aW9ucyBhbmQgbm9cbiAgICAgICAgICAvLyBhc3luY0xvYWRlciBpcyBwZW5kaW5nLCB3ZSBleGVjdXRlIHRoZSBoYW5kbGVyXG4gICAgICAgICAgdmFyIG1pc3NpbmdUcmFuc2xhdGlvbkhhbmRsZXJUcmFuc2xhdGlvbjtcbiAgICAgICAgICBpZiAoJG1pc3NpbmdUcmFuc2xhdGlvbkhhbmRsZXJGYWN0b3J5ICYmICFwZW5kaW5nTG9hZGVyKSB7XG4gICAgICAgICAgICBtaXNzaW5nVHJhbnNsYXRpb25IYW5kbGVyVHJhbnNsYXRpb24gPSB0cmFuc2xhdGVCeUhhbmRsZXIodHJhbnNsYXRpb25JZCwgaW50ZXJwb2xhdGVQYXJhbXMsIHNhbml0aXplU3RyYXRlZ3kpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGlmICgkbWlzc2luZ1RyYW5zbGF0aW9uSGFuZGxlckZhY3RvcnkgJiYgIXBlbmRpbmdMb2FkZXIgJiYgbWlzc2luZ1RyYW5zbGF0aW9uSGFuZGxlclRyYW5zbGF0aW9uKSB7XG4gICAgICAgICAgICByZXN1bHQgPSBtaXNzaW5nVHJhbnNsYXRpb25IYW5kbGVyVHJhbnNsYXRpb247XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfTtcblxuICAgIC8qKlxuICAgICAqIEBuZ2RvYyBmdW5jdGlvblxuICAgICAqIEBuYW1lIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZSN2ZXJzaW9uSW5mb1xuICAgICAqIEBtZXRob2RPZiBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVcbiAgICAgKlxuICAgICAqIEBkZXNjcmlwdGlvblxuICAgICAqIFJldHVybnMgdGhlIGN1cnJlbnQgdmVyc2lvbiBpbmZvcm1hdGlvbiBmb3IgdGhlIGFuZ3VsYXItdHJhbnNsYXRlIGxpYnJhcnlcbiAgICAgKlxuICAgICAqIEByZXR1cm4ge3N0cmluZ30gYW5ndWxhci10cmFuc2xhdGUgdmVyc2lvblxuICAgICAqL1xuICAgICR0cmFuc2xhdGUudmVyc2lvbkluZm8gPSBmdW5jdGlvbiAoKSB7XG4gICAgICByZXR1cm4gdmVyc2lvbjtcbiAgICB9O1xuXG4gICAgLyoqXG4gICAgICogQG5nZG9jIGZ1bmN0aW9uXG4gICAgICogQG5hbWUgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlI2xvYWRlckNhY2hlXG4gICAgICogQG1ldGhvZE9mIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVxuICAgICAqXG4gICAgICogQGRlc2NyaXB0aW9uXG4gICAgICogUmV0dXJucyB0aGUgZGVmaW5lZCBsb2FkZXJDYWNoZS5cbiAgICAgKlxuICAgICAqIEByZXR1cm4ge2Jvb2xlYW58c3RyaW5nfG9iamVjdH0gY3VycmVudCB2YWx1ZSBvZiBsb2FkZXJDYWNoZVxuICAgICAqL1xuICAgICR0cmFuc2xhdGUubG9hZGVyQ2FjaGUgPSBmdW5jdGlvbiAoKSB7XG4gICAgICByZXR1cm4gbG9hZGVyQ2FjaGU7XG4gICAgfTtcblxuICAgIC8vIGludGVybmFsIHB1cnBvc2Ugb25seVxuICAgICR0cmFuc2xhdGUuZGlyZWN0aXZlUHJpb3JpdHkgPSBmdW5jdGlvbiAoKSB7XG4gICAgICByZXR1cm4gZGlyZWN0aXZlUHJpb3JpdHk7XG4gICAgfTtcblxuICAgIC8vIGludGVybmFsIHB1cnBvc2Ugb25seVxuICAgICR0cmFuc2xhdGUuc3RhdGVmdWxGaWx0ZXIgPSBmdW5jdGlvbiAoKSB7XG4gICAgICByZXR1cm4gc3RhdGVmdWxGaWx0ZXI7XG4gICAgfTtcblxuICAgIC8qKlxuICAgICAqIEBuZ2RvYyBmdW5jdGlvblxuICAgICAqIEBuYW1lIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZSNpc1JlYWR5XG4gICAgICogQG1ldGhvZE9mIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVxuICAgICAqXG4gICAgICogQGRlc2NyaXB0aW9uXG4gICAgICogUmV0dXJucyB3aGV0aGVyIHRoZSBzZXJ2aWNlIGlzIFwicmVhZHlcIiB0byB0cmFuc2xhdGUgKGkuZS4gbG9hZGluZyAxc3QgbGFuZ3VhZ2UpLlxuICAgICAqXG4gICAgICogU2VlIGFsc28ge0BsaW5rIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZSNtZXRob2RzX29uUmVhZHkgb25SZWFkeSgpfS5cbiAgICAgKlxuICAgICAqIEByZXR1cm4ge2Jvb2xlYW59IGN1cnJlbnQgdmFsdWUgb2YgcmVhZHlcbiAgICAgKi9cbiAgICAkdHJhbnNsYXRlLmlzUmVhZHkgPSBmdW5jdGlvbiAoKSB7XG4gICAgICByZXR1cm4gJGlzUmVhZHk7XG4gICAgfTtcblxuICAgIHZhciAkb25SZWFkeURlZmVycmVkID0gJHEuZGVmZXIoKTtcbiAgICAkb25SZWFkeURlZmVycmVkLnByb21pc2UudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgICAkaXNSZWFkeSA9IHRydWU7XG4gICAgfSk7XG5cbiAgICAvKipcbiAgICAgKiBAbmdkb2MgZnVuY3Rpb25cbiAgICAgKiBAbmFtZSBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGUjb25SZWFkeVxuICAgICAqIEBtZXRob2RPZiBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVcbiAgICAgKlxuICAgICAqIEBkZXNjcmlwdGlvblxuICAgICAqIENhbGxzIHRoZSBmdW5jdGlvbiBwcm92aWRlZCBvciByZXNvbHZlZCB0aGUgcmV0dXJuZWQgcHJvbWlzZSBhZnRlciB0aGUgc2VydmljZSBpcyBcInJlYWR5XCIgdG8gdHJhbnNsYXRlIChpLmUuIGxvYWRpbmcgMXN0IGxhbmd1YWdlKS5cbiAgICAgKlxuICAgICAqIFNlZSBhbHNvIHtAbGluayBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGUjbWV0aG9kc19pc1JlYWR5IGlzUmVhZHkoKX0uXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9uPX0gZm4gRnVuY3Rpb24gdG8gaW52b2tlIHdoZW4gc2VydmljZSBpcyByZWFkeVxuICAgICAqIEByZXR1cm4ge29iamVjdH0gUHJvbWlzZSByZXNvbHZlZCB3aGVuIHNlcnZpY2UgaXMgcmVhZHlcbiAgICAgKi9cbiAgICAkdHJhbnNsYXRlLm9uUmVhZHkgPSBmdW5jdGlvbiAoZm4pIHtcbiAgICAgIHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCk7XG4gICAgICBpZiAoYW5ndWxhci5pc0Z1bmN0aW9uKGZuKSkge1xuICAgICAgICBkZWZlcnJlZC5wcm9taXNlLnRoZW4oZm4pO1xuICAgICAgfVxuICAgICAgaWYgKCRpc1JlYWR5KSB7XG4gICAgICAgIGRlZmVycmVkLnJlc29sdmUoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgICRvblJlYWR5RGVmZXJyZWQucHJvbWlzZS50aGVuKGRlZmVycmVkLnJlc29sdmUpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7XG4gICAgfTtcblxuICAgIC8qKlxuICAgICAqIEBuZ2RvYyBmdW5jdGlvblxuICAgICAqIEBuYW1lIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZSNnZXRBdmFpbGFibGVMYW5ndWFnZUtleXNcbiAgICAgKiBAbWV0aG9kT2YgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlXG4gICAgICpcbiAgICAgKiBAZGVzY3JpcHRpb25cbiAgICAgKiBUaGlzIGZ1bmN0aW9uIHNpbXBseSByZXR1cm5zIHRoZSByZWdpc3RlcmVkIGxhbmd1YWdlIGtleXMgYmVpbmcgZGVmaW5lZCBiZWZvcmUgaW4gdGhlIGNvbmZpZyBwaGFzZVxuICAgICAqIFdpdGggdGhpcywgYW4gYXBwbGljYXRpb24gY2FuIHVzZSB0aGUgYXJyYXkgdG8gcHJvdmlkZSBhIGxhbmd1YWdlIHNlbGVjdGlvbiBkcm9wZG93biBvciBzaW1pbGFyXG4gICAgICogd2l0aG91dCBhbnkgYWRkaXRpb25hbCBlZmZvcnRcbiAgICAgKlxuICAgICAqIEByZXR1cm5zIHtvYmplY3R9IHJldHVybnMgdGhlIGxpc3Qgb2YgcG9zc2libHkgcmVnaXN0ZXJlZCBsYW5ndWFnZSBrZXlzIGFuZCBtYXBwaW5nIG9yIG51bGwgaWYgbm90IGRlZmluZWRcbiAgICAgKi9cbiAgICAkdHJhbnNsYXRlLmdldEF2YWlsYWJsZUxhbmd1YWdlS2V5cyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgIGlmICgkYXZhaWxhYmxlTGFuZ3VhZ2VLZXlzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgcmV0dXJuICRhdmFpbGFibGVMYW5ndWFnZUtleXM7XG4gICAgICB9XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9O1xuXG4gICAgLyoqXG4gICAgICogQG5nZG9jIGZ1bmN0aW9uXG4gICAgICogQG5hbWUgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlI2dldFRyYW5zbGF0aW9uVGFibGVcbiAgICAgKiBAbWV0aG9kT2YgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlXG4gICAgICpcbiAgICAgKiBAZGVzY3JpcHRpb25cbiAgICAgKiBSZXR1cm5zIHRyYW5zbGF0aW9uIHRhYmxlIGJ5IHRoZSBnaXZlbiBsYW5ndWFnZSBrZXkuXG4gICAgICpcbiAgICAgKiBVbmxlc3MgYSBsYW5ndWFnZSBpcyBwcm92aWRlZCBpdCByZXR1cm5zIGEgdHJhbnNsYXRpb24gdGFibGUgb2YgdGhlIGN1cnJlbnQgb25lLlxuICAgICAqIE5vdGU6IElmIHRyYW5zbGF0aW9uIGRpY3Rpb25hcnkgaXMgY3VycmVudGx5IGRvd25sb2FkaW5nIG9yIGluIHByb2dyZXNzXG4gICAgICogaXQgd2lsbCByZXR1cm4gbnVsbC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBsYW5nS2V5IEEgdG9rZW4gd2hpY2ggcmVwcmVzZW50cyBhIHRyYW5zbGF0aW9uIGlkXG4gICAgICpcbiAgICAgKiBAcmV0dXJuIHtvYmplY3R9IGEgY29weSBvZiBhbmd1bGFyLXRyYW5zbGF0ZSAkdHJhbnNsYXRpb25UYWJsZVxuICAgICAqL1xuICAgICR0cmFuc2xhdGUuZ2V0VHJhbnNsYXRpb25UYWJsZSA9IGZ1bmN0aW9uIChsYW5nS2V5KSB7XG4gICAgICBsYW5nS2V5ID0gbGFuZ0tleSB8fCAkdHJhbnNsYXRlLnVzZSgpO1xuICAgICAgaWYgKGxhbmdLZXkgJiYgJHRyYW5zbGF0aW9uVGFibGVbbGFuZ0tleV0pIHtcbiAgICAgICAgcmV0dXJuIGFuZ3VsYXIuY29weSgkdHJhbnNsYXRpb25UYWJsZVtsYW5nS2V5XSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9O1xuXG4gICAgLy8gV2hlbmV2ZXIgJHRyYW5zbGF0ZVJlYWR5IGlzIGJlaW5nIGZpcmVkLCB0aGlzIHdpbGwgZW5zdXJlIHRoZSBzdGF0ZSBvZiAkaXNSZWFkeVxuICAgIHZhciBnbG9iYWxPblJlYWR5TGlzdGVuZXIgPSAkcm9vdFNjb3BlLiRvbignJHRyYW5zbGF0ZVJlYWR5JywgZnVuY3Rpb24gKCkge1xuICAgICAgJG9uUmVhZHlEZWZlcnJlZC5yZXNvbHZlKCk7XG4gICAgICBnbG9iYWxPblJlYWR5TGlzdGVuZXIoKTsgLy8gb25lIHRpbWUgb25seVxuICAgICAgZ2xvYmFsT25SZWFkeUxpc3RlbmVyID0gbnVsbDtcbiAgICB9KTtcbiAgICB2YXIgZ2xvYmFsT25DaGFuZ2VMaXN0ZW5lciA9ICRyb290U2NvcGUuJG9uKCckdHJhbnNsYXRlQ2hhbmdlRW5kJywgZnVuY3Rpb24gKCkge1xuICAgICAgJG9uUmVhZHlEZWZlcnJlZC5yZXNvbHZlKCk7XG4gICAgICBnbG9iYWxPbkNoYW5nZUxpc3RlbmVyKCk7IC8vIG9uZSB0aW1lIG9ubHlcbiAgICAgIGdsb2JhbE9uQ2hhbmdlTGlzdGVuZXIgPSBudWxsO1xuICAgIH0pO1xuXG4gICAgaWYgKCRsb2FkZXJGYWN0b3J5KSB7XG5cbiAgICAgIC8vIElmIGF0IGxlYXN0IG9uZSBhc3luYyBsb2FkZXIgaXMgZGVmaW5lZCBhbmQgdGhlcmUgYXJlIG5vXG4gICAgICAvLyAoZGVmYXVsdCkgdHJhbnNsYXRpb25zIGF2YWlsYWJsZSB3ZSBzaG91bGQgdHJ5IHRvIGxvYWQgdGhlbS5cbiAgICAgIGlmIChhbmd1bGFyLmVxdWFscygkdHJhbnNsYXRpb25UYWJsZSwge30pKSB7XG4gICAgICAgIGlmICgkdHJhbnNsYXRlLnVzZSgpKSB7XG4gICAgICAgICAgJHRyYW5zbGF0ZS51c2UoJHRyYW5zbGF0ZS51c2UoKSk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgLy8gQWxzbywgaWYgdGhlcmUgYXJlIGFueSBmYWxsYmFjayBsYW5ndWFnZSByZWdpc3RlcmVkLCB3ZSBzdGFydFxuICAgICAgLy8gbG9hZGluZyB0aGVtIGFzeW5jaHJvbm91c2x5IGFzIHNvb24gYXMgd2UgY2FuLlxuICAgICAgaWYgKCRmYWxsYmFja0xhbmd1YWdlICYmICRmYWxsYmFja0xhbmd1YWdlLmxlbmd0aCkge1xuICAgICAgICB2YXIgcHJvY2Vzc0FzeW5jUmVzdWx0ID0gZnVuY3Rpb24gKHRyYW5zbGF0aW9uKSB7XG4gICAgICAgICAgdHJhbnNsYXRpb25zKHRyYW5zbGF0aW9uLmtleSwgdHJhbnNsYXRpb24udGFibGUpO1xuICAgICAgICAgICRyb290U2NvcGUuJGVtaXQoJyR0cmFuc2xhdGVDaGFuZ2VFbmQnLCB7bGFuZ3VhZ2UgOiB0cmFuc2xhdGlvbi5rZXl9KTtcbiAgICAgICAgICByZXR1cm4gdHJhbnNsYXRpb247XG4gICAgICAgIH07XG4gICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSAkZmFsbGJhY2tMYW5ndWFnZS5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xuICAgICAgICAgIHZhciBmYWxsYmFja0xhbmd1YWdlSWQgPSAkZmFsbGJhY2tMYW5ndWFnZVtpXTtcbiAgICAgICAgICBpZiAoJGZvcmNlQXN5bmNSZWxvYWRFbmFibGVkIHx8ICEkdHJhbnNsYXRpb25UYWJsZVtmYWxsYmFja0xhbmd1YWdlSWRdKSB7XG4gICAgICAgICAgICBsYW5nUHJvbWlzZXNbZmFsbGJhY2tMYW5ndWFnZUlkXSA9IGxvYWRBc3luYyhmYWxsYmFja0xhbmd1YWdlSWQpLnRoZW4ocHJvY2Vzc0FzeW5jUmVzdWx0KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgJHJvb3RTY29wZS4kZW1pdCgnJHRyYW5zbGF0ZVJlYWR5Jywge2xhbmd1YWdlIDogJHRyYW5zbGF0ZS51c2UoKX0pO1xuICAgIH1cblxuICAgIHJldHVybiAkdHJhbnNsYXRlO1xuICB9XTtcbn1cblxuJHRyYW5zbGF0ZS5kaXNwbGF5TmFtZSA9ICdkaXNwbGF5TmFtZSc7XG5cbi8qKlxuICogQG5nZG9jIG9iamVjdFxuICogQG5hbWUgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlRGVmYXVsdEludGVycG9sYXRpb25cbiAqIEByZXF1aXJlcyAkaW50ZXJwb2xhdGVcbiAqXG4gKiBAZGVzY3JpcHRpb25cbiAqIFVzZXMgYW5ndWxhcidzIGAkaW50ZXJwb2xhdGVgIHNlcnZpY2VzIHRvIGludGVycG9sYXRlIHN0cmluZ3MgYWdhaW5zdCBzb21lIHZhbHVlcy5cbiAqXG4gKiBCZSBhd2FyZSB0byBjb25maWd1cmUgYSBwcm9wZXIgc2FuaXRpemF0aW9uIHN0cmF0ZWd5LlxuICpcbiAqIFNlZSBhbHNvOlxuICogKiB7QGxpbmsgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlU2FuaXRpemF0aW9ufVxuICpcbiAqIEByZXR1cm4ge29iamVjdH0gJHRyYW5zbGF0ZURlZmF1bHRJbnRlcnBvbGF0aW9uIEludGVycG9sYXRvciBzZXJ2aWNlXG4gKi9cbmFuZ3VsYXIubW9kdWxlKCdwYXNjYWxwcmVjaHQudHJhbnNsYXRlJykuZmFjdG9yeSgnJHRyYW5zbGF0ZURlZmF1bHRJbnRlcnBvbGF0aW9uJywgJHRyYW5zbGF0ZURlZmF1bHRJbnRlcnBvbGF0aW9uKTtcblxuZnVuY3Rpb24gJHRyYW5zbGF0ZURlZmF1bHRJbnRlcnBvbGF0aW9uICgkaW50ZXJwb2xhdGUsICR0cmFuc2xhdGVTYW5pdGl6YXRpb24pIHtcblxuICAndXNlIHN0cmljdCc7XG5cbiAgdmFyICR0cmFuc2xhdGVJbnRlcnBvbGF0b3IgPSB7fSxcbiAgICAgICRsb2NhbGUsXG4gICAgICAkaWRlbnRpZmllciA9ICdkZWZhdWx0JztcblxuICAvKipcbiAgICogQG5nZG9jIGZ1bmN0aW9uXG4gICAqIEBuYW1lIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZURlZmF1bHRJbnRlcnBvbGF0aW9uI3NldExvY2FsZVxuICAgKiBAbWV0aG9kT2YgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlRGVmYXVsdEludGVycG9sYXRpb25cbiAgICpcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqIFNldHMgY3VycmVudCBsb2NhbGUgKHRoaXMgaXMgY3VycmVudGx5IG5vdCB1c2UgaW4gdGhpcyBpbnRlcnBvbGF0aW9uKS5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IGxvY2FsZSBMYW5ndWFnZSBrZXkgb3IgbG9jYWxlLlxuICAgKi9cbiAgJHRyYW5zbGF0ZUludGVycG9sYXRvci5zZXRMb2NhbGUgPSBmdW5jdGlvbiAobG9jYWxlKSB7XG4gICAgJGxvY2FsZSA9IGxvY2FsZTtcbiAgfTtcblxuICAvKipcbiAgICogQG5nZG9jIGZ1bmN0aW9uXG4gICAqIEBuYW1lIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZURlZmF1bHRJbnRlcnBvbGF0aW9uI2dldEludGVycG9sYXRpb25JZGVudGlmaWVyXG4gICAqIEBtZXRob2RPZiBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVEZWZhdWx0SW50ZXJwb2xhdGlvblxuICAgKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICogUmV0dXJucyBhbiBpZGVudGlmaWVyIGZvciB0aGlzIGludGVycG9sYXRpb24gc2VydmljZS5cbiAgICpcbiAgICogQHJldHVybnMge3N0cmluZ30gJGlkZW50aWZpZXJcbiAgICovXG4gICR0cmFuc2xhdGVJbnRlcnBvbGF0b3IuZ2V0SW50ZXJwb2xhdGlvbklkZW50aWZpZXIgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuICRpZGVudGlmaWVyO1xuICB9O1xuXG4gIC8qKlxuICAgKiBAZGVwcmVjYXRlZCB3aWxsIGJlIHJlbW92ZWQgaW4gMy4wXG4gICAqIEBzZWUge0BsaW5rIHBhc2NhbHByZWNodC50cmFuc2xhdGUuJHRyYW5zbGF0ZVNhbml0aXphdGlvbn1cbiAgICovXG4gICR0cmFuc2xhdGVJbnRlcnBvbGF0b3IudXNlU2FuaXRpemVWYWx1ZVN0cmF0ZWd5ID0gZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgJHRyYW5zbGF0ZVNhbml0aXphdGlvbi51c2VTdHJhdGVneSh2YWx1ZSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH07XG5cbiAgLyoqXG4gICAqIEBuZ2RvYyBmdW5jdGlvblxuICAgKiBAbmFtZSBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVEZWZhdWx0SW50ZXJwb2xhdGlvbiNpbnRlcnBvbGF0ZVxuICAgKiBAbWV0aG9kT2YgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlRGVmYXVsdEludGVycG9sYXRpb25cbiAgICpcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqIEludGVycG9sYXRlcyBnaXZlbiB2YWx1ZSBhZ2FpbnMgZ2l2ZW4gaW50ZXJwb2xhdGUgcGFyYW1zIHVzaW5nIGFuZ3VsYXJzXG4gICAqIGAkaW50ZXJwb2xhdGVgIHNlcnZpY2UuXG4gICAqXG4gICAqIFNpbmNlIEFuZ3VsYXJKUyAxLjUsIGB2YWx1ZWAgbXVzdCBub3QgYmUgYSBzdHJpbmcgYnV0IGNhbiBiZSBhbnl0aGluZyBpbnB1dC5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlIHRyYW5zbGF0aW9uXG4gICAqIEBwYXJhbSB7b2JqZWN0fSBpbnRlcnBvbGF0aW9uUGFyYW1zIGludGVycG9sYXRpb24gcGFyYW1zXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBjb250ZXh0IGN1cnJlbnQgY29udGV4dCAoZmlsdGVyLCBkaXJlY3RpdmUsIHNlcnZpY2UpXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBzYW5pdGl6ZVN0cmF0ZWd5IHNhbml0aXplIHN0cmF0ZWd5XG4gICAqIEBwYXJhbSB7c3RyaW5nfSB0cmFuc2xhdGlvbklkIGN1cnJlbnQgdHJhbnNsYXRpb25JZFxuICAgKlxuICAgKiBAcmV0dXJucyB7c3RyaW5nfSBpbnRlcnBvbGF0ZWQgc3RyaW5nXG4gICAqL1xuICAkdHJhbnNsYXRlSW50ZXJwb2xhdG9yLmludGVycG9sYXRlID0gZnVuY3Rpb24gKHZhbHVlLCBpbnRlcnBvbGF0aW9uUGFyYW1zLCBjb250ZXh0LCBzYW5pdGl6ZVN0cmF0ZWd5LCB0cmFuc2xhdGlvbklkKSB7IC8vIGpzaGludCBpZ25vcmU6bGluZVxuICAgIGludGVycG9sYXRpb25QYXJhbXMgPSBpbnRlcnBvbGF0aW9uUGFyYW1zIHx8IHt9O1xuICAgIGludGVycG9sYXRpb25QYXJhbXMgPSAkdHJhbnNsYXRlU2FuaXRpemF0aW9uLnNhbml0aXplKGludGVycG9sYXRpb25QYXJhbXMsICdwYXJhbXMnLCBzYW5pdGl6ZVN0cmF0ZWd5LCBjb250ZXh0KTtcblxuICAgIHZhciBpbnRlcnBvbGF0ZWRUZXh0O1xuICAgIGlmIChhbmd1bGFyLmlzTnVtYmVyKHZhbHVlKSkge1xuICAgICAgLy8gbnVtYmVycyBhcmUgc2FmZVxuICAgICAgaW50ZXJwb2xhdGVkVGV4dCA9ICcnICsgdmFsdWU7XG4gICAgfSBlbHNlIGlmIChhbmd1bGFyLmlzU3RyaW5nKHZhbHVlKSkge1xuICAgICAgLy8gc3RyaW5ncyBtdXN0IGJlIGludGVycG9sYXRlZCAodGhhdCdzIHRoZSBqb2IgaGVyZSlcbiAgICAgIGludGVycG9sYXRlZFRleHQgPSAkaW50ZXJwb2xhdGUodmFsdWUpKGludGVycG9sYXRpb25QYXJhbXMpO1xuICAgICAgaW50ZXJwb2xhdGVkVGV4dCA9ICR0cmFuc2xhdGVTYW5pdGl6YXRpb24uc2FuaXRpemUoaW50ZXJwb2xhdGVkVGV4dCwgJ3RleHQnLCBzYW5pdGl6ZVN0cmF0ZWd5LCBjb250ZXh0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gbmVpdGhlciBhIG51bWJlciBvciBhIHN0cmluZywgY2FudCBpbnRlcnBvbGF0ZSA9PiBlbXB0eSBzdHJpbmdcbiAgICAgIGludGVycG9sYXRlZFRleHQgPSAnJztcbiAgICB9XG5cbiAgICByZXR1cm4gaW50ZXJwb2xhdGVkVGV4dDtcbiAgfTtcblxuICByZXR1cm4gJHRyYW5zbGF0ZUludGVycG9sYXRvcjtcbn1cblxuJHRyYW5zbGF0ZURlZmF1bHRJbnRlcnBvbGF0aW9uLmRpc3BsYXlOYW1lID0gJyR0cmFuc2xhdGVEZWZhdWx0SW50ZXJwb2xhdGlvbic7XG5cbmFuZ3VsYXIubW9kdWxlKCdwYXNjYWxwcmVjaHQudHJhbnNsYXRlJykuY29uc3RhbnQoJyRTVE9SQUdFX0tFWScsICdOR19UUkFOU0xBVEVfTEFOR19LRVknKTtcblxuYW5ndWxhci5tb2R1bGUoJ3Bhc2NhbHByZWNodC50cmFuc2xhdGUnKVxuLyoqXG4gKiBAbmdkb2MgZGlyZWN0aXZlXG4gKiBAbmFtZSBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLmRpcmVjdGl2ZTp0cmFuc2xhdGVcbiAqIEByZXF1aXJlcyAkaW50ZXJwb2xhdGUsIFxuICogQHJlcXVpcmVzICRjb21waWxlLCBcbiAqIEByZXF1aXJlcyAkcGFyc2UsIFxuICogQHJlcXVpcmVzICRyb290U2NvcGVcbiAqIEByZXN0cmljdCBBRVxuICpcbiAqIEBkZXNjcmlwdGlvblxuICogVHJhbnNsYXRlcyBnaXZlbiB0cmFuc2xhdGlvbiBpZCBlaXRoZXIgdGhyb3VnaCBhdHRyaWJ1dGUgb3IgRE9NIGNvbnRlbnQuXG4gKiBJbnRlcm5hbGx5IGl0IHVzZXMgJHRyYW5zbGF0ZSBzZXJ2aWNlIHRvIHRyYW5zbGF0ZSB0aGUgdHJhbnNsYXRpb24gaWQuIEl0IHBvc3NpYmxlIHRvXG4gKiBwYXNzIGFuIG9wdGlvbmFsIGB0cmFuc2xhdGUtdmFsdWVzYCBvYmplY3QgbGl0ZXJhbCBhcyBzdHJpbmcgaW50byB0cmFuc2xhdGlvbiBpZC5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZz19IHRyYW5zbGF0ZSBUcmFuc2xhdGlvbiBpZCB3aGljaCBjb3VsZCBiZSBlaXRoZXIgc3RyaW5nIG9yIGludGVycG9sYXRlZCBzdHJpbmcuXG4gKiBAcGFyYW0ge3N0cmluZz19IHRyYW5zbGF0ZS12YWx1ZXMgVmFsdWVzIHRvIHBhc3MgaW50byB0cmFuc2xhdGlvbiBpZC4gQ2FuIGJlIHBhc3NlZCBhcyBvYmplY3QgbGl0ZXJhbCBzdHJpbmcgb3IgaW50ZXJwb2xhdGVkIG9iamVjdC5cbiAqIEBwYXJhbSB7c3RyaW5nPX0gdHJhbnNsYXRlLWF0dHItQVRUUiB0cmFuc2xhdGUgVHJhbnNsYXRpb24gaWQgYW5kIHB1dCBpdCBpbnRvIEFUVFIgYXR0cmlidXRlLlxuICogQHBhcmFtIHtzdHJpbmc9fSB0cmFuc2xhdGUtZGVmYXVsdCB3aWxsIGJlIHVzZWQgdW5sZXNzIHRyYW5zbGF0aW9uIHdhcyBzdWNjZXNzZnVsXG4gKiBAcGFyYW0ge2Jvb2xlYW49fSB0cmFuc2xhdGUtY29tcGlsZSAoZGVmYXVsdCB0cnVlIGlmIHByZXNlbnQpIGRlZmluZXMgbG9jYWxseSBhY3RpdmF0aW9uIG9mIHtAbGluayBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVQcm92aWRlciNtZXRob2RzX3VzZVBvc3RDb21waWxpbmd9XG4gKiBAcGFyYW0ge2Jvb2xlYW49fSB0cmFuc2xhdGUta2VlcC1jb250ZW50IChkZWZhdWx0IHRydWUgaWYgcHJlc2VudCkgZGVmaW5lcyB0aGF0IGluIGNhc2UgYSBLRVkgY291bGQgbm90IGJlIHRyYW5zbGF0ZWQsIHRoYXQgdGhlIGV4aXN0aW5nIGNvbnRlbnQgaXMgbGVmdCBpbiB0aGUgaW5uZXJIVE1MfVxuICpcbiAqIEBleGFtcGxlXG4gICA8ZXhhbXBsZSBtb2R1bGU9XCJuZ1ZpZXdcIj5cbiAgICA8ZmlsZSBuYW1lPVwiaW5kZXguaHRtbFwiPlxuICAgICAgPGRpdiBuZy1jb250cm9sbGVyPVwiVHJhbnNsYXRlQ3RybFwiPlxuXG4gICAgICAgIDxwcmUgdHJhbnNsYXRlPVwiVFJBTlNMQVRJT05fSURcIj48L3ByZT5cbiAgICAgICAgPHByZSB0cmFuc2xhdGU+VFJBTlNMQVRJT05fSUQ8L3ByZT5cbiAgICAgICAgPHByZSB0cmFuc2xhdGUgdHJhbnNsYXRlLWF0dHItdGl0bGU9XCJUUkFOU0xBVElPTl9JRFwiPjwvcHJlPlxuICAgICAgICA8cHJlIHRyYW5zbGF0ZT1cInt7dHJhbnNsYXRpb25JZH19XCI+PC9wcmU+XG4gICAgICAgIDxwcmUgdHJhbnNsYXRlPnt7dHJhbnNsYXRpb25JZH19PC9wcmU+XG4gICAgICAgIDxwcmUgdHJhbnNsYXRlPVwiV0lUSF9WQUxVRVNcIiB0cmFuc2xhdGUtdmFsdWVzPVwie3ZhbHVlOiA1fVwiPjwvcHJlPlxuICAgICAgICA8cHJlIHRyYW5zbGF0ZSB0cmFuc2xhdGUtdmFsdWVzPVwie3ZhbHVlOiA1fVwiPldJVEhfVkFMVUVTPC9wcmU+XG4gICAgICAgIDxwcmUgdHJhbnNsYXRlPVwiV0lUSF9WQUxVRVNcIiB0cmFuc2xhdGUtdmFsdWVzPVwie3t2YWx1ZXN9fVwiPjwvcHJlPlxuICAgICAgICA8cHJlIHRyYW5zbGF0ZSB0cmFuc2xhdGUtdmFsdWVzPVwie3t2YWx1ZXN9fVwiPldJVEhfVkFMVUVTPC9wcmU+XG4gICAgICAgIDxwcmUgdHJhbnNsYXRlIHRyYW5zbGF0ZS1hdHRyLXRpdGxlPVwiV0lUSF9WQUxVRVNcIiB0cmFuc2xhdGUtdmFsdWVzPVwie3t2YWx1ZXN9fVwiPjwvcHJlPlxuICAgICAgICA8cHJlIHRyYW5zbGF0ZT1cIldJVEhfQ0FNRUxfQ0FTRV9LRVlcIiB0cmFuc2xhdGUtdmFsdWUtY2FtZWwtY2FzZS1rZXk9XCJIaVwiPjwvcHJlPlxuXG4gICAgICA8L2Rpdj5cbiAgICA8L2ZpbGU+XG4gICAgPGZpbGUgbmFtZT1cInNjcmlwdC5qc1wiPlxuICAgICAgYW5ndWxhci5tb2R1bGUoJ25nVmlldycsIFsncGFzY2FscHJlY2h0LnRyYW5zbGF0ZSddKVxuXG4gICAgICAuY29uZmlnKGZ1bmN0aW9uICgkdHJhbnNsYXRlUHJvdmlkZXIpIHtcblxuICAgICAgICAkdHJhbnNsYXRlUHJvdmlkZXIudHJhbnNsYXRpb25zKCdlbicse1xuICAgICAgICAgICdUUkFOU0xBVElPTl9JRCc6ICdIZWxsbyB0aGVyZSEnLFxuICAgICAgICAgICdXSVRIX1ZBTFVFUyc6ICdUaGUgZm9sbG93aW5nIHZhbHVlIGlzIGR5bmFtaWM6IHt7dmFsdWV9fScsXG4gICAgICAgICAgJ1dJVEhfQ0FNRUxfQ0FTRV9LRVknOiAnVGhlIGludGVycG9sYXRpb24ga2V5IGlzIGNhbWVsIGNhc2VkOiB7e2NhbWVsQ2FzZUtleX19J1xuICAgICAgICB9KS5wcmVmZXJyZWRMYW5ndWFnZSgnZW4nKTtcblxuICAgICAgfSk7XG5cbiAgICAgIGFuZ3VsYXIubW9kdWxlKCduZ1ZpZXcnKS5jb250cm9sbGVyKCdUcmFuc2xhdGVDdHJsJywgZnVuY3Rpb24gKCRzY29wZSkge1xuICAgICAgICAkc2NvcGUudHJhbnNsYXRpb25JZCA9ICdUUkFOU0xBVElPTl9JRCc7XG5cbiAgICAgICAgJHNjb3BlLnZhbHVlcyA9IHtcbiAgICAgICAgICB2YWx1ZTogNzhcbiAgICAgICAgfTtcbiAgICAgIH0pO1xuICAgIDwvZmlsZT5cbiAgICA8ZmlsZSBuYW1lPVwic2NlbmFyaW8uanNcIj5cbiAgICAgIGl0KCdzaG91bGQgdHJhbnNsYXRlJywgZnVuY3Rpb24gKCkge1xuICAgICAgICBpbmplY3QoZnVuY3Rpb24gKCRyb290U2NvcGUsICRjb21waWxlKSB7XG4gICAgICAgICAgJHJvb3RTY29wZS50cmFuc2xhdGlvbklkID0gJ1RSQU5TTEFUSU9OX0lEJztcblxuICAgICAgICAgIGVsZW1lbnQgPSAkY29tcGlsZSgnPHAgdHJhbnNsYXRlPVwiVFJBTlNMQVRJT05fSURcIj48L3A+JykoJHJvb3RTY29wZSk7XG4gICAgICAgICAgJHJvb3RTY29wZS4kZGlnZXN0KCk7XG4gICAgICAgICAgZXhwZWN0KGVsZW1lbnQudGV4dCgpKS50b0JlKCdIZWxsbyB0aGVyZSEnKTtcblxuICAgICAgICAgIGVsZW1lbnQgPSAkY29tcGlsZSgnPHAgdHJhbnNsYXRlPVwie3t0cmFuc2xhdGlvbklkfX1cIj48L3A+JykoJHJvb3RTY29wZSk7XG4gICAgICAgICAgJHJvb3RTY29wZS4kZGlnZXN0KCk7XG4gICAgICAgICAgZXhwZWN0KGVsZW1lbnQudGV4dCgpKS50b0JlKCdIZWxsbyB0aGVyZSEnKTtcblxuICAgICAgICAgIGVsZW1lbnQgPSAkY29tcGlsZSgnPHAgdHJhbnNsYXRlPlRSQU5TTEFUSU9OX0lEPC9wPicpKCRyb290U2NvcGUpO1xuICAgICAgICAgICRyb290U2NvcGUuJGRpZ2VzdCgpO1xuICAgICAgICAgIGV4cGVjdChlbGVtZW50LnRleHQoKSkudG9CZSgnSGVsbG8gdGhlcmUhJyk7XG5cbiAgICAgICAgICBlbGVtZW50ID0gJGNvbXBpbGUoJzxwIHRyYW5zbGF0ZT57e3RyYW5zbGF0aW9uSWR9fTwvcD4nKSgkcm9vdFNjb3BlKTtcbiAgICAgICAgICAkcm9vdFNjb3BlLiRkaWdlc3QoKTtcbiAgICAgICAgICBleHBlY3QoZWxlbWVudC50ZXh0KCkpLnRvQmUoJ0hlbGxvIHRoZXJlIScpO1xuXG4gICAgICAgICAgZWxlbWVudCA9ICRjb21waWxlKCc8cCB0cmFuc2xhdGUgdHJhbnNsYXRlLWF0dHItdGl0bGU9XCJUUkFOU0xBVElPTl9JRFwiPjwvcD4nKSgkcm9vdFNjb3BlKTtcbiAgICAgICAgICAkcm9vdFNjb3BlLiRkaWdlc3QoKTtcbiAgICAgICAgICBleHBlY3QoZWxlbWVudC5hdHRyKCd0aXRsZScpKS50b0JlKCdIZWxsbyB0aGVyZSEnKTtcblxuICAgICAgICAgIGVsZW1lbnQgPSAkY29tcGlsZSgnPHAgdHJhbnNsYXRlPVwiV0lUSF9DQU1FTF9DQVNFX0tFWVwiIHRyYW5zbGF0ZS12YWx1ZS1jYW1lbC1jYXNlLWtleT1cIkhlbGxvXCI+PC9wPicpKCRyb290U2NvcGUpO1xuICAgICAgICAgICRyb290U2NvcGUuJGRpZ2VzdCgpO1xuICAgICAgICAgIGV4cGVjdChlbGVtZW50LnRleHQoKSkudG9CZSgnVGhlIGludGVycG9sYXRpb24ga2V5IGlzIGNhbWVsIGNhc2VkOiBIZWxsbycpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIDwvZmlsZT5cbiAgIDwvZXhhbXBsZT5cbiAqL1xuLmRpcmVjdGl2ZSgndHJhbnNsYXRlJywgdHJhbnNsYXRlRGlyZWN0aXZlKTtcbmZ1bmN0aW9uIHRyYW5zbGF0ZURpcmVjdGl2ZSgkdHJhbnNsYXRlLCAkaW50ZXJwb2xhdGUsICRjb21waWxlLCAkcGFyc2UsICRyb290U2NvcGUpIHtcblxuICAndXNlIHN0cmljdCc7XG5cbiAgLyoqXG4gICAqIEBuYW1lIHRyaW1cbiAgICogQHByaXZhdGVcbiAgICpcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqIHRyaW0gcG9seWZpbGxcbiAgICpcbiAgICogQHJldHVybnMge3N0cmluZ30gVGhlIHN0cmluZyBzdHJpcHBlZCBvZiB3aGl0ZXNwYWNlIGZyb20gYm90aCBlbmRzXG4gICAqL1xuICB2YXIgdHJpbSA9IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLnRvU3RyaW5nKCkucmVwbGFjZSgvXlxccyt8XFxzKyQvZywgJycpO1xuICB9O1xuXG4gIHJldHVybiB7XG4gICAgcmVzdHJpY3Q6ICdBRScsXG4gICAgc2NvcGU6IHRydWUsXG4gICAgcHJpb3JpdHk6ICR0cmFuc2xhdGUuZGlyZWN0aXZlUHJpb3JpdHkoKSxcbiAgICBjb21waWxlOiBmdW5jdGlvbiAodEVsZW1lbnQsIHRBdHRyKSB7XG5cbiAgICAgIHZhciB0cmFuc2xhdGVWYWx1ZXNFeGlzdCA9ICh0QXR0ci50cmFuc2xhdGVWYWx1ZXMpID9cbiAgICAgICAgdEF0dHIudHJhbnNsYXRlVmFsdWVzIDogdW5kZWZpbmVkO1xuXG4gICAgICB2YXIgdHJhbnNsYXRlSW50ZXJwb2xhdGlvbiA9ICh0QXR0ci50cmFuc2xhdGVJbnRlcnBvbGF0aW9uKSA/XG4gICAgICAgIHRBdHRyLnRyYW5zbGF0ZUludGVycG9sYXRpb24gOiB1bmRlZmluZWQ7XG5cbiAgICAgIHZhciB0cmFuc2xhdGVWYWx1ZUV4aXN0ID0gdEVsZW1lbnRbMF0ub3V0ZXJIVE1MLm1hdGNoKC90cmFuc2xhdGUtdmFsdWUtKy9pKTtcblxuICAgICAgdmFyIGludGVycG9sYXRlUmVnRXhwID0gJ14oLiopKCcgKyAkaW50ZXJwb2xhdGUuc3RhcnRTeW1ib2woKSArICcuKicgKyAkaW50ZXJwb2xhdGUuZW5kU3ltYm9sKCkgKyAnKSguKiknLFxuICAgICAgICAgIHdhdGNoZXJSZWdFeHAgPSAnXiguKiknICsgJGludGVycG9sYXRlLnN0YXJ0U3ltYm9sKCkgKyAnKC4qKScgKyAkaW50ZXJwb2xhdGUuZW5kU3ltYm9sKCkgKyAnKC4qKSc7XG5cbiAgICAgIHJldHVybiBmdW5jdGlvbiBsaW5rRm4oc2NvcGUsIGlFbGVtZW50LCBpQXR0cikge1xuXG4gICAgICAgIHNjb3BlLmludGVycG9sYXRlUGFyYW1zID0ge307XG4gICAgICAgIHNjb3BlLnByZVRleHQgPSAnJztcbiAgICAgICAgc2NvcGUucG9zdFRleHQgPSAnJztcbiAgICAgICAgc2NvcGUudHJhbnNsYXRlTmFtZXNwYWNlID0gZ2V0VHJhbnNsYXRlTmFtZXNwYWNlKHNjb3BlKTtcbiAgICAgICAgdmFyIHRyYW5zbGF0aW9uSWRzID0ge307XG5cbiAgICAgICAgdmFyIGluaXRJbnRlcnBvbGF0aW9uUGFyYW1zID0gZnVuY3Rpb24gKGludGVycG9sYXRlUGFyYW1zLCBpQXR0ciwgdEF0dHIpIHtcbiAgICAgICAgICAvLyBpbml0aWFsIHNldHVwXG4gICAgICAgICAgaWYgKGlBdHRyLnRyYW5zbGF0ZVZhbHVlcykge1xuICAgICAgICAgICAgYW5ndWxhci5leHRlbmQoaW50ZXJwb2xhdGVQYXJhbXMsICRwYXJzZShpQXR0ci50cmFuc2xhdGVWYWx1ZXMpKHNjb3BlLiRwYXJlbnQpKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgLy8gaW5pdGlhbGx5IGZldGNoIGFsbCBhdHRyaWJ1dGVzIGlmIGV4aXN0aW5nIGFuZCBmaWxsIHRoZSBwYXJhbXNcbiAgICAgICAgICBpZiAodHJhbnNsYXRlVmFsdWVFeGlzdCkge1xuICAgICAgICAgICAgZm9yICh2YXIgYXR0ciBpbiB0QXR0cikge1xuICAgICAgICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGlBdHRyLCBhdHRyKSAmJiBhdHRyLnN1YnN0cigwLCAxNCkgPT09ICd0cmFuc2xhdGVWYWx1ZScgJiYgYXR0ciAhPT0gJ3RyYW5zbGF0ZVZhbHVlcycpIHtcbiAgICAgICAgICAgICAgICB2YXIgYXR0cmlidXRlTmFtZSA9IGFuZ3VsYXIubG93ZXJjYXNlKGF0dHIuc3Vic3RyKDE0LCAxKSkgKyBhdHRyLnN1YnN0cigxNSk7XG4gICAgICAgICAgICAgICAgaW50ZXJwb2xhdGVQYXJhbXNbYXR0cmlidXRlTmFtZV0gPSB0QXR0clthdHRyXTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICAvLyBFbnN1cmVzIGFueSBjaGFuZ2Ugb2YgdGhlIGF0dHJpYnV0ZSBcInRyYW5zbGF0ZVwiIGNvbnRhaW5pbmcgdGhlIGlkIHdpbGxcbiAgICAgICAgLy8gYmUgcmUtc3RvcmVkIHRvIHRoZSBzY29wZSdzIFwidHJhbnNsYXRpb25JZFwiLlxuICAgICAgICAvLyBJZiB0aGUgYXR0cmlidXRlIGhhcyBubyBjb250ZW50LCB0aGUgZWxlbWVudCdzIHRleHQgdmFsdWUgKHdoaXRlIHNwYWNlcyB0cmltbWVkIG9mZikgd2lsbCBiZSB1c2VkLlxuICAgICAgICB2YXIgb2JzZXJ2ZUVsZW1lbnRUcmFuc2xhdGlvbiA9IGZ1bmN0aW9uICh0cmFuc2xhdGlvbklkKSB7XG5cbiAgICAgICAgICAvLyBSZW1vdmUgYW55IG9sZCB3YXRjaGVyXG4gICAgICAgICAgaWYgKGFuZ3VsYXIuaXNGdW5jdGlvbihvYnNlcnZlRWxlbWVudFRyYW5zbGF0aW9uLl91bndhdGNoT2xkKSkge1xuICAgICAgICAgICAgb2JzZXJ2ZUVsZW1lbnRUcmFuc2xhdGlvbi5fdW53YXRjaE9sZCgpO1xuICAgICAgICAgICAgb2JzZXJ2ZUVsZW1lbnRUcmFuc2xhdGlvbi5fdW53YXRjaE9sZCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAoYW5ndWxhci5lcXVhbHModHJhbnNsYXRpb25JZCAsICcnKSB8fCAhYW5ndWxhci5pc0RlZmluZWQodHJhbnNsYXRpb25JZCkpIHtcbiAgICAgICAgICAgIHZhciBpRWxlbWVudFRleHQgPSB0cmltLmFwcGx5KGlFbGVtZW50LnRleHQoKSk7XG5cbiAgICAgICAgICAgIC8vIFJlc29sdmUgdHJhbnNsYXRpb24gaWQgYnkgaW5uZXIgaHRtbCBpZiByZXF1aXJlZFxuICAgICAgICAgICAgdmFyIGludGVycG9sYXRlTWF0Y2hlcyA9IGlFbGVtZW50VGV4dC5tYXRjaChpbnRlcnBvbGF0ZVJlZ0V4cCk7XG4gICAgICAgICAgICAvLyBJbnRlcnBvbGF0ZSB0cmFuc2xhdGlvbiBpZCBpZiByZXF1aXJlZFxuICAgICAgICAgICAgaWYgKGFuZ3VsYXIuaXNBcnJheShpbnRlcnBvbGF0ZU1hdGNoZXMpKSB7XG4gICAgICAgICAgICAgIHNjb3BlLnByZVRleHQgPSBpbnRlcnBvbGF0ZU1hdGNoZXNbMV07XG4gICAgICAgICAgICAgIHNjb3BlLnBvc3RUZXh0ID0gaW50ZXJwb2xhdGVNYXRjaGVzWzNdO1xuICAgICAgICAgICAgICB0cmFuc2xhdGlvbklkcy50cmFuc2xhdGUgPSAkaW50ZXJwb2xhdGUoaW50ZXJwb2xhdGVNYXRjaGVzWzJdKShzY29wZS4kcGFyZW50KTtcbiAgICAgICAgICAgICAgdmFyIHdhdGNoZXJNYXRjaGVzID0gaUVsZW1lbnRUZXh0Lm1hdGNoKHdhdGNoZXJSZWdFeHApO1xuICAgICAgICAgICAgICBpZiAoYW5ndWxhci5pc0FycmF5KHdhdGNoZXJNYXRjaGVzKSAmJiB3YXRjaGVyTWF0Y2hlc1syXSAmJiB3YXRjaGVyTWF0Y2hlc1syXS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBvYnNlcnZlRWxlbWVudFRyYW5zbGF0aW9uLl91bndhdGNoT2xkID0gc2NvcGUuJHdhdGNoKHdhdGNoZXJNYXRjaGVzWzJdLCBmdW5jdGlvbiAobmV3VmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgIHRyYW5zbGF0aW9uSWRzLnRyYW5zbGF0ZSA9IG5ld1ZhbHVlO1xuICAgICAgICAgICAgICAgICAgdXBkYXRlVHJhbnNsYXRpb25zKCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIC8vIGRvIG5vdCBhc3NpZ25lIHRoZSB0cmFuc2xhdGlvbiBpZCBpZiBpdCBpcyBlbXB0eS5cbiAgICAgICAgICAgICAgdHJhbnNsYXRpb25JZHMudHJhbnNsYXRlID0gIWlFbGVtZW50VGV4dCA/IHVuZGVmaW5lZCA6IGlFbGVtZW50VGV4dDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdHJhbnNsYXRpb25JZHMudHJhbnNsYXRlID0gdHJhbnNsYXRpb25JZDtcbiAgICAgICAgICB9XG4gICAgICAgICAgdXBkYXRlVHJhbnNsYXRpb25zKCk7XG4gICAgICAgIH07XG5cbiAgICAgICAgdmFyIG9ic2VydmVBdHRyaWJ1dGVUcmFuc2xhdGlvbiA9IGZ1bmN0aW9uICh0cmFuc2xhdGVBdHRyKSB7XG4gICAgICAgICAgaUF0dHIuJG9ic2VydmUodHJhbnNsYXRlQXR0ciwgZnVuY3Rpb24gKHRyYW5zbGF0aW9uSWQpIHtcbiAgICAgICAgICAgIHRyYW5zbGF0aW9uSWRzW3RyYW5zbGF0ZUF0dHJdID0gdHJhbnNsYXRpb25JZDtcbiAgICAgICAgICAgIHVwZGF0ZVRyYW5zbGF0aW9ucygpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8vIGluaXRpYWwgc2V0dXAgd2l0aCB2YWx1ZXNcbiAgICAgICAgaW5pdEludGVycG9sYXRpb25QYXJhbXMoc2NvcGUuaW50ZXJwb2xhdGVQYXJhbXMsIGlBdHRyLCB0QXR0cik7XG5cbiAgICAgICAgdmFyIGZpcnN0QXR0cmlidXRlQ2hhbmdlZEV2ZW50ID0gdHJ1ZTtcbiAgICAgICAgaUF0dHIuJG9ic2VydmUoJ3RyYW5zbGF0ZScsIGZ1bmN0aW9uICh0cmFuc2xhdGlvbklkKSB7XG4gICAgICAgICAgaWYgKHR5cGVvZiB0cmFuc2xhdGlvbklkID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgLy8gY2FzZSBvZiBlbGVtZW50IFwiPHRyYW5zbGF0ZT54eXo8L3RyYW5zbGF0ZT5cIlxuICAgICAgICAgICAgb2JzZXJ2ZUVsZW1lbnRUcmFuc2xhdGlvbignJyk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIGNhc2Ugb2YgcmVndWxhciBhdHRyaWJ1dGVcbiAgICAgICAgICAgIGlmICh0cmFuc2xhdGlvbklkICE9PSAnJyB8fCAhZmlyc3RBdHRyaWJ1dGVDaGFuZ2VkRXZlbnQpIHtcbiAgICAgICAgICAgICAgdHJhbnNsYXRpb25JZHMudHJhbnNsYXRlID0gdHJhbnNsYXRpb25JZDtcbiAgICAgICAgICAgICAgdXBkYXRlVHJhbnNsYXRpb25zKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGZpcnN0QXR0cmlidXRlQ2hhbmdlZEV2ZW50ID0gZmFsc2U7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGZvciAodmFyIHRyYW5zbGF0ZUF0dHIgaW4gaUF0dHIpIHtcbiAgICAgICAgICBpZiAoaUF0dHIuaGFzT3duUHJvcGVydHkodHJhbnNsYXRlQXR0cikgJiYgdHJhbnNsYXRlQXR0ci5zdWJzdHIoMCwgMTMpID09PSAndHJhbnNsYXRlQXR0cicgJiYgdHJhbnNsYXRlQXR0ci5sZW5ndGggPiAxMykge1xuICAgICAgICAgICAgb2JzZXJ2ZUF0dHJpYnV0ZVRyYW5zbGF0aW9uKHRyYW5zbGF0ZUF0dHIpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlBdHRyLiRvYnNlcnZlKCd0cmFuc2xhdGVEZWZhdWx0JywgZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgICAgICAgc2NvcGUuZGVmYXVsdFRleHQgPSB2YWx1ZTtcbiAgICAgICAgICB1cGRhdGVUcmFuc2xhdGlvbnMoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKHRyYW5zbGF0ZVZhbHVlc0V4aXN0KSB7XG4gICAgICAgICAgaUF0dHIuJG9ic2VydmUoJ3RyYW5zbGF0ZVZhbHVlcycsIGZ1bmN0aW9uIChpbnRlcnBvbGF0ZVBhcmFtcykge1xuICAgICAgICAgICAgaWYgKGludGVycG9sYXRlUGFyYW1zKSB7XG4gICAgICAgICAgICAgIHNjb3BlLiRwYXJlbnQuJHdhdGNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBhbmd1bGFyLmV4dGVuZChzY29wZS5pbnRlcnBvbGF0ZVBhcmFtcywgJHBhcnNlKGludGVycG9sYXRlUGFyYW1zKShzY29wZS4kcGFyZW50KSk7XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRyYW5zbGF0ZVZhbHVlRXhpc3QpIHtcbiAgICAgICAgICB2YXIgb2JzZXJ2ZVZhbHVlQXR0cmlidXRlID0gZnVuY3Rpb24gKGF0dHJOYW1lKSB7XG4gICAgICAgICAgICBpQXR0ci4kb2JzZXJ2ZShhdHRyTmFtZSwgZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgICAgICAgICAgIHZhciBhdHRyaWJ1dGVOYW1lID0gYW5ndWxhci5sb3dlcmNhc2UoYXR0ck5hbWUuc3Vic3RyKDE0LCAxKSkgKyBhdHRyTmFtZS5zdWJzdHIoMTUpO1xuICAgICAgICAgICAgICBzY29wZS5pbnRlcnBvbGF0ZVBhcmFtc1thdHRyaWJ1dGVOYW1lXSA9IHZhbHVlO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfTtcbiAgICAgICAgICBmb3IgKHZhciBhdHRyIGluIGlBdHRyKSB7XG4gICAgICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGlBdHRyLCBhdHRyKSAmJiBhdHRyLnN1YnN0cigwLCAxNCkgPT09ICd0cmFuc2xhdGVWYWx1ZScgJiYgYXR0ciAhPT0gJ3RyYW5zbGF0ZVZhbHVlcycpIHtcbiAgICAgICAgICAgICAgb2JzZXJ2ZVZhbHVlQXR0cmlidXRlKGF0dHIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIE1hc3RlciB1cGRhdGUgZnVuY3Rpb25cbiAgICAgICAgdmFyIHVwZGF0ZVRyYW5zbGF0aW9ucyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gdHJhbnNsYXRpb25JZHMpIHtcbiAgICAgICAgICAgIGlmICh0cmFuc2xhdGlvbklkcy5oYXNPd25Qcm9wZXJ0eShrZXkpICYmIHRyYW5zbGF0aW9uSWRzW2tleV0gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICB1cGRhdGVUcmFuc2xhdGlvbihrZXksIHRyYW5zbGF0aW9uSWRzW2tleV0sIHNjb3BlLCBzY29wZS5pbnRlcnBvbGF0ZVBhcmFtcywgc2NvcGUuZGVmYXVsdFRleHQsIHNjb3BlLnRyYW5zbGF0ZU5hbWVzcGFjZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIC8vIFB1dCB0cmFuc2xhdGlvbiBwcm9jZXNzaW5nIGZ1bmN0aW9uIG91dHNpZGUgbG9vcFxuICAgICAgICB2YXIgdXBkYXRlVHJhbnNsYXRpb24gPSBmdW5jdGlvbih0cmFuc2xhdGVBdHRyLCB0cmFuc2xhdGlvbklkLCBzY29wZSwgaW50ZXJwb2xhdGVQYXJhbXMsIGRlZmF1bHRUcmFuc2xhdGlvblRleHQsIHRyYW5zbGF0ZU5hbWVzcGFjZSkge1xuICAgICAgICAgIGlmICh0cmFuc2xhdGlvbklkKSB7XG4gICAgICAgICAgICAvLyBpZiB0cmFuc2xhdGlvbiBpZCBzdGFydHMgd2l0aCAnLicgYW5kIHRyYW5zbGF0ZU5hbWVzcGFjZSBnaXZlbiwgcHJlcGVuZCBuYW1lc3BhY2VcbiAgICAgICAgICAgIGlmICh0cmFuc2xhdGVOYW1lc3BhY2UgJiYgdHJhbnNsYXRpb25JZC5jaGFyQXQoMCkgPT09ICcuJykge1xuICAgICAgICAgICAgICB0cmFuc2xhdGlvbklkID0gdHJhbnNsYXRlTmFtZXNwYWNlICsgdHJhbnNsYXRpb25JZDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgJHRyYW5zbGF0ZSh0cmFuc2xhdGlvbklkLCBpbnRlcnBvbGF0ZVBhcmFtcywgdHJhbnNsYXRlSW50ZXJwb2xhdGlvbiwgZGVmYXVsdFRyYW5zbGF0aW9uVGV4dCwgc2NvcGUudHJhbnNsYXRlTGFuZ3VhZ2UpXG4gICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uICh0cmFuc2xhdGlvbikge1xuICAgICAgICAgICAgICAgIGFwcGx5VHJhbnNsYXRpb24odHJhbnNsYXRpb24sIHNjb3BlLCB0cnVlLCB0cmFuc2xhdGVBdHRyKTtcbiAgICAgICAgICAgICAgfSwgZnVuY3Rpb24gKHRyYW5zbGF0aW9uSWQpIHtcbiAgICAgICAgICAgICAgICBhcHBseVRyYW5zbGF0aW9uKHRyYW5zbGF0aW9uSWQsIHNjb3BlLCBmYWxzZSwgdHJhbnNsYXRlQXR0cik7XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBhcyBhbiBlbXB0eSBzdHJpbmcgY2Fubm90IGJlIHRyYW5zbGF0ZWQsIHdlIGNhbiBzb2x2ZSB0aGlzIHVzaW5nIHN1Y2Nlc3NmdWw9ZmFsc2VcbiAgICAgICAgICAgIGFwcGx5VHJhbnNsYXRpb24odHJhbnNsYXRpb25JZCwgc2NvcGUsIGZhbHNlLCB0cmFuc2xhdGVBdHRyKTtcbiAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgdmFyIGFwcGx5VHJhbnNsYXRpb24gPSBmdW5jdGlvbiAodmFsdWUsIHNjb3BlLCBzdWNjZXNzZnVsLCB0cmFuc2xhdGVBdHRyKSB7XG4gICAgICAgICAgaWYgKCFzdWNjZXNzZnVsKSB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHNjb3BlLmRlZmF1bHRUZXh0ICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICB2YWx1ZSA9IHNjb3BlLmRlZmF1bHRUZXh0O1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAodHJhbnNsYXRlQXR0ciA9PT0gJ3RyYW5zbGF0ZScpIHtcbiAgICAgICAgICAgIC8vIGRlZmF1bHQgdHJhbnNsYXRlIGludG8gaW5uZXJIVE1MXG4gICAgICAgICAgICBpZiAoc3VjY2Vzc2Z1bCB8fCAoIXN1Y2Nlc3NmdWwgJiYgISR0cmFuc2xhdGUuaXNLZWVwQ29udGVudCgpICYmIHR5cGVvZiBpQXR0ci50cmFuc2xhdGVLZWVwQ29udGVudCA9PT0gJ3VuZGVmaW5lZCcpKSB7XG4gICAgICAgICAgICAgIGlFbGVtZW50LmVtcHR5KCkuYXBwZW5kKHNjb3BlLnByZVRleHQgKyB2YWx1ZSArIHNjb3BlLnBvc3RUZXh0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBnbG9iYWxseUVuYWJsZWQgPSAkdHJhbnNsYXRlLmlzUG9zdENvbXBpbGluZ0VuYWJsZWQoKTtcbiAgICAgICAgICAgIHZhciBsb2NhbGx5RGVmaW5lZCA9IHR5cGVvZiB0QXR0ci50cmFuc2xhdGVDb21waWxlICE9PSAndW5kZWZpbmVkJztcbiAgICAgICAgICAgIHZhciBsb2NhbGx5RW5hYmxlZCA9IGxvY2FsbHlEZWZpbmVkICYmIHRBdHRyLnRyYW5zbGF0ZUNvbXBpbGUgIT09ICdmYWxzZSc7XG4gICAgICAgICAgICBpZiAoKGdsb2JhbGx5RW5hYmxlZCAmJiAhbG9jYWxseURlZmluZWQpIHx8IGxvY2FsbHlFbmFibGVkKSB7XG4gICAgICAgICAgICAgICRjb21waWxlKGlFbGVtZW50LmNvbnRlbnRzKCkpKHNjb3BlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gdHJhbnNsYXRlIGF0dHJpYnV0ZVxuICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZU5hbWUgPSBpQXR0ci4kYXR0clt0cmFuc2xhdGVBdHRyXTtcbiAgICAgICAgICAgIGlmIChhdHRyaWJ1dGVOYW1lLnN1YnN0cigwLCA1KSA9PT0gJ2RhdGEtJykge1xuICAgICAgICAgICAgICAvLyBlbnN1cmUgaHRtbDUgZGF0YSBwcmVmaXggaXMgc3RyaXBwZWRcbiAgICAgICAgICAgICAgYXR0cmlidXRlTmFtZSA9IGF0dHJpYnV0ZU5hbWUuc3Vic3RyKDUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYXR0cmlidXRlTmFtZSA9IGF0dHJpYnV0ZU5hbWUuc3Vic3RyKDE1KTtcbiAgICAgICAgICAgIGlFbGVtZW50LmF0dHIoYXR0cmlidXRlTmFtZSwgdmFsdWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICBpZiAodHJhbnNsYXRlVmFsdWVzRXhpc3QgfHwgdHJhbnNsYXRlVmFsdWVFeGlzdCB8fCBpQXR0ci50cmFuc2xhdGVEZWZhdWx0KSB7XG4gICAgICAgICAgc2NvcGUuJHdhdGNoKCdpbnRlcnBvbGF0ZVBhcmFtcycsIHVwZGF0ZVRyYW5zbGF0aW9ucywgdHJ1ZSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBSZXBsYWNlZCB3YXRjaGVyIG9uIHRyYW5zbGF0ZUxhbmd1YWdlIHdpdGggZXZlbnQgbGlzdGVuZXJcbiAgICAgICAgc2NvcGUuJG9uKCd0cmFuc2xhdGVMYW5ndWFnZUNoYW5nZWQnLCB1cGRhdGVUcmFuc2xhdGlvbnMpO1xuXG4gICAgICAgIC8vIEVuc3VyZXMgdGhlIHRleHQgd2lsbCBiZSByZWZyZXNoZWQgYWZ0ZXIgdGhlIGN1cnJlbnQgbGFuZ3VhZ2Ugd2FzIGNoYW5nZWRcbiAgICAgICAgLy8gdy8gJHRyYW5zbGF0ZS51c2UoLi4uKVxuICAgICAgICB2YXIgdW5iaW5kID0gJHJvb3RTY29wZS4kb24oJyR0cmFuc2xhdGVDaGFuZ2VTdWNjZXNzJywgdXBkYXRlVHJhbnNsYXRpb25zKTtcblxuICAgICAgICAvLyBlbnN1cmUgdHJhbnNsYXRpb24gd2lsbCBiZSBsb29rZWQgdXAgYXQgbGVhc3Qgb25lXG4gICAgICAgIGlmIChpRWxlbWVudC50ZXh0KCkubGVuZ3RoKSB7XG4gICAgICAgICAgaWYgKGlBdHRyLnRyYW5zbGF0ZSkge1xuICAgICAgICAgICAgb2JzZXJ2ZUVsZW1lbnRUcmFuc2xhdGlvbihpQXR0ci50cmFuc2xhdGUpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBvYnNlcnZlRWxlbWVudFRyYW5zbGF0aW9uKCcnKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAoaUF0dHIudHJhbnNsYXRlKSB7XG4gICAgICAgICAgLy8gZW5zdXJlIGF0dHJpYnV0ZSB3aWxsIGJlIG5vdCBza2lwcGVkXG4gICAgICAgICAgb2JzZXJ2ZUVsZW1lbnRUcmFuc2xhdGlvbihpQXR0ci50cmFuc2xhdGUpO1xuICAgICAgICB9XG4gICAgICAgIHVwZGF0ZVRyYW5zbGF0aW9ucygpO1xuICAgICAgICBzY29wZS4kb24oJyRkZXN0cm95JywgdW5iaW5kKTtcbiAgICAgIH07XG4gICAgfVxuICB9O1xufVxuXG4vKipcbiAqIFJldHVybnMgdGhlIHNjb3BlJ3MgbmFtZXNwYWNlLlxuICogQHByaXZhdGVcbiAqIEBwYXJhbSBzY29wZVxuICogQHJldHVybnMge3N0cmluZ31cbiAqL1xuZnVuY3Rpb24gZ2V0VHJhbnNsYXRlTmFtZXNwYWNlKHNjb3BlKSB7XG4gICd1c2Ugc3RyaWN0JztcbiAgaWYgKHNjb3BlLnRyYW5zbGF0ZU5hbWVzcGFjZSkge1xuICAgIHJldHVybiBzY29wZS50cmFuc2xhdGVOYW1lc3BhY2U7XG4gIH1cbiAgaWYgKHNjb3BlLiRwYXJlbnQpIHtcbiAgICByZXR1cm4gZ2V0VHJhbnNsYXRlTmFtZXNwYWNlKHNjb3BlLiRwYXJlbnQpO1xuICB9XG59XG5cbnRyYW5zbGF0ZURpcmVjdGl2ZS5kaXNwbGF5TmFtZSA9ICd0cmFuc2xhdGVEaXJlY3RpdmUnO1xuXG5hbmd1bGFyLm1vZHVsZSgncGFzY2FscHJlY2h0LnRyYW5zbGF0ZScpXG4vKipcbiAqIEBuZ2RvYyBkaXJlY3RpdmVcbiAqIEBuYW1lIHBhc2NhbHByZWNodC50cmFuc2xhdGUuZGlyZWN0aXZlOnRyYW5zbGF0ZS1hdHRyXG4gKiBAcmVzdHJpY3QgQVxuICpcbiAqIEBkZXNjcmlwdGlvblxuICogVHJhbnNsYXRlcyBhdHRyaWJ1dGVzIGxpa2UgdHJhbnNsYXRlLWF0dHItQVRUUiwgYnV0IHdpdGggYW4gb2JqZWN0IGxpa2UgbmctY2xhc3MuXG4gKiBJbnRlcm5hbGx5IGl0IHVzZXMgYHRyYW5zbGF0ZWAgc2VydmljZSB0byB0cmFuc2xhdGUgdHJhbnNsYXRpb24gaWQuIEl0IHBvc3NpYmxlIHRvXG4gKiBwYXNzIGFuIG9wdGlvbmFsIGB0cmFuc2xhdGUtdmFsdWVzYCBvYmplY3QgbGl0ZXJhbCBhcyBzdHJpbmcgaW50byB0cmFuc2xhdGlvbiBpZC5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZz19IHRyYW5zbGF0ZS1hdHRyIE9iamVjdCBsaXRlcmFsIG1hcHBpbmcgYXR0cmlidXRlcyB0byB0cmFuc2xhdGlvbiBpZHMuXG4gKiBAcGFyYW0ge3N0cmluZz19IHRyYW5zbGF0ZS12YWx1ZXMgVmFsdWVzIHRvIHBhc3MgaW50byB0aGUgdHJhbnNsYXRpb24gaWRzLiBDYW4gYmUgcGFzc2VkIGFzIG9iamVjdCBsaXRlcmFsIHN0cmluZy5cbiAqXG4gKiBAZXhhbXBsZVxuICAgPGV4YW1wbGUgbW9kdWxlPVwibmdWaWV3XCI+XG4gICAgPGZpbGUgbmFtZT1cImluZGV4Lmh0bWxcIj5cbiAgICAgIDxkaXYgbmctY29udHJvbGxlcj1cIlRyYW5zbGF0ZUN0cmxcIj5cblxuICAgICAgICA8aW5wdXQgdHJhbnNsYXRlLWF0dHI9XCJ7IHBsYWNlaG9sZGVyOiB0cmFuc2xhdGlvbklkLCB0aXRsZTogJ1dJVEhfVkFMVUVTJyB9XCIgdHJhbnNsYXRlLXZhbHVlcz1cInt2YWx1ZTogNX1cIiAvPlxuXG4gICAgICA8L2Rpdj5cbiAgICA8L2ZpbGU+XG4gICAgPGZpbGUgbmFtZT1cInNjcmlwdC5qc1wiPlxuICAgICAgYW5ndWxhci5tb2R1bGUoJ25nVmlldycsIFsncGFzY2FscHJlY2h0LnRyYW5zbGF0ZSddKVxuXG4gICAgICAuY29uZmlnKGZ1bmN0aW9uICgkdHJhbnNsYXRlUHJvdmlkZXIpIHtcblxuICAgICAgICAkdHJhbnNsYXRlUHJvdmlkZXIudHJhbnNsYXRpb25zKCdlbicse1xuICAgICAgICAgICdUUkFOU0xBVElPTl9JRCc6ICdIZWxsbyB0aGVyZSEnLFxuICAgICAgICAgICdXSVRIX1ZBTFVFUyc6ICdUaGUgZm9sbG93aW5nIHZhbHVlIGlzIGR5bmFtaWM6IHt7dmFsdWV9fScsXG4gICAgICAgIH0pLnByZWZlcnJlZExhbmd1YWdlKCdlbicpO1xuXG4gICAgICB9KTtcblxuICAgICAgYW5ndWxhci5tb2R1bGUoJ25nVmlldycpLmNvbnRyb2xsZXIoJ1RyYW5zbGF0ZUN0cmwnLCBmdW5jdGlvbiAoJHNjb3BlKSB7XG4gICAgICAgICRzY29wZS50cmFuc2xhdGlvbklkID0gJ1RSQU5TTEFUSU9OX0lEJztcblxuICAgICAgICAkc2NvcGUudmFsdWVzID0ge1xuICAgICAgICAgIHZhbHVlOiA3OFxuICAgICAgICB9O1xuICAgICAgfSk7XG4gICAgPC9maWxlPlxuICAgIDxmaWxlIG5hbWU9XCJzY2VuYXJpby5qc1wiPlxuICAgICAgaXQoJ3Nob3VsZCB0cmFuc2xhdGUnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGluamVjdChmdW5jdGlvbiAoJHJvb3RTY29wZSwgJGNvbXBpbGUpIHtcbiAgICAgICAgICAkcm9vdFNjb3BlLnRyYW5zbGF0aW9uSWQgPSAnVFJBTlNMQVRJT05fSUQnO1xuXG4gICAgICAgICAgZWxlbWVudCA9ICRjb21waWxlKCc8aW5wdXQgdHJhbnNsYXRlLWF0dHI9XCJ7IHBsYWNlaG9sZGVyOiB0cmFuc2xhdGlvbklkLCB0aXRsZTogJ1dJVEhfVkFMVUVTJyB9XCIgdHJhbnNsYXRlLXZhbHVlcz1cInsgdmFsdWU6IDUgfVwiIC8+JykoJHJvb3RTY29wZSk7XG4gICAgICAgICAgJHJvb3RTY29wZS4kZGlnZXN0KCk7XG4gICAgICAgICAgZXhwZWN0KGVsZW1lbnQuYXR0cigncGxhY2Vob2xkZXIpKS50b0JlKCdIZWxsbyB0aGVyZSEnKTtcbiAgICAgICAgICBleHBlY3QoZWxlbWVudC5hdHRyKCd0aXRsZSkpLnRvQmUoJ1RoZSBmb2xsb3dpbmcgdmFsdWUgaXMgZHluYW1pYzogNScpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIDwvZmlsZT5cbiAgIDwvZXhhbXBsZT5cbiAqL1xuLmRpcmVjdGl2ZSgndHJhbnNsYXRlQXR0cicsIHRyYW5zbGF0ZUF0dHJEaXJlY3RpdmUpO1xuZnVuY3Rpb24gdHJhbnNsYXRlQXR0ckRpcmVjdGl2ZSgkdHJhbnNsYXRlLCAkcm9vdFNjb3BlKSB7XG5cbiAgJ3VzZSBzdHJpY3QnO1xuXG4gIHJldHVybiB7XG4gICAgcmVzdHJpY3Q6ICdBJyxcbiAgICBwcmlvcml0eTogJHRyYW5zbGF0ZS5kaXJlY3RpdmVQcmlvcml0eSgpLFxuICAgIGxpbms6IGZ1bmN0aW9uIGxpbmtGbihzY29wZSwgZWxlbWVudCwgYXR0cikge1xuXG4gICAgICB2YXIgdHJhbnNsYXRlQXR0cixcbiAgICAgICAgICB0cmFuc2xhdGVWYWx1ZXMsXG4gICAgICAgICAgcHJldmlvdXNBdHRyaWJ1dGVzID0ge307XG5cbiAgICAgIC8vIE1haW4gdXBkYXRlIHRyYW5zbGF0aW9ucyBmdW5jdGlvblxuICAgICAgdmFyIHVwZGF0ZVRyYW5zbGF0aW9ucyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgYW5ndWxhci5mb3JFYWNoKHRyYW5zbGF0ZUF0dHIsIGZ1bmN0aW9uICh0cmFuc2xhdGlvbklkLCBhdHRyaWJ1dGVOYW1lKSB7XG4gICAgICAgICAgaWYgKCF0cmFuc2xhdGlvbklkKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuICAgICAgICAgIHByZXZpb3VzQXR0cmlidXRlc1thdHRyaWJ1dGVOYW1lXSA9IHRydWU7XG5cbiAgICAgICAgICAvLyBpZiB0cmFuc2xhdGlvbiBpZCBzdGFydHMgd2l0aCAnLicgYW5kIHRyYW5zbGF0ZU5hbWVzcGFjZSBnaXZlbiwgcHJlcGVuZCBuYW1lc3BhY2VcbiAgICAgICAgICBpZiAoc2NvcGUudHJhbnNsYXRlTmFtZXNwYWNlICYmIHRyYW5zbGF0aW9uSWQuY2hhckF0KDApID09PSAnLicpIHtcbiAgICAgICAgICAgIHRyYW5zbGF0aW9uSWQgPSBzY29wZS50cmFuc2xhdGVOYW1lc3BhY2UgKyB0cmFuc2xhdGlvbklkO1xuICAgICAgICAgIH1cbiAgICAgICAgICAkdHJhbnNsYXRlKHRyYW5zbGF0aW9uSWQsIHRyYW5zbGF0ZVZhbHVlcywgYXR0ci50cmFuc2xhdGVJbnRlcnBvbGF0aW9uLCB1bmRlZmluZWQsIHNjb3BlLnRyYW5zbGF0ZUxhbmd1YWdlKVxuICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKHRyYW5zbGF0aW9uKSB7XG4gICAgICAgICAgICAgIGVsZW1lbnQuYXR0cihhdHRyaWJ1dGVOYW1lLCB0cmFuc2xhdGlvbik7XG4gICAgICAgICAgICB9LCBmdW5jdGlvbiAodHJhbnNsYXRpb25JZCkge1xuICAgICAgICAgICAgICBlbGVtZW50LmF0dHIoYXR0cmlidXRlTmFtZSwgdHJhbnNsYXRpb25JZCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gUmVtb3ZpbmcgdW51c2VkIGF0dHJpYnV0ZXMgdGhhdCB3ZXJlIHByZXZpb3VzbHkgdXNlZFxuICAgICAgICBhbmd1bGFyLmZvckVhY2gocHJldmlvdXNBdHRyaWJ1dGVzLCBmdW5jdGlvbiAoZmxhZywgYXR0cmlidXRlTmFtZSkge1xuICAgICAgICAgIGlmICghdHJhbnNsYXRlQXR0clthdHRyaWJ1dGVOYW1lXSkge1xuICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVBdHRyKGF0dHJpYnV0ZU5hbWUpO1xuICAgICAgICAgICAgZGVsZXRlIHByZXZpb3VzQXR0cmlidXRlc1thdHRyaWJ1dGVOYW1lXTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfTtcblxuICAgICAgLy8gV2F0Y2ggZm9yIGF0dHJpYnV0ZSBjaGFuZ2VzXG4gICAgICB3YXRjaEF0dHJpYnV0ZShcbiAgICAgICAgc2NvcGUsXG4gICAgICAgIGF0dHIudHJhbnNsYXRlQXR0cixcbiAgICAgICAgZnVuY3Rpb24gKG5ld1ZhbHVlKSB7IHRyYW5zbGF0ZUF0dHIgPSBuZXdWYWx1ZTsgfSxcbiAgICAgICAgdXBkYXRlVHJhbnNsYXRpb25zXG4gICAgICApO1xuICAgICAgLy8gV2F0Y2ggZm9yIHZhbHVlIGNoYW5nZXNcbiAgICAgIHdhdGNoQXR0cmlidXRlKFxuICAgICAgICBzY29wZSxcbiAgICAgICAgYXR0ci50cmFuc2xhdGVWYWx1ZXMsXG4gICAgICAgIGZ1bmN0aW9uIChuZXdWYWx1ZSkgeyB0cmFuc2xhdGVWYWx1ZXMgPSBuZXdWYWx1ZTsgfSxcbiAgICAgICAgdXBkYXRlVHJhbnNsYXRpb25zXG4gICAgICApO1xuXG4gICAgICBpZiAoYXR0ci50cmFuc2xhdGVWYWx1ZXMpIHtcbiAgICAgICAgc2NvcGUuJHdhdGNoKGF0dHIudHJhbnNsYXRlVmFsdWVzLCB1cGRhdGVUcmFuc2xhdGlvbnMsIHRydWUpO1xuICAgICAgfVxuXG4gICAgICAvLyBSZXBsYWNlZCB3YXRjaGVyIG9uIHRyYW5zbGF0ZUxhbmd1YWdlIHdpdGggZXZlbnQgbGlzdGVuZXJcbiAgICAgIHNjb3BlLiRvbigndHJhbnNsYXRlTGFuZ3VhZ2VDaGFuZ2VkJywgdXBkYXRlVHJhbnNsYXRpb25zKTtcblxuICAgICAgLy8gRW5zdXJlcyB0aGUgdGV4dCB3aWxsIGJlIHJlZnJlc2hlZCBhZnRlciB0aGUgY3VycmVudCBsYW5ndWFnZSB3YXMgY2hhbmdlZFxuICAgICAgLy8gdy8gJHRyYW5zbGF0ZS51c2UoLi4uKVxuICAgICAgdmFyIHVuYmluZCA9ICRyb290U2NvcGUuJG9uKCckdHJhbnNsYXRlQ2hhbmdlU3VjY2VzcycsIHVwZGF0ZVRyYW5zbGF0aW9ucyk7XG5cbiAgICAgIHVwZGF0ZVRyYW5zbGF0aW9ucygpO1xuICAgICAgc2NvcGUuJG9uKCckZGVzdHJveScsIHVuYmluZCk7XG4gICAgfVxuICB9O1xufVxuXG5mdW5jdGlvbiB3YXRjaEF0dHJpYnV0ZShzY29wZSwgYXR0cmlidXRlLCB2YWx1ZUNhbGxiYWNrLCBjaGFuZ2VDYWxsYmFjaykge1xuICAndXNlIHN0cmljdCc7XG4gIGlmICghYXR0cmlidXRlKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIGlmIChhdHRyaWJ1dGUuc3Vic3RyKDAsIDIpID09PSAnOjonKSB7XG4gICAgYXR0cmlidXRlID0gYXR0cmlidXRlLnN1YnN0cigyKTtcbiAgfSBlbHNlIHtcbiAgICBzY29wZS4kd2F0Y2goYXR0cmlidXRlLCBmdW5jdGlvbihuZXdWYWx1ZSkge1xuICAgICAgdmFsdWVDYWxsYmFjayhuZXdWYWx1ZSk7XG4gICAgICBjaGFuZ2VDYWxsYmFjaygpO1xuICAgIH0sIHRydWUpO1xuICB9XG4gIHZhbHVlQ2FsbGJhY2soc2NvcGUuJGV2YWwoYXR0cmlidXRlKSk7XG59XG5cbnRyYW5zbGF0ZUF0dHJEaXJlY3RpdmUuZGlzcGxheU5hbWUgPSAndHJhbnNsYXRlQXR0ckRpcmVjdGl2ZSc7XG5cbmFuZ3VsYXIubW9kdWxlKCdwYXNjYWxwcmVjaHQudHJhbnNsYXRlJylcbi8qKlxuICogQG5nZG9jIGRpcmVjdGl2ZVxuICogQG5hbWUgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS5kaXJlY3RpdmU6dHJhbnNsYXRlQ2xvYWtcbiAqIEByZXF1aXJlcyAkdHJhbnNsYXRlXG4gKiBAcmVzdHJpY3QgQVxuICpcbiAqICRkZXNjcmlwdGlvblxuICogQWRkcyBhIGB0cmFuc2xhdGUtY2xvYWtgIGNsYXNzIG5hbWUgdG8gdGhlIGdpdmVuIGVsZW1lbnQgd2hlcmUgdGhpcyBkaXJlY3RpdmVcbiAqIGlzIGFwcGxpZWQgaW5pdGlhbGx5IGFuZCByZW1vdmVzIGl0LCBvbmNlIGEgbG9hZGVyIGhhcyBmaW5pc2hlZCBsb2FkaW5nLlxuICpcbiAqIFRoaXMgZGlyZWN0aXZlIGNhbiBiZSB1c2VkIHRvIHByZXZlbnQgaW5pdGlhbCBmbGlja2VyaW5nIHdoZW4gbG9hZGluZyB0cmFuc2xhdGlvblxuICogZGF0YSBhc3luY2hyb25vdXNseS5cbiAqXG4gKiBUaGUgY2xhc3MgbmFtZSBpcyBkZWZpbmVkIGluXG4gKiB7QGxpbmsgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRlUHJvdmlkZXIjY2xvYWtDbGFzc05hbWUgJHRyYW5zbGF0ZS5jbG9ha0NsYXNzTmFtZSgpfS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZz19IHRyYW5zbGF0ZS1jbG9hayBJZiBhIHRyYW5zbGF0aW9uSWQgaXMgcHJvdmlkZWQsIGl0IHdpbGwgYmUgdXNlZCBmb3Igc2hvd2luZ1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3IgaGlkaW5nIHRoZSBjbG9hay4gQmFzaWNhbGx5IGl0IHJlbGllcyBvbiB0aGUgdHJhbnNsYXRpb25cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUuXG4gKi9cbi5kaXJlY3RpdmUoJ3RyYW5zbGF0ZUNsb2FrJywgdHJhbnNsYXRlQ2xvYWtEaXJlY3RpdmUpO1xuXG5mdW5jdGlvbiB0cmFuc2xhdGVDbG9ha0RpcmVjdGl2ZSgkdHJhbnNsYXRlLCAkcm9vdFNjb3BlKSB7XG5cbiAgJ3VzZSBzdHJpY3QnO1xuXG4gIHJldHVybiB7XG4gICAgY29tcGlsZSA6IGZ1bmN0aW9uICh0RWxlbWVudCkge1xuICAgICAgdmFyIGFwcGx5Q2xvYWsgPSBmdW5jdGlvbiAoZWxlbWVudCkge1xuICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJHRyYW5zbGF0ZS5jbG9ha0NsYXNzTmFtZSgpKTtcbiAgICAgICAgfSxcbiAgICAgICAgcmVtb3ZlQ2xvYWsgPSBmdW5jdGlvbiAoZWxlbWVudCkge1xuICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoJHRyYW5zbGF0ZS5jbG9ha0NsYXNzTmFtZSgpKTtcbiAgICAgICAgfTtcbiAgICAgIGFwcGx5Q2xvYWsodEVsZW1lbnQpO1xuXG4gICAgICByZXR1cm4gZnVuY3Rpb24gbGlua0ZuKHNjb3BlLCBpRWxlbWVudCwgaUF0dHIpIHtcbiAgICAgICAgLy9DcmVhdGUgYm91bmQgZnVuY3Rpb25zIHRoYXQgaW5jb3Jwb3JhdGUgdGhlIGFjdGl2ZSBET00gZWxlbWVudC5cbiAgICAgICAgdmFyIGlSZW1vdmVDbG9hayA9IHJlbW92ZUNsb2FrLmJpbmQodGhpcywgaUVsZW1lbnQpLCBpQXBwbHlDbG9hayA9IGFwcGx5Q2xvYWsuYmluZCh0aGlzLCBpRWxlbWVudCk7XG4gICAgICAgIGlmIChpQXR0ci50cmFuc2xhdGVDbG9hayAmJiBpQXR0ci50cmFuc2xhdGVDbG9hay5sZW5ndGgpIHtcbiAgICAgICAgICAvLyBSZWdpc3RlciBhIHdhdGNoZXIgZm9yIHRoZSBkZWZpbmVkIHRyYW5zbGF0aW9uIGFsbG93aW5nIGEgZmluZSB0dW5lZCBjbG9ha1xuICAgICAgICAgIGlBdHRyLiRvYnNlcnZlKCd0cmFuc2xhdGVDbG9haycsIGZ1bmN0aW9uICh0cmFuc2xhdGlvbklkKSB7XG4gICAgICAgICAgICAkdHJhbnNsYXRlKHRyYW5zbGF0aW9uSWQpLnRoZW4oaVJlbW92ZUNsb2FrLCBpQXBwbHlDbG9hayk7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgJHJvb3RTY29wZS4kb24oJyR0cmFuc2xhdGVDaGFuZ2VTdWNjZXNzJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgJHRyYW5zbGF0ZShpQXR0ci50cmFuc2xhdGVDbG9haykudGhlbihpUmVtb3ZlQ2xvYWssIGlBcHBseUNsb2FrKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAkdHJhbnNsYXRlLm9uUmVhZHkoaVJlbW92ZUNsb2FrKTtcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICB9XG4gIH07XG59XG5cbnRyYW5zbGF0ZUNsb2FrRGlyZWN0aXZlLmRpc3BsYXlOYW1lID0gJ3RyYW5zbGF0ZUNsb2FrRGlyZWN0aXZlJztcblxuYW5ndWxhci5tb2R1bGUoJ3Bhc2NhbHByZWNodC50cmFuc2xhdGUnKVxuLyoqXG4gKiBAbmdkb2MgZGlyZWN0aXZlXG4gKiBAbmFtZSBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLmRpcmVjdGl2ZTp0cmFuc2xhdGVOYW1lc3BhY2VcbiAqIEByZXN0cmljdCBBXG4gKlxuICogQGRlc2NyaXB0aW9uXG4gKiBUcmFuc2xhdGVzIGdpdmVuIHRyYW5zbGF0aW9uIGlkIGVpdGhlciB0aHJvdWdoIGF0dHJpYnV0ZSBvciBET00gY29udGVudC5cbiAqIEludGVybmFsbHkgaXQgdXNlcyBgdHJhbnNsYXRlYCBmaWx0ZXIgdG8gdHJhbnNsYXRlIHRyYW5zbGF0aW9uIGlkLiBJdCBwb3NzaWJsZSB0b1xuICogcGFzcyBhbiBvcHRpb25hbCBgdHJhbnNsYXRlLXZhbHVlc2Agb2JqZWN0IGxpdGVyYWwgYXMgc3RyaW5nIGludG8gdHJhbnNsYXRpb24gaWQuXG4gKlxuICogQHBhcmFtIHtzdHJpbmc9fSB0cmFuc2xhdGUgbmFtZXNwYWNlIG5hbWUgd2hpY2ggY291bGQgYmUgZWl0aGVyIHN0cmluZyBvciBpbnRlcnBvbGF0ZWQgc3RyaW5nLlxuICpcbiAqIEBleGFtcGxlXG4gICA8ZXhhbXBsZSBtb2R1bGU9XCJuZ1ZpZXdcIj5cbiAgICA8ZmlsZSBuYW1lPVwiaW5kZXguaHRtbFwiPlxuICAgICAgPGRpdiB0cmFuc2xhdGUtbmFtZXNwYWNlPVwiQ09OVEVOVFwiPlxuXG4gICAgICAgIDxkaXY+XG4gICAgICAgICAgICA8aDEgdHJhbnNsYXRlPi5IRUFERVJTLlRJVExFPC9oMT5cbiAgICAgICAgICAgIDxoMSB0cmFuc2xhdGU+LkhFQURFUlMuV0VMQ09NRTwvaDE+XG4gICAgICAgIDwvZGl2PlxuXG4gICAgICAgIDxkaXYgdHJhbnNsYXRlLW5hbWVzcGFjZT1cIi5IRUFERVJTXCI+XG4gICAgICAgICAgICA8aDEgdHJhbnNsYXRlPi5USVRMRTwvaDE+XG4gICAgICAgICAgICA8aDEgdHJhbnNsYXRlPi5XRUxDT01FPC9oMT5cbiAgICAgICAgPC9kaXY+XG5cbiAgICAgIDwvZGl2PlxuICAgIDwvZmlsZT5cbiAgICA8ZmlsZSBuYW1lPVwic2NyaXB0LmpzXCI+XG4gICAgICBhbmd1bGFyLm1vZHVsZSgnbmdWaWV3JywgWydwYXNjYWxwcmVjaHQudHJhbnNsYXRlJ10pXG5cbiAgICAgIC5jb25maWcoZnVuY3Rpb24gKCR0cmFuc2xhdGVQcm92aWRlcikge1xuXG4gICAgICAgICR0cmFuc2xhdGVQcm92aWRlci50cmFuc2xhdGlvbnMoJ2VuJyx7XG4gICAgICAgICAgJ1RSQU5TTEFUSU9OX0lEJzogJ0hlbGxvIHRoZXJlIScsXG4gICAgICAgICAgJ0NPTlRFTlQnOiB7XG4gICAgICAgICAgICAnSEVBREVSUyc6IHtcbiAgICAgICAgICAgICAgICBUSVRMRTogJ1RpdGxlJ1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0sXG4gICAgICAgICAgJ0NPTlRFTlQuSEVBREVSUy5XRUxDT01FJzogJ1dlbGNvbWUnXG4gICAgICAgIH0pLnByZWZlcnJlZExhbmd1YWdlKCdlbicpO1xuXG4gICAgICB9KTtcblxuICAgIDwvZmlsZT5cbiAgIDwvZXhhbXBsZT5cbiAqL1xuLmRpcmVjdGl2ZSgndHJhbnNsYXRlTmFtZXNwYWNlJywgdHJhbnNsYXRlTmFtZXNwYWNlRGlyZWN0aXZlKTtcblxuZnVuY3Rpb24gdHJhbnNsYXRlTmFtZXNwYWNlRGlyZWN0aXZlKCkge1xuXG4gICd1c2Ugc3RyaWN0JztcblxuICByZXR1cm4ge1xuICAgIHJlc3RyaWN0OiAnQScsXG4gICAgc2NvcGU6IHRydWUsXG4gICAgY29tcGlsZTogZnVuY3Rpb24gKCkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgcHJlOiBmdW5jdGlvbiAoc2NvcGUsIGlFbGVtZW50LCBpQXR0cnMpIHtcbiAgICAgICAgICBzY29wZS50cmFuc2xhdGVOYW1lc3BhY2UgPSBnZXRUcmFuc2xhdGVOYW1lc3BhY2Uoc2NvcGUpO1xuXG4gICAgICAgICAgaWYgKHNjb3BlLnRyYW5zbGF0ZU5hbWVzcGFjZSAmJiBpQXR0cnMudHJhbnNsYXRlTmFtZXNwYWNlLmNoYXJBdCgwKSA9PT0gJy4nKSB7XG4gICAgICAgICAgICBzY29wZS50cmFuc2xhdGVOYW1lc3BhY2UgKz0gaUF0dHJzLnRyYW5zbGF0ZU5hbWVzcGFjZTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc2NvcGUudHJhbnNsYXRlTmFtZXNwYWNlID0gaUF0dHJzLnRyYW5zbGF0ZU5hbWVzcGFjZTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgfVxuICB9O1xufVxuXG4vKipcbiAqIFJldHVybnMgdGhlIHNjb3BlJ3MgbmFtZXNwYWNlLlxuICogQHByaXZhdGVcbiAqIEBwYXJhbSBzY29wZVxuICogQHJldHVybnMge3N0cmluZ31cbiAqL1xuZnVuY3Rpb24gZ2V0VHJhbnNsYXRlTmFtZXNwYWNlKHNjb3BlKSB7XG4gICd1c2Ugc3RyaWN0JztcbiAgaWYgKHNjb3BlLnRyYW5zbGF0ZU5hbWVzcGFjZSkge1xuICAgIHJldHVybiBzY29wZS50cmFuc2xhdGVOYW1lc3BhY2U7XG4gIH1cbiAgaWYgKHNjb3BlLiRwYXJlbnQpIHtcbiAgICByZXR1cm4gZ2V0VHJhbnNsYXRlTmFtZXNwYWNlKHNjb3BlLiRwYXJlbnQpO1xuICB9XG59XG5cbnRyYW5zbGF0ZU5hbWVzcGFjZURpcmVjdGl2ZS5kaXNwbGF5TmFtZSA9ICd0cmFuc2xhdGVOYW1lc3BhY2VEaXJlY3RpdmUnO1xuXG5hbmd1bGFyLm1vZHVsZSgncGFzY2FscHJlY2h0LnRyYW5zbGF0ZScpXG4vKipcbiAqIEBuZ2RvYyBkaXJlY3RpdmVcbiAqIEBuYW1lIHBhc2NhbHByZWNodC50cmFuc2xhdGUuZGlyZWN0aXZlOnRyYW5zbGF0ZUxhbmd1YWdlXG4gKiBAcmVzdHJpY3QgQVxuICpcbiAqIEBkZXNjcmlwdGlvblxuICogRm9yY2VzIHRoZSBsYW5ndWFnZSB0byB0aGUgZGlyZWN0aXZlcyBpbiB0aGUgdW5kZXJseWluZyBzY29wZS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZz19IHRyYW5zbGF0ZSBsYW5ndWFnZSB0aGF0IHdpbGwgYmUgbmVnb3RpYXRlZC5cbiAqXG4gKiBAZXhhbXBsZVxuICAgPGV4YW1wbGUgbW9kdWxlPVwibmdWaWV3XCI+XG4gICAgPGZpbGUgbmFtZT1cImluZGV4Lmh0bWxcIj5cbiAgICAgIDxkaXY+XG5cbiAgICAgICAgPGRpdj5cbiAgICAgICAgICAgIDxoMSB0cmFuc2xhdGU+SEVMTE88L2gxPlxuICAgICAgICA8L2Rpdj5cblxuICAgICAgICA8ZGl2IHRyYW5zbGF0ZS1sYW5ndWFnZT1cImRlXCI+XG4gICAgICAgICAgICA8aDEgdHJhbnNsYXRlPkhFTExPPC9oMT5cbiAgICAgICAgPC9kaXY+XG5cbiAgICAgIDwvZGl2PlxuICAgIDwvZmlsZT5cbiAgICA8ZmlsZSBuYW1lPVwic2NyaXB0LmpzXCI+XG4gICAgICBhbmd1bGFyLm1vZHVsZSgnbmdWaWV3JywgWydwYXNjYWxwcmVjaHQudHJhbnNsYXRlJ10pXG5cbiAgICAgIC5jb25maWcoZnVuY3Rpb24gKCR0cmFuc2xhdGVQcm92aWRlcikge1xuXG4gICAgICAgICR0cmFuc2xhdGVQcm92aWRlclxuICAgICAgICAgIC50cmFuc2xhdGlvbnMoJ2VuJyx7XG4gICAgICAgICAgICAnSEVMTE8nOiAnSGVsbG8gd29ybGQhJ1xuICAgICAgICAgIH0pXG4gICAgICAgICAgLnRyYW5zbGF0aW9ucygnZGUnLHtcbiAgICAgICAgICAgICdIRUxMTyc6ICdIYWxsbyBXZWx0ISdcbiAgICAgICAgICB9KVxuICAgICAgICAgIC5wcmVmZXJyZWRMYW5ndWFnZSgnZW4nKTtcblxuICAgICAgfSk7XG5cbiAgICA8L2ZpbGU+XG4gICA8L2V4YW1wbGU+XG4gKi9cbi5kaXJlY3RpdmUoJ3RyYW5zbGF0ZUxhbmd1YWdlJywgdHJhbnNsYXRlTGFuZ3VhZ2VEaXJlY3RpdmUpO1xuXG5mdW5jdGlvbiB0cmFuc2xhdGVMYW5ndWFnZURpcmVjdGl2ZSgpIHtcblxuICAndXNlIHN0cmljdCc7XG5cbiAgcmV0dXJuIHtcbiAgICByZXN0cmljdDogJ0EnLFxuICAgIHNjb3BlOiB0cnVlLFxuICAgIGNvbXBpbGU6IGZ1bmN0aW9uICgpIHtcbiAgICAgIHJldHVybiBmdW5jdGlvbiBsaW5rRm4oc2NvcGUsIGlFbGVtZW50LCBpQXR0cnMpIHtcblxuICAgICAgICBpQXR0cnMuJG9ic2VydmUoJ3RyYW5zbGF0ZUxhbmd1YWdlJywgZnVuY3Rpb24gKG5ld1RyYW5zbGF0ZUxhbmd1YWdlKSB7XG4gICAgICAgICAgc2NvcGUudHJhbnNsYXRlTGFuZ3VhZ2UgPSBuZXdUcmFuc2xhdGVMYW5ndWFnZTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgc2NvcGUuJHdhdGNoKCd0cmFuc2xhdGVMYW5ndWFnZScsIGZ1bmN0aW9uKCl7XG4gICAgICAgICAgc2NvcGUuJGJyb2FkY2FzdCgndHJhbnNsYXRlTGFuZ3VhZ2VDaGFuZ2VkJyk7XG4gICAgICAgIH0pO1xuICAgICAgfTtcbiAgICB9XG4gIH07XG59XG5cbnRyYW5zbGF0ZUxhbmd1YWdlRGlyZWN0aXZlLmRpc3BsYXlOYW1lID0gJ3RyYW5zbGF0ZUxhbmd1YWdlRGlyZWN0aXZlJztcblxuYW5ndWxhci5tb2R1bGUoJ3Bhc2NhbHByZWNodC50cmFuc2xhdGUnKVxuLyoqXG4gKiBAbmdkb2MgZmlsdGVyXG4gKiBAbmFtZSBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLmZpbHRlcjp0cmFuc2xhdGVcbiAqIEByZXF1aXJlcyAkcGFyc2VcbiAqIEByZXF1aXJlcyBwYXNjYWxwcmVjaHQudHJhbnNsYXRlLiR0cmFuc2xhdGVcbiAqIEBmdW5jdGlvblxuICpcbiAqIEBkZXNjcmlwdGlvblxuICogVXNlcyBgJHRyYW5zbGF0ZWAgc2VydmljZSB0byB0cmFuc2xhdGUgY29udGVudHMuIEFjY2VwdHMgaW50ZXJwb2xhdGUgcGFyYW1ldGVyc1xuICogdG8gcGFzcyBkeW5hbWl6ZWQgdmFsdWVzIHRob3VnaCB0cmFuc2xhdGlvbi5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gdHJhbnNsYXRpb25JZCBBIHRyYW5zbGF0aW9uIGlkIHRvIGJlIHRyYW5zbGF0ZWQuXG4gKiBAcGFyYW0geyo9fSBpbnRlcnBvbGF0ZVBhcmFtcyBPcHRpb25hbCBvYmplY3QgbGl0ZXJhbCAoYXMgaGFzaCBvciBzdHJpbmcpIHRvIHBhc3MgdmFsdWVzIGludG8gdHJhbnNsYXRpb24uXG4gKlxuICogQHJldHVybnMge3N0cmluZ30gVHJhbnNsYXRlZCB0ZXh0LlxuICpcbiAqIEBleGFtcGxlXG4gICA8ZXhhbXBsZSBtb2R1bGU9XCJuZ1ZpZXdcIj5cbiAgICA8ZmlsZSBuYW1lPVwiaW5kZXguaHRtbFwiPlxuICAgICAgPGRpdiBuZy1jb250cm9sbGVyPVwiVHJhbnNsYXRlQ3RybFwiPlxuXG4gICAgICAgIDxwcmU+e3sgJ1RSQU5TTEFUSU9OX0lEJyB8IHRyYW5zbGF0ZSB9fTwvcHJlPlxuICAgICAgICA8cHJlPnt7IHRyYW5zbGF0aW9uSWQgfCB0cmFuc2xhdGUgfX08L3ByZT5cbiAgICAgICAgPHByZT57eyAnV0lUSF9WQUxVRVMnIHwgdHJhbnNsYXRlOid7dmFsdWU6IDV9JyB9fTwvcHJlPlxuICAgICAgICA8cHJlPnt7ICdXSVRIX1ZBTFVFUycgfCB0cmFuc2xhdGU6dmFsdWVzIH19PC9wcmU+XG5cbiAgICAgIDwvZGl2PlxuICAgIDwvZmlsZT5cbiAgICA8ZmlsZSBuYW1lPVwic2NyaXB0LmpzXCI+XG4gICAgICBhbmd1bGFyLm1vZHVsZSgnbmdWaWV3JywgWydwYXNjYWxwcmVjaHQudHJhbnNsYXRlJ10pXG5cbiAgICAgIC5jb25maWcoZnVuY3Rpb24gKCR0cmFuc2xhdGVQcm92aWRlcikge1xuXG4gICAgICAgICR0cmFuc2xhdGVQcm92aWRlci50cmFuc2xhdGlvbnMoJ2VuJywge1xuICAgICAgICAgICdUUkFOU0xBVElPTl9JRCc6ICdIZWxsbyB0aGVyZSEnLFxuICAgICAgICAgICdXSVRIX1ZBTFVFUyc6ICdUaGUgZm9sbG93aW5nIHZhbHVlIGlzIGR5bmFtaWM6IHt7dmFsdWV9fSdcbiAgICAgICAgfSk7XG4gICAgICAgICR0cmFuc2xhdGVQcm92aWRlci5wcmVmZXJyZWRMYW5ndWFnZSgnZW4nKTtcblxuICAgICAgfSk7XG5cbiAgICAgIGFuZ3VsYXIubW9kdWxlKCduZ1ZpZXcnKS5jb250cm9sbGVyKCdUcmFuc2xhdGVDdHJsJywgZnVuY3Rpb24gKCRzY29wZSkge1xuICAgICAgICAkc2NvcGUudHJhbnNsYXRpb25JZCA9ICdUUkFOU0xBVElPTl9JRCc7XG5cbiAgICAgICAgJHNjb3BlLnZhbHVlcyA9IHtcbiAgICAgICAgICB2YWx1ZTogNzhcbiAgICAgICAgfTtcbiAgICAgIH0pO1xuICAgIDwvZmlsZT5cbiAgIDwvZXhhbXBsZT5cbiAqL1xuLmZpbHRlcigndHJhbnNsYXRlJywgdHJhbnNsYXRlRmlsdGVyRmFjdG9yeSk7XG5cbmZ1bmN0aW9uIHRyYW5zbGF0ZUZpbHRlckZhY3RvcnkoJHBhcnNlLCAkdHJhbnNsYXRlKSB7XG5cbiAgJ3VzZSBzdHJpY3QnO1xuXG4gIHZhciB0cmFuc2xhdGVGaWx0ZXIgPSBmdW5jdGlvbiAodHJhbnNsYXRpb25JZCwgaW50ZXJwb2xhdGVQYXJhbXMsIGludGVycG9sYXRpb24sIGZvcmNlTGFuZ3VhZ2UpIHtcbiAgICBpZiAoIWFuZ3VsYXIuaXNPYmplY3QoaW50ZXJwb2xhdGVQYXJhbXMpKSB7XG4gICAgICB2YXIgY3R4ID0gdGhpcyB8fCB7XG4gICAgICAgICdfX1NDT1BFX0lTX05PVF9BVkFJTEFCTEUnOiAnTW9yZSBpbmZvIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL2FuZ3VsYXIuanMvY29tbWl0Lzg4NjNiOWQwNGM3MjJiMjc4ZmE5M2M1ZDY2YWQxZTU3OGFkNmViMWYnXG4gICAgICAgIH07XG4gICAgICBpbnRlcnBvbGF0ZVBhcmFtcyA9ICRwYXJzZShpbnRlcnBvbGF0ZVBhcmFtcykoY3R4KTtcbiAgICB9XG5cbiAgICByZXR1cm4gJHRyYW5zbGF0ZS5pbnN0YW50KHRyYW5zbGF0aW9uSWQsIGludGVycG9sYXRlUGFyYW1zLCBpbnRlcnBvbGF0aW9uLCBmb3JjZUxhbmd1YWdlKTtcbiAgfTtcblxuICBpZiAoJHRyYW5zbGF0ZS5zdGF0ZWZ1bEZpbHRlcigpKSB7XG4gICAgdHJhbnNsYXRlRmlsdGVyLiRzdGF0ZWZ1bCA9IHRydWU7XG4gIH1cblxuICByZXR1cm4gdHJhbnNsYXRlRmlsdGVyO1xufVxuXG50cmFuc2xhdGVGaWx0ZXJGYWN0b3J5LmRpc3BsYXlOYW1lID0gJ3RyYW5zbGF0ZUZpbHRlckZhY3RvcnknO1xuXG5hbmd1bGFyLm1vZHVsZSgncGFzY2FscHJlY2h0LnRyYW5zbGF0ZScpXG5cbi8qKlxuICogQG5nZG9jIG9iamVjdFxuICogQG5hbWUgcGFzY2FscHJlY2h0LnRyYW5zbGF0ZS4kdHJhbnNsYXRpb25DYWNoZVxuICogQHJlcXVpcmVzICRjYWNoZUZhY3RvcnlcbiAqXG4gKiBAZGVzY3JpcHRpb25cbiAqIFRoZSBmaXJzdCB0aW1lIGEgdHJhbnNsYXRpb24gdGFibGUgaXMgdXNlZCwgaXQgaXMgbG9hZGVkIGluIHRoZSB0cmFuc2xhdGlvbiBjYWNoZSBmb3IgcXVpY2sgcmV0cmlldmFsLiBZb3VcbiAqIGNhbiBsb2FkIHRyYW5zbGF0aW9uIHRhYmxlcyBkaXJlY3RseSBpbnRvIHRoZSBjYWNoZSBieSBjb25zdW1pbmcgdGhlXG4gKiBgJHRyYW5zbGF0aW9uQ2FjaGVgIHNlcnZpY2UgZGlyZWN0bHkuXG4gKlxuICogQHJldHVybiB7b2JqZWN0fSAkY2FjaGVGYWN0b3J5IG9iamVjdC5cbiAqL1xuICAuZmFjdG9yeSgnJHRyYW5zbGF0aW9uQ2FjaGUnLCAkdHJhbnNsYXRpb25DYWNoZSk7XG5cbmZ1bmN0aW9uICR0cmFuc2xhdGlvbkNhY2hlKCRjYWNoZUZhY3RvcnkpIHtcblxuICAndXNlIHN0cmljdCc7XG5cbiAgcmV0dXJuICRjYWNoZUZhY3RvcnkoJ3RyYW5zbGF0aW9ucycpO1xufVxuXG4kdHJhbnNsYXRpb25DYWNoZS5kaXNwbGF5TmFtZSA9ICckdHJhbnNsYXRpb25DYWNoZSc7XG5yZXR1cm4gJ3Bhc2NhbHByZWNodC50cmFuc2xhdGUnO1xuXG59KSk7XG5cblxuXG5cbi8qIVxuICogYW5ndWxhci10cmFuc2xhdGUgLSB2Mi4xNS4yIC0gMjAxNy0wNi0yMlxuICogXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTcgVGhlIGFuZ3VsYXItdHJhbnNsYXRlIHRlYW0sIFBhc2NhbCBQcmVjaHQ7IExpY2Vuc2VkIE1JVFxuICovXG4hZnVuY3Rpb24oYSxiKXtcImZ1bmN0aW9uXCI9PXR5cGVvZiBkZWZpbmUmJmRlZmluZS5hbWQ/ZGVmaW5lKFtdLGZ1bmN0aW9uKCl7cmV0dXJuIGIoKX0pOlwib2JqZWN0XCI9PXR5cGVvZiBtb2R1bGUmJm1vZHVsZS5leHBvcnRzP21vZHVsZS5leHBvcnRzPWIoKTpiKCl9KDAsZnVuY3Rpb24oKXtmdW5jdGlvbiBhKGEsYil7XCJ1c2Ugc3RyaWN0XCI7cmV0dXJuIGZ1bmN0aW9uKGMpe2lmKCEoYyYmKGFuZ3VsYXIuaXNBcnJheShjLmZpbGVzKXx8YW5ndWxhci5pc1N0cmluZyhjLnByZWZpeCkmJmFuZ3VsYXIuaXNTdHJpbmcoYy5zdWZmaXgpKSkpdGhyb3cgbmV3IEVycm9yKFwiQ291bGRuJ3QgbG9hZCBzdGF0aWMgZmlsZXMsIG5vIGZpbGVzIGFuZCBwcmVmaXggb3Igc3VmZml4IHNwZWNpZmllZCFcIik7Yy5maWxlc3x8KGMuZmlsZXM9W3twcmVmaXg6Yy5wcmVmaXgsc3VmZml4OmMuc3VmZml4fV0pO2Zvcih2YXIgZD1bXSxlPWMuZmlsZXMubGVuZ3RoLGY9MDtmPGU7ZisrKWQucHVzaChmdW5jdGlvbihkKXtpZighZHx8IWFuZ3VsYXIuaXNTdHJpbmcoZC5wcmVmaXgpfHwhYW5ndWxhci5pc1N0cmluZyhkLnN1ZmZpeCkpdGhyb3cgbmV3IEVycm9yKFwiQ291bGRuJ3QgbG9hZCBzdGF0aWMgZmlsZSwgbm8gcHJlZml4IG9yIHN1ZmZpeCBzcGVjaWZpZWQhXCIpO3ZhciBlPVtkLnByZWZpeCxjLmtleSxkLnN1ZmZpeF0uam9pbihcIlwiKTtyZXR1cm4gYW5ndWxhci5pc09iamVjdChjLmZpbGVNYXApJiZjLmZpbGVNYXBbZV0mJihlPWMuZmlsZU1hcFtlXSksYihhbmd1bGFyLmV4dGVuZCh7dXJsOmUsbWV0aG9kOlwiR0VUXCJ9LGMuJGh0dHApKS50aGVuKGZ1bmN0aW9uKGEpe3JldHVybiBhLmRhdGF9LGZ1bmN0aW9uKCl7cmV0dXJuIGEucmVqZWN0KGMua2V5KX0pfSh7cHJlZml4OmMuZmlsZXNbZl0ucHJlZml4LGtleTpjLmtleSxzdWZmaXg6Yy5maWxlc1tmXS5zdWZmaXh9KSk7cmV0dXJuIGEuYWxsKGQpLnRoZW4oZnVuY3Rpb24oYSl7Zm9yKHZhciBiPWEubGVuZ3RoLGM9e30sZD0wO2Q8YjtkKyspZm9yKHZhciBlIGluIGFbZF0pY1tlXT1hW2RdW2VdO3JldHVybiBjfSl9fXJldHVybiBhLiRpbmplY3Q9W1wiJHFcIixcIiRodHRwXCJdLGFuZ3VsYXIubW9kdWxlKFwicGFzY2FscHJlY2h0LnRyYW5zbGF0ZVwiKS5mYWN0b3J5KFwiJHRyYW5zbGF0ZVN0YXRpY0ZpbGVzTG9hZGVyXCIsYSksYS5kaXNwbGF5TmFtZT1cIiR0cmFuc2xhdGVTdGF0aWNGaWxlc0xvYWRlclwiLFwicGFzY2FscHJlY2h0LnRyYW5zbGF0ZVwifSk7XG5cblxuLyohXG4gKiBhbmd1bGFyLXRyYW5zbGF0ZSAtIHYyLjE1LjIgLSAyMDE3LTA2LTIyXG4gKiBcbiAqIENvcHlyaWdodCAoYykgMjAxNyBUaGUgYW5ndWxhci10cmFuc2xhdGUgdGVhbSwgUGFzY2FsIFByZWNodDsgTGljZW5zZWQgTUlUXG4gKi9cbiFmdW5jdGlvbihhLGIpe1wiZnVuY3Rpb25cIj09dHlwZW9mIGRlZmluZSYmZGVmaW5lLmFtZD9kZWZpbmUoW10sZnVuY3Rpb24oKXtyZXR1cm4gYigpfSk6XCJvYmplY3RcIj09dHlwZW9mIG1vZHVsZSYmbW9kdWxlLmV4cG9ydHM/bW9kdWxlLmV4cG9ydHM9YigpOmIoKX0oMCxmdW5jdGlvbigpe2Z1bmN0aW9uIGEoYSl7XCJ1c2Ugc3RyaWN0XCI7cmV0dXJuIGZ1bmN0aW9uKGIpe2Eud2FybihcIlRyYW5zbGF0aW9uIGZvciBcIitiK1wiIGRvZXNuJ3QgZXhpc3RcIil9fXJldHVybiBhLiRpbmplY3Q9W1wiJGxvZ1wiXSxhbmd1bGFyLm1vZHVsZShcInBhc2NhbHByZWNodC50cmFuc2xhdGVcIikuZmFjdG9yeShcIiR0cmFuc2xhdGVNaXNzaW5nVHJhbnNsYXRpb25IYW5kbGVyTG9nXCIsYSksYS5kaXNwbGF5TmFtZT1cIiR0cmFuc2xhdGVNaXNzaW5nVHJhbnNsYXRpb25IYW5kbGVyTG9nXCIsXCJwYXNjYWxwcmVjaHQudHJhbnNsYXRlXCJ9KTsiXSwiZmlsZSI6ImFuZ3VsYXItdHJhbnNsYXRlLmpzIn0=
